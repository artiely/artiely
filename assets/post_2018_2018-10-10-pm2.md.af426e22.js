import{o as n,c as e,a as t,x as c,t as o}from"./app.746f22cf.js";const a='{"title":"pm2进阶使用之一键发布","description":"","frontmatter":{"title":"pm2进阶使用之一键发布","tag":["pm2","nodejs"],"author":"Artiely","date":"2018-10-10","cover":"https://gitee.com/artiely/Figure-bed/raw/master/images/20200315160740.png","base64":301286},"headers":[{"level":2,"title":"启用集群模式","slug":"启用集群模式"},{"level":2,"title":"一键发布","slug":"一键发布"},{"level":2,"title":"注意事项","slug":"注意事项"},{"level":2,"title":"最后","slug":"最后"}],"relativePath":"post/2018/2018-10-10-pm2.md","lastUpdated":1629110800377}',i={},s=t("h1",{id:"pm2进阶使用之一键发布"},[t("a",{class:"header-anchor",href:"#pm2进阶使用之一键发布","aria-hidden":"true"},"#"),c(" pm2进阶使用之一键发布")],-1),d=t("h2",{id:"启用集群模式"},[t("a",{class:"header-anchor",href:"#启用集群模式","aria-hidden":"true"},"#"),c(" 启用集群模式")],-1),l=t("p",null,"只需要在启动应用时带上i参数",-1),r=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 start app.js -i max\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-25345"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 start app.js -i max\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-25345","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),p=t("p",null,"max：意味着PM2将自动检测可用的CPU数量和运行多个进程可以在负载均衡模式(但是不推荐使用)",-1),m=t("p",null,"或者使用json文件启动的",-1),y=t("div",{class:"language-"},[t("pre",null,[t("code",null,'{\n  "apps" : [{\n    "script"    : "api.js",\n    "instances" : "max",\n    "exec_mode" : "cluster"\n  }]\n}\n'),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-42568"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'{\n  "apps" : [{\n    "script"    : "api.js",\n    "instances" : "max",\n    "exec_mode" : "cluster"\n  }]\n}\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-42568","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br")])],-1),u=t("p",null,[c("当然还支持js和ylm文件,js示例如下"),t("br"),t("a",{href:"http://pm2.keymetrics.io/docs/usage/application-declaration/",target:"_blank",rel:"noopener noreferrer"},"相关资料")],-1),b=t("div",{class:"language-"},[t("pre",null,[t("code",null,'module.exports = {\n  apps : [{\n    name        : "worker",//应用名称\n    script      : "./worker.js", //脚本路径相对于pm2开始\n    watch       : true, //开启监察，文件改变自动重启\n    env: {\n      "PORT": 3000,\n      "NODE_ENV": "development",\n    },\n    env_production : {\n        "PORT": 80\n       "NODE_ENV": "production"\n    }\n  },{\n    name       : "api-app",\n    script     : "./api.js",\n    cwd         : "/home/www/project_root/current",// \n    "error_file": "./logs/app.err.log",\n    "out_file": "./logs/app.out.log", \n    "log_date_format" : "YYYY-MM-DD HH:mm Z"\n    instances  : 4, // 实例（多核）\n    exec_mode  : "cluster" // 集群模式\n  }]\n}\n'),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-77154"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'module.exports = {\n  apps : [{\n    name        : "worker",//应用名称\n    script      : "./worker.js", //脚本路径相对于pm2开始\n    watch       : true, //开启监察，文件改变自动重启\n    env: {\n      "PORT": 3000,\n      "NODE_ENV": "development",\n    },\n    env_production : {\n        "PORT": 80\n       "NODE_ENV": "production"\n    }\n  },{\n    name       : "api-app",\n    script     : "./api.js",\n    cwd         : "/home/www/project_root/current",// \n    "error_file": "./logs/app.err.log",\n    "out_file": "./logs/app.out.log", \n    "log_date_format" : "YYYY-MM-DD HH:mm Z"\n    instances  : 4, // 实例（多核）\n    exec_mode  : "cluster" // 集群模式\n  }]\n}\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-77154","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br")])],-1),h=t("p",null,"然后再启动进程",-1),f=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 start processes.json\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-73866"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 start processes.json\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-73866","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),C=t("p",null,"重载应用",-1),g=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 reload <app_name>\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-65674"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 reload <app_name>\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-65674","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),v=t("p",null,"或者",-1),k=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 reload process.json\npm2 reload process.json --only api\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-83389"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 reload process.json\npm2 reload process.json --only api\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-83389","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br")])],-1),w=t("h2",{id:"一键发布"},[t("a",{class:"header-anchor",href:"#一键发布","aria-hidden":"true"},"#"),c(" 一键发布")],-1),x=t("p",null,"yml的书写方式(process.yml)",-1),_=t("div",{class:"language-"},[t("pre",null,[t("code",null,"apps:\n  - script   : server.js\n    name : 'pm2 test'\n    watch  : true\n    env    :\n      NODE_ENV: development\n    env_production:\n      NODE_ENV: production\ndeploy :\n  production :\n    user : root\n    key : C:/Windows/SSH-ubuntu.pem  #服务器sshkey(阿里云再服务器镜像创建的时候会生成 然后保存到本地)\n    host : \n      - 120.78.174.212                #服务器ip\n    port : 22\n    ref : origin/master\n    repo : git@gitee.com:artiely/pm2test.git  #仓库地址\n    path : /www/pm2test/production               #发布地址\n    ssh_options : StrictHostKeyChecking=no       #ssh权限\n    pre-deploy : git fetch --all                 #发布前的操作\n    post-deploy : 'npm install && npm run build && pm2 startOrRestart process.yml --env production'\n    env : \n      NODE_ENV : production\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988093-46460"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"apps:\n  - script   : server.js\n    name : 'pm2 test'\n    watch  : true\n    env    :\n      NODE_ENV: development\n    env_production:\n      NODE_ENV: production\ndeploy :\n  production :\n    user : root\n    key : C:/Windows/SSH-ubuntu.pem  #服务器sshkey(阿里云再服务器镜像创建的时候会生成 然后保存到本地)\n    host : \n      - 120.78.174.212                #服务器ip\n    port : 22\n    ref : origin/master\n    repo : git@gitee.com:artiely/pm2test.git  #仓库地址\n    path : /www/pm2test/production               #发布地址\n    ssh_options : StrictHostKeyChecking=no       #ssh权限\n    pre-deploy : git fetch --all                 #发布前的操作\n    post-deploy : 'npm install && npm run build && pm2 startOrRestart process.yml --env production'\n    env : \n      NODE_ENV : production\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988093-46460","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br")])],-1),j=t("p",null,"第一次发布本地执行",-1),E=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 deploy process.yml production setup\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988094-22015"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 deploy process.yml production setup\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988094-22015","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),N=t("p",null,"然后每次发布只需本地执行如下命令，服务器就会自动拉取创库代码并发布",-1),T=t("div",{class:"language-"},[t("pre",null,[t("code",null,"pm2 deploy process.yml production\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629557988094-28432"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"pm2 deploy process.yml production\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629557988094-28432","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),$=o('<h2 id="注意事项"><a class="header-anchor" href="#注意事项" aria-hidden="true">#</a> 注意事项</h2><p>github上必须有服务器的公钥和本地的公钥</p><p><a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/" target="_blank" rel="noopener noreferrer">https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/</a></p><p>这里有各个系统生成id_rsa的方法</p><p>1.服务器node版本尽量使用最高稳定版<br> 2.devDependencies里的代码在发布时不会被下载安装，如有需要请移动到dependencies<br> 3.如果出现Host key verification failed.<br> 解决方案</p><ol><li><p>删除~/.ssh/known_hosts 文件中包含&quot;<a href="http://gitlab.xxx.com" target="_blank" rel="noopener noreferrer">gitlab.xxx.com</a>&quot;这一行的记录</p></li><li><p>删除~/.ssh/known_hosts整个文件</p></li><li><p>修改open ssh配置文件，安全级别调低（不推荐，仅限内网等安全级别较高的环境，公网不要使用）</p></li></ol><p>SSH对主机的public_key的检查等级是根据StrictHostKeyChecking变量来配置的。可以通过降低安全级别的方式，来减少这一类提示。</p><p>修改方法：<br> 编辑~/.ssh/config（代表个人配置，或/etc/ssh/ssh_config，代表全局配置）<br> 添加以下行<br> Shell代码 收藏代码<br> StrictHostKeyChecking no<br> UserKnownHostsFile /dev/null # 为了更简化，把known_hosts也省略掉了</p><p>下面附上StrictHostKeyChecking配置项的说明。<br> StrictHostKeyChecking=no<br> 最不安全的级别，当然也没有那么多烦人的提示了，相对安全的内网测试时建议使用。如果连接server的key在本地不存在，那么就自动添加到文件中（默认是known_hosts），并且给出一个警告。<br> StrictHostKeyChecking=ask<br> 默认的级别，就是出现刚才的提示了。如果连接和key不匹配，给出提示，并拒绝登录。<br> StrictHostKeyChecking=yes<br> 最安全的级别，如果连接与key不匹配，就拒绝连接，不会提示详细信息。</p><h2 id="最后"><a class="header-anchor" href="#最后" aria-hidden="true">#</a> 最后</h2><p>还可以配合<code>Keymetrics</code>发挥更大的用处</p>',11);i.render=function(t,c,o,a,i,D){return n(),e("div",null,[s,d,l,r,p,m,y,u,b,h,f,C,g,v,k,w,x,_,j,E,N,T,$])};export default i;export{a as __pageData};

import{o as n,c as s,f as a,a as t,x as e}from"./app.5f3fb606.js";const o='{"title":"WebSocket","description":"","frontmatter":{"title":"WebSocket","tag":["nodejs","webSocket"],"author":"Artiely","date":"2018-7-10","cover":"https://gitee.com/artiely/Figure-bed/raw/master/images/20200315165441.png","base64":"fceb3f"},"headers":[{"level":2,"title":"介绍","slug":"介绍"},{"level":2,"title":"Websocket基础","slug":"websocket基础"},{"level":3,"title":"基本概念","slug":"基本概念"},{"level":3,"title":"WebSocket服务端","slug":"websocket服务端"},{"level":3,"title":"WebSocket API","slug":"websocket-api"},{"level":2,"title":"Websocket基础应用","slug":"websocket基础应用"},{"level":3,"title":"基本的应用","slug":"基本的应用"},{"level":3,"title":"欢迎语","slug":"欢迎语"},{"level":3,"title":"退出时进行消息通知","slug":"退出时进行消息通知"},{"level":3,"title":"统计聊天人数","slug":"统计聊天人数"},{"level":3,"title":"多个聊天室","slug":"多个聊天室"},{"level":3,"title":"心跳检测","slug":"心跳检测"},{"level":3,"title":"ws中的鉴权","slug":"ws中的鉴权"},{"level":3,"title":"Websocket中的断线重连","slug":"websocket中的断线重连"},{"level":3,"title":"Websocket与Redis结合","slug":"websocket与redis结合"},{"level":3,"title":"离线消息缓存发送","slug":"离线消息缓存发送"},{"level":2,"title":"Websocket SSL配置","slug":"websocket-ssl配置"},{"level":3,"title":"配置HTTPS/WSS","slug":"配置httpswss"},{"level":2,"title":"其他资料","slug":"其他资料"},{"level":3,"title":"参考资料","slug":"参考资料"}],"relativePath":"post/2018/2018-7-10-websocket.md","lastUpdated":1629110798575}',c={},p=a('',35),l=t("div",{class:"language-"},[t("pre",null,[t("code",null,"npm install -S ws\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982264-36455"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"npm install -S ws\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982264-36455","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),i=t("p",null,[e("使用"),t("code",null,"Wesocket.Server"),e("方法，可以快速初始化服务端：")],-1),u=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" WebSocket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" wss "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("WebSocket"),t("span",{class:"token punctuation"},"."),e("Server")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e(" port"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"8080"),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\nwss"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'connection'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"connection"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"ws"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"incoming"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"message"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'received: %s'"),t("span",{class:"token punctuation"},","),e(" message"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'something'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982264-10529"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const WebSocket = require('ws');\n\nconst wss = new WebSocket.Server({ port: 8080 });\n\nwss.on('connection', function connection(ws) {\n  ws.on('message', function incoming(message) {\n    console.log('received: %s', message);\n  });\n\n  ws.send('something');\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982264-10529","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br")])],-1),r=t("p",null,"客户端的例子：",-1),k=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token comment"},"// 引用weboscket库"),e("\n"),t("span",{class:"token keyword"},"const"),e(" WebSocket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" ws "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws://127.0.0.1:8080'"),t("span",{class:"token punctuation"},")"),e("\n\nws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'open'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"for"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"var"),e(" i "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),e(" i "),t("span",{class:"token operator"},"<"),e(),t("span",{class:"token number"},"3"),t("span",{class:"token punctuation"},";"),e(" i"),t("span",{class:"token operator"},"++"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'Hello from client: '"),e(),t("span",{class:"token operator"},"+"),e(" i"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982264-1368"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"// 引用weboscket库\nconst WebSocket = require('ws');\n\nconst ws = new WebSocket('ws://127.0.0.1:8080')\n\nws.on('open', function () {\n  for (var i = 0; i < 3; i++) {\n    ws.send('Hello from client: ' + i)\n  }\n  ws.on('message', function (msg) {\n    console.log(msg)\n  })\n})\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982264-1368","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br")])],-1),m=t("p",null,"一个复杂一点的配置：",-1),d=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" WebSocket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" wss "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("WebSocket"),t("span",{class:"token punctuation"},"."),e("Server")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n  port"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"8080"),t("span",{class:"token punctuation"},","),e("\n  perMessageDeflate"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n    zlibDeflateOptions"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// See zlib defaults."),e("\n      chunkSize"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"1024"),t("span",{class:"token punctuation"},","),e("\n      memLevel"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"7"),t("span",{class:"token punctuation"},","),e("\n      level"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"3"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n    zlibInflateOptions"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n      chunkSize"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"10"),e(),t("span",{class:"token operator"},"*"),e(),t("span",{class:"token number"},"1024"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n    "),t("span",{class:"token comment"},"// Other options settable:"),e("\n    clientNoContextTakeover"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token comment"},"// Defaults to negotiated value."),e("\n    serverNoContextTakeover"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token comment"},"// Defaults to negotiated value."),e("\n    serverMaxWindowBits"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"10"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token comment"},"// Defaults to negotiated value."),e("\n    "),t("span",{class:"token comment"},"// Below options specified as default values."),e("\n    concurrencyLimit"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"10"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token comment"},"// Limits zlib concurrency for perf."),e("\n    threshold"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"1024"),e(),t("span",{class:"token comment"},"// Size (in bytes) below which messages"),e("\n    "),t("span",{class:"token comment"},"// should not be compressed."),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982264-54354"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const WebSocket = require('ws');\n\nconst wss = new WebSocket.Server({\n  port: 8080,\n  perMessageDeflate: {\n    zlibDeflateOptions: {\n      // See zlib defaults.\n      chunkSize: 1024,\n      memLevel: 7,\n      level: 3\n    },\n    zlibInflateOptions: {\n      chunkSize: 10 * 1024\n    },\n    // Other options settable:\n    clientNoContextTakeover: true, // Defaults to negotiated value.\n    serverNoContextTakeover: true, // Defaults to negotiated value.\n    serverMaxWindowBits: 10, // Defaults to negotiated value.\n    // Below options specified as default values.\n    concurrencyLimit: 10, // Limits zlib concurrency for perf.\n    threshold: 1024 // Size (in bytes) below which messages\n    // should not be compressed.\n  }\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982264-54354","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br")])],-1),b=a('',6),y=t("ul",null,[t("li",null,[t("p",null,"socket.io服务端 http / express两个库"),t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" app "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'express'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token keyword"},"const"),e(" http "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'http'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createServer"),t("span",{class:"token punctuation"},"("),e("app"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token keyword"},"const"),e(" io "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'socket.io'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"("),e("http"),t("span",{class:"token punctuation"},")"),e("\n\napp"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'/'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},[e("req"),t("span",{class:"token punctuation"},","),e(" res")]),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  res"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"sendFile"),t("span",{class:"token punctuation"},"("),e("__dirname "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},"'/index.html'"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"// 监听连接"),e("\nio"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'connection'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"socket"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'a socket is connected'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token comment"},"// 获取客户端的消息"),e("\n  socket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'chat msg'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'msg from client: '"),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token comment"},"// 发送消息给客户端"),e("\n    socket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'server says: '"),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\nhttp"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"listen"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"3000"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'server is running on: 3000'"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982264-44221"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const app = require('express')()\nconst http = require('http').createServer(app)\nconst io = require('socket.io')(http)\n\napp.get('/', function (req, res) {\n  res.sendFile(__dirname + '/index.html')\n})\n\n// 监听连接\nio.on('connection', function (socket) {\n  console.log('a socket is connected');\n  // 获取客户端的消息\n  socket.on('chat msg', function (msg) {\n    console.log('msg from client: ' + msg);\n    // 发送消息给客户端\n    socket.send('server says: ' + msg)\n  })\n})\n\nhttp.listen(3000, function () {\n  console.log('server is running on: 3000')\n})\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982264-44221","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br")])])]),t("li",null,[t("p",null,[e("客户端，需要引用"),t("code",null,"socket.io.js"),e("，有两种方式去引用：（1）支持从socket.io.client中的dist中加载这个js （2）CDN")]),t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token operator"},"<"),e("script src"),t("span",{class:"token operator"},"="),t("span",{class:"token string"},'"https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"'),t("span",{class:"token operator"},">"),t("span",{class:"token operator"},"<"),t("span",{class:"token operator"},"/"),e("script"),t("span",{class:"token operator"},">"),e("\n"),t("span",{class:"token operator"},"<"),e("script"),t("span",{class:"token operator"},">"),e("\n  "),t("span",{class:"token keyword"},"var"),e(" socket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"io"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token operator"},"<"),t("span",{class:"token operator"},"/"),e("script"),t("span",{class:"token operator"},">"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982267-29986"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"><\/script>\n<script>\n  var socket = io();\n<\/script>\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982267-29986","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br")])]),t("p",null,[e("客户端的仓库地址："),t("a",{href:"https://github.com/socketio/socket.io-client",target:"_blank",rel:"noopener noreferrer"},"https://github.com/socketio/socket.io-client")])])],-1),f=t("h3",{id:"websocket-api"},[t("a",{class:"header-anchor",href:"#websocket-api","aria-hidden":"true"},"#"),e(" WebSocket API")],-1),g=t("p",null,"浏览器通过 JavaScript 向服务器发出建立 WebSocket 连接的请求，连接建立以后，客户端和服务器端就可以通过 TCP 连接直接交换数据。",-1),w=t("p",null,[e("当你获取 Web Socket 连接后，你可以通过 "),t("strong",null,"send()"),e(" 方法来向服务器发送数据，并通过 "),t("strong",null,"onmessage"),e(" 事件来接收服务器返回的数据。")],-1),h=t("p",null,"以下 API 用于创建 WebSocket 对象。",-1),v=t("div",{class:"language-"},[t("pre",null,[t("code",null,"var Socket = new WebSocket(url, [protocol] );\n"),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982267-84287"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var Socket = new WebSocket(url, [protocol] );\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982267-84287","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])],-1),S=a('',19),C=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" WebSocket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws'"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" wss "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("WebSocket"),t("span",{class:"token punctuation"},"."),e("Server")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e(" port"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"8000"),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\nwss"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'connection'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"ws"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'a new client is connected!'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n    wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// 广播给非自己的其他客户端"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client "),t("span",{class:"token operator"},"!=="),e(" ws "),t("span",{class:"token operator"},"&&"),e(" client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982267-3690"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const WebSocket = require('ws')\n\nconst wss = new WebSocket.Server({ port: 8000 })\n\nwss.on('connection', function (ws) {\n  console.log('a new client is connected!');\n  ws.on('message', function (msg) {\n    // 广播到其他的客户端\n    wss.clients.forEach(function each(client) {\n      // 广播给非自己的其他客户端\n      if (client !== ws && client.readyState === WebSocket.OPEN) {\n        client.send(msg);\n      }\n    });\n  })\n})\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982267-3690","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br")])],-1),j=t("p",null,"在浏览器侧：",-1),O=t("div",{class:"language-html line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token doctype"},[t("span",{class:"token punctuation"},"<!"),t("span",{class:"token doctype-tag"},"DOCTYPE"),e(),t("span",{class:"token name"},"html"),t("span",{class:"token punctuation"},">")]),e("\n"),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("html")]),e(),t("span",{class:"token attr-name"},"lang"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("en"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),e("\n  "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("head")]),t("span",{class:"token punctuation"},">")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("meta")]),e(),t("span",{class:"token attr-name"},"charset"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("UTF-8"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token punctuation"},"/>")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("meta")]),e(),t("span",{class:"token attr-name"},"name"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("viewport"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token attr-name"},"content"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("width=device-width, initial-scale=1.0"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token punctuation"},"/>")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("meta")]),e(),t("span",{class:"token attr-name"},"http-equiv"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("X-UA-Compatible"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token attr-name"},"content"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("ie=edge"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token punctuation"},"/>")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("title")]),t("span",{class:"token punctuation"},">")]),e("Document"),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("title")]),t("span",{class:"token punctuation"},">")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("script")]),e(),t("span",{class:"token attr-name"},"src"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("https://cdn.jsdelivr.net/npm/vue/dist/vue.js"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),t("span",{class:"token script"}),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("script")]),t("span",{class:"token punctuation"},">")]),e("\n  "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("head")]),t("span",{class:"token punctuation"},">")]),e("\n  "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("body")]),t("span",{class:"token punctuation"},">")]),e("\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("div")]),e(),t("span",{class:"token attr-name"},"id"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("app"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),e("\n      "),t("span",{class:"token comment"},"\x3c!-- 显示消息 --\x3e"),e("\n      "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("ul")]),t("span",{class:"token punctuation"},">")]),e("\n        "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("li")]),e(),t("span",{class:"token attr-name"},"v-for"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("item in items"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),e("\n          {{ item.message }}\n        "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("li")]),t("span",{class:"token punctuation"},">")]),e("\n      "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("ul")]),t("span",{class:"token punctuation"},">")]),e("\n      "),t("span",{class:"token comment"},"\x3c!-- 发送消息 --\x3e"),e("\n      "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("div")]),e(),t("span",{class:"token attr-name"},"class"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("ctrl"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),e("\n        "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("input")]),e(),t("span",{class:"token attr-name"},"type"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("text"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token attr-name"},"v-model"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("inputValue"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token punctuation"},"/>")]),e("\n        "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("button")]),e(),t("span",{class:"token attr-name"},"type"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("button"),t("span",{class:"token punctuation"},'"')]),e(),t("span",{class:"token attr-name"},"@click"),t("span",{class:"token attr-value"},[t("span",{class:"token punctuation attr-equals"},"="),t("span",{class:"token punctuation"},'"'),e("submit()"),t("span",{class:"token punctuation"},'"')]),t("span",{class:"token punctuation"},">")]),e("发送"),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("button")]),t("span",{class:"token punctuation"},">")]),e("\n      "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("div")]),t("span",{class:"token punctuation"},">")]),e("\n      {{ inputValue }}\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("div")]),t("span",{class:"token punctuation"},">")]),e("\n\n    "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"<"),e("script")]),t("span",{class:"token punctuation"},">")]),t("span",{class:"token script"},[t("span",{class:"token language-javascript"},[e("\n      "),t("span",{class:"token comment"},"// 客户端的代码"),e("\n      "),t("span",{class:"token comment"},"// 1. 发送消息"),e("\n      "),t("span",{class:"token comment"},"// 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端"),e("\n      "),t("span",{class:"token comment"},"// 2. 显示消息"),e("\n      "),t("span",{class:"token keyword"},"var"),e(" app "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Vue"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n        el"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"#app"'),t("span",{class:"token punctuation"},","),e("\n        data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          inputValue"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          items"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"["),e("\n            "),t("span",{class:"token punctuation"},"{"),e(" message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"Foo"'),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"{"),e(" message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"Bar"'),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"{"),e(" message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"demo"'),e(),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e("\n          wsHandle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token comment"},"// 把元素挂载完成之后，自动执行"),e("\n        "),t("span",{class:"token function"},"mounted"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token keyword"},"var"),e(" _this "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"ws://localhost:8000"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onopen "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onOpen"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token comment"},"// 服务端发送回来的其他消息"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onmessage "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onMessage"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        methods"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token function-variable function"},"submit"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token comment"},"// 取inputValue"),e("\n            "),t("span",{class:"token comment"},"// 通过websocket发送数据"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n              message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onOpen"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"client is connected"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onMessage"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"evt"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token comment"},"// 把数据推送到items中"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n              message"),t("span",{class:"token operator"},":"),e(" evt"),t("span",{class:"token punctuation"},"."),e("data"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    ")])]),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("script")]),t("span",{class:"token punctuation"},">")]),e("\n  "),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("body")]),t("span",{class:"token punctuation"},">")]),e("\n"),t("span",{class:"token tag"},[t("span",{class:"token tag"},[t("span",{class:"token punctuation"},"</"),e("html")]),t("span",{class:"token punctuation"},">")]),e("\n\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982267-75103"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <meta http-equiv="X-UA-Compatible" content="ie=edge" />\n    <title>Document</title>\n    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"><\/script>\n  </head>\n  <body>\n    <div id="app">\n      \x3c!-- 显示消息 --\x3e\n      <ul>\n        <li v-for="item in items">\n          {{ item.message }}\n        </li>\n      </ul>\n      \x3c!-- 发送消息 --\x3e\n      <div class="ctrl">\n        <input type="text" v-model="inputValue" />\n        <button type="button" @click="submit()">发送</button>\n      </div>\n      {{ inputValue }}\n    </div>\n\n    <script>\n      // 客户端的代码\n      // 1. 发送消息\n      // 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端\n      // 2. 显示消息\n      var app = new Vue({\n        el: "#app",\n        data: {\n          inputValue: "",\n          items: [\n            { message: "Foo" },\n            { message: "Bar" },\n            { message: "demo" },\n          ],\n          wsHandle: "",\n          name: "",\n        },\n        // 把元素挂载完成之后，自动执行\n        mounted() {\n          var _this = this;\n          this.wsHandle = new WebSocket("ws://localhost:8000");\n          this.wsHandle.onopen = this.onOpen;\n          // 服务端发送回来的其他消息\n          this.wsHandle.onmessage = this.onMessage;\n        },\n        methods: {\n          submit: function() {\n            // 取inputValue\n            // 通过websocket发送数据\n            console.log(this.inputValue);\n            this.wsHandle.send(this.inputValue);\n            this.items.push({\n              message: this.inputValue,\n            });\n            this.inputValue = "";\n          },\n          onOpen: function() {\n            console.log("client is connected");\n          },\n          onMessage: function(evt) {\n            // 把数据推送到items中\n            this.items.push({\n              message: evt.data,\n            });\n          },\n        },\n      });\n    <\/script>\n  </body>\n</html>\n\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982267-75103","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br")])],-1),x=t("h3",{id:"欢迎语"},[t("a",{class:"header-anchor",href:"#欢迎语","aria-hidden":"true"},"#"),e(" 欢迎语")],-1),N=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[e("     "),t("span",{class:"token comment"},"// 客户端的代码"),e("\n      "),t("span",{class:"token comment"},"// 1. 发送消息"),e("\n      "),t("span",{class:"token comment"},"// 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端"),e("\n      "),t("span",{class:"token comment"},"// 2. 显示消息"),e("\n      "),t("span",{class:"token keyword"},"var"),e(" app "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Vue"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n        el"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"#app"'),t("span",{class:"token punctuation"},","),e("\n        data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          isShow"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e("\n          inputValue"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          items"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e("\n          wsHandle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          num"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token comment"},"// 把元素挂载完成之后，自动执行"),e("\n        "),t("span",{class:"token function"},"mounted"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token keyword"},"var"),e(" _this "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"ws://localhost:8000"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onopen "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onOpen"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token comment"},"// 服务端发送回来的其他消息"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onmessage "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onMessage"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        methods"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token function-variable function"},"submit"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token comment"},"// 取inputValue"),e("\n            "),t("span",{class:"token comment"},"// 通过websocket发送数据"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n              "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n                message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n              message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'": "'),e(),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"into"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"trim"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token function"},"alert"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"用户名不得为空"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n              "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n              "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("isShow "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"false"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onOpen"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"client is connected"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onMessage"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"evt"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token keyword"},"var"),e(" msg "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("evt"),t("span",{class:"token punctuation"},"."),e("data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("num"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("num "),t("span",{class:"token operator"},"="),e(" msg"),t("span",{class:"token punctuation"},"."),e("num"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"&&"),e(),t("span",{class:"token operator"},"!"),e("msg"),t("span",{class:"token punctuation"},"."),e("message"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"欢迎"'),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"加入聊天室！"'),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n                "),t("span",{class:"token comment"},"// 把数据推送到items中"),e("\n                "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                  message"),t("span",{class:"token operator"},":"),e(" msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'": "'),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},"."),e("message"),t("span",{class:"token punctuation"},","),e("\n                "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982268-14576"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'     // 客户端的代码\n      // 1. 发送消息\n      // 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端\n      // 2. 显示消息\n      var app = new Vue({\n        el: "#app",\n        data: {\n          isShow: true,\n          inputValue: "",\n          items: [],\n          wsHandle: "",\n          name: "",\n          num: 0,\n        },\n        // 把元素挂载完成之后，自动执行\n        mounted() {\n          var _this = this;\n          this.wsHandle = new WebSocket("ws://localhost:8000");\n          this.wsHandle.onopen = this.onOpen;\n          // 服务端发送回来的其他消息\n          this.wsHandle.onmessage = this.onMessage;\n        },\n        methods: {\n          submit: function() {\n            // 取inputValue\n            // 通过websocket发送数据\n            console.log(this.inputValue);\n            this.wsHandle.send(\n              JSON.stringify({\n                name: this.name,\n                message: this.inputValue,\n              })\n            );\n            this.items.push({\n              message: this.name + ": " + this.inputValue,\n            });\n            this.inputValue = "";\n          },\n          into: function() {\n            if (this.name.trim() === "") {\n              alert("用户名不得为空");\n              return;\n            }\n            this.wsHandle.send(\n              JSON.stringify({\n                name: this.name,\n              })\n            );\n            this.isShow = false;\n          },\n          onOpen: function() {\n            console.log("client is connected");\n          },\n          onMessage: function(evt) {\n            var msg = JSON.parse(evt.data);\n            if (msg.num) {\n              this.num = msg.num;\n            }\n            if (msg.name && !msg.message) {\n              this.items.push({\n                message: "欢迎" + msg.name + "加入聊天室！",\n              });\n            } else {\n                // 把数据推送到items中\n                this.items.push({\n                  message: msg.name + ": " + msg.message,\n                });\n            }\n          },\n        },\n      });\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982268-14576","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br")])],-1),T=t("h3",{id:"退出时进行消息通知"},[t("a",{class:"header-anchor",href:"#退出时进行消息通知","aria-hidden":"true"},"#"),e(" 退出时进行消息通知")],-1),W=t("ul",null,[t("li",null,"服务端广播消息"),t("li",null,"客户端针对不同的业务进行代码提示")],-1),E=t("p",null,"服务端：",-1),A=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[e("  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'close'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'one client is closed :'"),e(),t("span",{class:"token operator"},"+"),e(" ws"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),e(" ws"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token string"},"'undefined'"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n      wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token comment"},"// 广播给非自己的其他客户端"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client "),t("span",{class:"token operator"},"!=="),e(" ws "),t("span",{class:"token operator"},"&&"),e(" client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n            name"),t("span",{class:"token operator"},":"),e(" ws"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n            event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'logout'"),t("span",{class:"token punctuation"},","),e("\n            num"),t("span",{class:"token operator"},":"),e(" wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),e("size\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982268-96235"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"  ws.on('close', function () {\n    console.log('one client is closed :' + ws);\n    if (typeof ws.name !== 'undefined') {\n      // 广播到其他的客户端\n      wss.clients.forEach(function each(client) {\n        // 广播给非自己的其他客户端\n        if (client !== ws && client.readyState === WebSocket.OPEN) {\n          client.send(JSON.stringify({\n            name: ws.name,\n            event: 'logout',\n            num: wss.clients.size\n          }));\n        }\n      });\n    }\n  })\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982268-96235","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br")])],-1),V=t("p",null,"客户端：",-1),_=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[e("     "),t("span",{class:"token comment"},"// 客户端的代码"),e("\n      "),t("span",{class:"token comment"},"// 1. 发送消息"),e("\n      "),t("span",{class:"token comment"},"// 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端"),e("\n      "),t("span",{class:"token comment"},"// 2. 显示消息"),e("\n      "),t("span",{class:"token keyword"},"var"),e(" app "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"Vue"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n        el"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"#app"'),t("span",{class:"token punctuation"},","),e("\n        data"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          isShow"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token boolean"},"true"),t("span",{class:"token punctuation"},","),e("\n          inputValue"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          items"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},","),e("\n          wsHandle"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},","),e("\n          num"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token comment"},"// 把元素挂载完成之后，自动执行"),e("\n        "),t("span",{class:"token function"},"mounted"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token keyword"},"var"),e(" _this "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"WebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"ws://localhost:8000"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onopen "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onOpen"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token comment"},"// 服务端发送回来的其他消息"),e("\n          "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),e("onmessage "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("onMessage"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        methods"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token function-variable function"},"submit"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token comment"},"// 取inputValue"),e("\n            "),t("span",{class:"token comment"},"// 通过websocket发送数据"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n              "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n                message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},","),e("\n                event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"message"'),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n              message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'": "'),e(),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("inputValue "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"into"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"trim"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token function"},"alert"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"用户名不得为空"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n              "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n              "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n                event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"login"'),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("isShow "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"false"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onOpen"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"client is connected"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token function-variable function"},"onMessage"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"evt"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token keyword"},"var"),e(" msg "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("evt"),t("span",{class:"token punctuation"},"."),e("data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("num"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("num "),t("span",{class:"token operator"},"="),e(" msg"),t("span",{class:"token punctuation"},"."),e("num"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"login"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"欢迎"'),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"加入聊天室！"'),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"logout"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                message"),t("span",{class:"token operator"},":"),e(" msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"已经退出了聊天室！"'),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n            "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n                "),t("span",{class:"token comment"},"// 把数据推送到items中"),e("\n                "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("items"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n                  message"),t("span",{class:"token operator"},":"),e(" msg"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'": "'),e(),t("span",{class:"token operator"},"+"),e(" msg"),t("span",{class:"token punctuation"},"."),e("message"),t("span",{class:"token punctuation"},","),e("\n                "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n              "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n        "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982268-10991"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'     // 客户端的代码\n      // 1. 发送消息\n      // 客户端 取input数据 -> websocket -> 发送到服务端 -> 转发给其他所有的客户端\n      // 2. 显示消息\n      var app = new Vue({\n        el: "#app",\n        data: {\n          isShow: true,\n          inputValue: "",\n          items: [],\n          wsHandle: "",\n          name: "",\n          num: 0,\n        },\n        // 把元素挂载完成之后，自动执行\n        mounted() {\n          var _this = this;\n          this.wsHandle = new WebSocket("ws://localhost:8000");\n          this.wsHandle.onopen = this.onOpen;\n          // 服务端发送回来的其他消息\n          this.wsHandle.onmessage = this.onMessage;\n        },\n        methods: {\n          submit: function() {\n            // 取inputValue\n            // 通过websocket发送数据\n            console.log(this.inputValue);\n            this.wsHandle.send(\n              JSON.stringify({\n                name: this.name,\n                message: this.inputValue,\n                event: "message",\n              })\n            );\n            this.items.push({\n              message: this.name + ": " + this.inputValue,\n            });\n            this.inputValue = "";\n          },\n          into: function() {\n            if (this.name.trim() === "") {\n              alert("用户名不得为空");\n              return;\n            }\n            this.wsHandle.send(\n              JSON.stringify({\n                name: this.name,\n                event: "login",\n              })\n            );\n            this.isShow = false;\n          },\n          onOpen: function() {\n            console.log("client is connected");\n          },\n          onMessage: function(evt) {\n            var msg = JSON.parse(evt.data);\n            if (msg.num) {\n              this.num = msg.num;\n            }\n            if (msg.event === "login") {\n              this.items.push({\n                message: "欢迎" + msg.name + "加入聊天室！",\n              });\n            } else if (msg.event === "logout") {\n              this.items.push({\n                message: msg.name + "已经退出了聊天室！",\n              });\n            } else {\n              if (msg.name !== this.name) {\n                // 把数据推送到items中\n                this.items.push({\n                  message: msg.name + ": " + msg.message,\n                });\n              }\n            }\n          },\n        },\n      });\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982268-10991","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br"),t("span",{class:"line-number"},"78"),t("br"),t("span",{class:"line-number"},"79"),t("br")])],-1),P=t("h3",{id:"统计聊天人数"},[t("a",{class:"header-anchor",href:"#统计聊天人数","aria-hidden":"true"},"#"),e(" 统计聊天人数")],-1),$=t("p",null,"服务端：",-1),I=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[e("  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"var"),e(" msgObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("name\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n    wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      msgObj"),t("span",{class:"token punctuation"},"."),e("num "),t("span",{class:"token operator"},"="),e(" wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),e("size\n      "),t("span",{class:"token comment"},"// 广播给非自己的其他客户端"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982269-46799"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"  ws.on('message', function (msg) {\n    var msgObj = JSON.parse(msg)\n    if (msgObj.name) {\n      ws.name = msgObj.name\n    }\n    // 广播到其他的客户端\n    wss.clients.forEach(function each(client) {\n      msgObj.num = wss.clients.size\n      // 广播给非自己的其他客户端\n      if (client.readyState === WebSocket.OPEN) {\n        client.send(JSON.stringify(msgObj));\n      }\n    });\n  })\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982269-46799","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br")])],-1),J=a('',4),H=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"var"),e(" group "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"{"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"// ..."),e("\n"),t("span",{class:"token comment"},"// console.log('a new client is connected!');"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"var"),e(" msgObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("name\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},"'undefined'"),e(),t("span",{class:"token operator"},"&&"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),e(" group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),e(),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},"'undefined'"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token number"},"1"),e("\n      "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n        group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},"++"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n    wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      msgObj"),t("span",{class:"token punctuation"},"."),e("num "),t("span",{class:"token operator"},"="),e(" group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),e(),t("span",{class:"token operator"},"&&"),e(" client"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n\n      "),t("span",{class:"token comment"},"// msgObj.num = wss.clients.size"),e("\n      "),t("span",{class:"token comment"},"// // 广播给非自己的其他客户端"),e("\n      "),t("span",{class:"token comment"},"// if (client.readyState === WebSocket.OPEN) {"),e("\n      "),t("span",{class:"token comment"},"//   client.send(JSON.stringify(msgObj));"),e("\n      "),t("span",{class:"token comment"},"// }"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"// ..."),e("\n\n  "),t("span",{class:"token comment"},"// 客户端断开链接"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'close'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token comment"},"// console.log('one client is closed :' + ws);"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),e(" ws"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token string"},"'undefined'"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// 退出的用户，修改对应的在线客户端数据"),e("\n      group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},"--"),e("\n      "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n      wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token comment"},"// 广播给非自己的其他客户端"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client "),t("span",{class:"token operator"},"!=="),e(" ws "),t("span",{class:"token operator"},"&&"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(" client"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"&&"),e(" client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n            name"),t("span",{class:"token operator"},":"),e(" ws"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n            event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'logout'"),t("span",{class:"token punctuation"},","),e("\n            num"),t("span",{class:"token operator"},":"),e(" group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982269-50261"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var group = {}\n\n// ...\n// console.log('a new client is connected!');\n  ws.on('message', function (msg) {\n    var msgObj = JSON.parse(msg)\n    if (msgObj.name) {\n      ws.name = msgObj.name\n    }\n    if (typeof ws.roomid === 'undefined' && msgObj.roomid) {\n      ws.roomid = msgObj.roomid\n      if (typeof group[ws.roomid] === 'undefined') {\n        group[ws.roomid] = 1\n      } else {\n        group[ws.roomid]++\n      }\n    }\n    // 广播到其他的客户端\n    wss.clients.forEach(function each(client) {\n      msgObj.num = group[ws.roomid]\n      if (client.readyState === WebSocket.OPEN && client.roomid === ws.roomid) {\n        client.send(JSON.stringify(msgObj));\n      }\n\n      // msgObj.num = wss.clients.size\n      // // 广播给非自己的其他客户端\n      // if (client.readyState === WebSocket.OPEN) {\n      //   client.send(JSON.stringify(msgObj));\n      // }\n    });\n  })\n\n// ...\n\n  // 客户端断开链接\n  ws.on('close', function () {\n    // console.log('one client is closed :' + ws);\n    if (typeof ws.name !== 'undefined') {\n      // 退出的用户，修改对应的在线客户端数据\n      group[ws.roomid]--\n      // 广播到其他的客户端\n      wss.clients.forEach(function each(client) {\n        // 广播给非自己的其他客户端\n        if (client !== ws && ws.roomid === client.roomid && client.readyState === WebSocket.OPEN) {\n          client.send(JSON.stringify({\n            name: ws.name,\n            event: 'logout',\n            num: group[ws.roomid]\n          }));\n        }\n      });\n    }\n  })\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982269-50261","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br")])],-1),q=t("h3",{id:"心跳检测"},[t("a",{class:"header-anchor",href:"#心跳检测","aria-hidden":"true"},"#"),e(" 心跳检测")],-1),D=t("ul",null,[t("li",null,"服务端：检测客户端的连接 -> 定时器 -> 超过指定时间 -> 主动断开客户端的连接"),t("li",null,"客户端：设置定时器 -> 如果超时或者服务端没有响应 ping/pong -> 断开与服务端的连接")],-1),F=t("p",null,"服务端代码：",-1),B=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token comment"},"// 消息处理  "),e("\nws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token comment"},"// ..."),e("\n  "),t("span",{class:"token keyword"},"var"),e(" msgObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},"'heartbeat'"),e(),t("span",{class:"token operator"},"&&"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("message "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},"'pong'"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    ws"),t("span",{class:"token punctuation"},"."),e("isAlive "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"true"),e("\n    "),t("span",{class:"token keyword"},"return"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token comment"},"// ..."),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"// 计时器"),e("\n"),t("span",{class:"token keyword"},"const"),e(" interval "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"setInterval"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token comment"},"// 遍历所有的客户端，发送一个ping/pong消息"),e("\n  "),t("span",{class:"token comment"},"// 检测是否有返回，如果没有返回或者超时之后，主动断开与客户端的连接"),e("\n  wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"ws"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("ws"),t("span",{class:"token punctuation"},"."),e("isAlive "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token boolean"},"false"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'client is disconneted!'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      group"),t("span",{class:"token punctuation"},"["),e("ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token operator"},"--"),e("\n      "),t("span",{class:"token keyword"},"return"),e(" ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"terminate"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n\n    ws"),t("span",{class:"token punctuation"},"."),e("isAlive "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"false"),e("\n    "),t("span",{class:"token comment"},"// 主动发送ping/pong消息"),e("\n    "),t("span",{class:"token comment"},"// 客户端返回了之后，主动设置isAlive的状态"),e("\n    ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n      event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'heartbeat'"),t("span",{class:"token punctuation"},","),e("\n      message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'ping'"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e(" timeInterval"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982270-2706"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"// 消息处理  \nws.on('message', function (msg) {\n    // ...\n  var msgObj = JSON.parse(msg)\n  if (msgObj.event === 'heartbeat' && msgObj.message === 'pong') {\n    ws.isAlive = true\n    return\n  }\n  // ...\n})\n\n// 计时器\nconst interval = setInterval(function () {\n  // 遍历所有的客户端，发送一个ping/pong消息\n  // 检测是否有返回，如果没有返回或者超时之后，主动断开与客户端的连接\n  wss.clients.forEach(function each(ws) {\n    if (ws.isAlive === false) {\n      console.log('client is disconneted!');\n      group[ws.roomid]--\n      return ws.terminate()\n    }\n\n    ws.isAlive = false\n    // 主动发送ping/pong消息\n    // 客户端返回了之后，主动设置isAlive的状态\n    ws.send(JSON.stringify({\n      event: 'heartbeat',\n      message: 'ping'\n    }))\n  })\n}, timeInterval)\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982270-2706","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br")])],-1),z=t("p",null,"客户端的代码：",-1),M=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token function-variable function"},"onOpen"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token comment"},"// 连接创建之时"),e("\n  "),t("span",{class:"token comment"},"// 设置定时器 -> 如果超时或者服务端没有响应 ping/pong -> 断开与服务端的连接"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"client is connected"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"checkServer"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n\n"),t("span",{class:"token function-variable function"},"onMessage"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token comment"},"// 心跳检测"),e("\n  "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"heartbeat"'),e(),t("span",{class:"token operator"},"&&"),e(" msg"),t("span",{class:"token punctuation"},"."),e("message "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"ping"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"checkServer"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n      "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n        event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"heartbeat"'),t("span",{class:"token punctuation"},","),e("\n        message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"pong"'),t("span",{class:"token punctuation"},","),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token keyword"},"return"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token comment"},"//..."),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"// 定时器方法"),e("\n"),t("span",{class:"token function-variable function"},"checkServer"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"checkServer in"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token comment"},"// 计时器去定时检测websocket的连接"),e("\n  "),t("span",{class:"token keyword"},"var"),e(" _this "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token function"},"clearTimeout"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("handler"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token comment"},"// 超时之后，即会执行"),e("\n  "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("handler "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"setTimeout"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"checkServer fail, close websocket"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n    "),t("span",{class:"token comment"},"// 主动断开服务器端的连接"),e("\n    _this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"onClose"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token number"},"5000"),e(),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token number"},"1000"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982270-99709"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'onOpen: function() {\n  // 连接创建之时\n  // 设置定时器 -> 如果超时或者服务端没有响应 ping/pong -> 断开与服务端的连接\n  console.log("client is connected");\n  this.checkServer();\n},\n\nonMessage: function () {\n  // 心跳检测\n  if (msg.event === "heartbeat" && msg.message === "ping") {\n    this.checkServer();\n    this.wsHandle.send(\n      JSON.stringify({\n        event: "heartbeat",\n        message: "pong",\n      })\n    );\n    return;\n  }\n  //...\n}\n\n// 定时器方法\ncheckServer: function() {\n  console.log("checkServer in");\n  // 计时器去定时检测websocket的连接\n  var _this = this;\n  clearTimeout(this.handler);\n  // 超时之后，即会执行\n  this.handler = setTimeout(function() {\n    console.log("checkServer fail, close websocket");\n    // 主动断开服务器端的连接\n    _this.onClose();\n  }, 5000 + 1000);\n},\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982270-99709","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br")])],-1),L=t("h3",{id:"ws中的鉴权"},[t("a",{class:"header-anchor",href:"#ws中的鉴权","aria-hidden":"true"},"#"),e(" ws中的鉴权")],-1),R=t("p",null,"鉴权机制设计:",-1),K=t("p",null,"使用jsonwebtoken（jwt）方式进行鉴权：",-1),U=t("p",null,"服务端：",-1),X=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token comment"},"// 在message事件内部"),e("\n    "),t("span",{class:"token comment"},"// 鉴权机制 -> 检验token的有效性"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},"'auth'"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'msg auth is: '"),e(),t("span",{class:"token operator"},"+"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("message"),t("span",{class:"token punctuation"},")"),e("\n      "),t("span",{class:"token comment"},"// 拿到token,并且去校验时效性"),e("\n      jwt"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"verify"),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("message"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token string"},"'secret'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},[e("err"),t("span",{class:"token punctuation"},","),e(" decode")]),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("err"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token comment"},"// websocket返回前台一个消息"),e("\n          console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'auth error'"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token keyword"},"return"),e("\n        "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token comment"},"// 鉴权通过的逻辑"),e("\n          "),t("span",{class:"token comment"},"// 这里可以拿到decode，即payload里面的内容"),e("\n          ws"),t("span",{class:"token punctuation"},"."),e("isAuth "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"true"),e("\n          "),t("span",{class:"token keyword"},"return"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n        console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("decode"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token comment"},"// 拦截，非鉴权的请求"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),e("ws"),t("span",{class:"token punctuation"},"."),e("isAuth"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// 去给客户端发送重新鉴权的消息"),e("\n      ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n        event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'noauth'"),t("span",{class:"token punctuation"},","),e("\n        message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},"'please auth again, your token is expired!'"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n      "),t("span",{class:"token keyword"},"return"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982270-37741"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"// 在message事件内部\n    // 鉴权机制 -> 检验token的有效性\n    if (msgObj.event === 'auth') {\n      console.log('msg auth is: ' + msgObj.message)\n      // 拿到token,并且去校验时效性\n      jwt.verify(msgObj.message, 'secret', function (err, decode) {\n        if (err) {\n          // websocket返回前台一个消息\n          console.log('auth error')\n          return\n        } else {\n          // 鉴权通过的逻辑\n          // 这里可以拿到decode，即payload里面的内容\n          ws.isAuth = true\n          return\n        }\n        console.log(JSON.stringify(decode));\n      })\n    }\n    // 拦截，非鉴权的请求\n    if (!ws.isAuth) {\n      // 去给客户端发送重新鉴权的消息\n      ws.send(JSON.stringify({\n        event: 'noauth',\n        message: 'please auth again, your token is expired!'\n      }))\n      return\n    }\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982270-37741","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br")])],-1),Y=t("p",null,"客户端：",-1),G=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token function-variable function"},"onOpen"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token comment"},"// 连接创建之时"),e("\n  "),t("span",{class:"token comment"},"// 设置定时器 -> 如果超时或者服务端没有响应 ping/pong -> 断开与服务端的连接"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"client is connected"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"checkServer"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token comment"},"// 发送鉴权token，token -> expire"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" data "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"{"),e("\n  event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"auth"'),t("span",{class:"token punctuation"},","),e("\n  message"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"token"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token comment"},"// localstorage, cookie/session -> koa/express"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token comment"},"// 主动鉴权"),e("\n  "),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("data"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982270-9666"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'onOpen: function() {\n  // 连接创建之时\n  // 设置定时器 -> 如果超时或者服务端没有响应 ping/pong -> 断开与服务端的连接\n  console.log("client is connected");\n  this.checkServer();\n  // 发送鉴权token，token -> expire\n  const data = {\n  event: "auth",\n  message: "token", // localstorage, cookie/session -> koa/express\n  };\n  // 主动鉴权\n  this.wsHandle.send(JSON.stringify(data));\n},\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982270-9666","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br")])],-1),Q=t("h3",{id:"websocket中的断线重连"},[t("a",{class:"header-anchor",href:"#websocket中的断线重连","aria-hidden":"true"},"#"),e(" Websocket中的断线重连")],-1),Z=t("ul",null,[t("li",null,[t("p",null,"监听error事件")]),t("li",null,[t("p",null,"使用reconnect-websocket库："),t("ul",null,[t("li",null,[e("es6:"),t("a",{href:"https://www.npmjs.com/package/reconnecting-websocket",target:"_blank",rel:"noopener noreferrer"},"https://www.npmjs.com/package/reconnecting-websocket")])]),t("p",null,"使用方法："),t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"import"),e(" ReconnectingWebSocket "),t("span",{class:"token keyword"},"from"),e(),t("span",{class:"token string"},"'reconnecting-websocket'"),t("span",{class:"token punctuation"},";"),e("\n \n"),t("span",{class:"token keyword"},"const"),e(" rws "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"ReconnectingWebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws://my.site.com'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n \nrws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"addEventListener"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'open'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"=>"),e(),t("span",{class:"token punctuation"},"{"),e("\n    rws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'hello!'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982271-62959"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"import ReconnectingWebSocket from 'reconnecting-websocket';\n \nconst rws = new ReconnectingWebSocket('ws://my.site.com');\n \nrws.addEventListener('open', () => {\n    rws.send('hello!');\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982271-62959","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br")])]),t("ul",null,[t("li",null,[e("es5: "),t("a",{href:"https://github.com/joewalnes/reconnecting-websocket",target:"_blank",rel:"noopener noreferrer"},"https://github.com/joewalnes/reconnecting-websocket")])]),t("p",null,"使用方法："),t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"var"),e(" ws "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"ReconnectingWebSocket"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws://....'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982271-44191"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var ws = new ReconnectingWebSocket('ws://....');\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982271-44191","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br")])])])],-1),nn=t("h3",{id:"websocket与redis结合"},[t("a",{class:"header-anchor",href:"#websocket与redis结合","aria-hidden":"true"},"#"),e(" Websocket与Redis结合")],-1),sn=t("p",null,"Redis：",-1),an=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" redis "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"redis"'),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token punctuation"},"{"),e(" promisifyAll "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"bluebird"'),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token punctuation"},"{"),e(" redisOptions "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"../config/index"'),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" redisClient "),t("span",{class:"token operator"},"="),e(" redis"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createClient"),t("span",{class:"token punctuation"},"("),e("redisOptions"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token function"},"promisifyAll"),t("span",{class:"token punctuation"},"("),e("redisClient"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"// 对连接信息的监听"),e("\nredisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"connect"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"redis client is connected to server!"'),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"// 对错误日志的打印"),e("\nredisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"error"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"err"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"redis client is error: "'),e(),t("span",{class:"token operator"},"+"),e(" err"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n"),t("span",{class:"token comment"},"/**\n * setValue方法\n * @param {String} key 对象的属性\n * @param {String} value 对象的值 JSON.stringfy -> Object\n * @param {*} time 过期时间\n */"),e("\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"setValue"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},[e("key"),t("span",{class:"token punctuation"},","),e(" value"),t("span",{class:"token punctuation"},","),e(" time")]),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("time"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},","),e(" value"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token string"},'"EX"'),t("span",{class:"token punctuation"},","),e(" time"),t("span",{class:"token punctuation"},","),e(" redis"),t("span",{class:"token punctuation"},"."),e("print"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n    redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"set"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},","),e(" value"),t("span",{class:"token punctuation"},","),e(" redis"),t("span",{class:"token punctuation"},"."),e("print"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"/**\n * getValue方法\n * @param {String} key\n * 返回是一个String，需要对对象形式的内容，使用JSON.parse\n */"),e("\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"getValue"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"key"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"getAsync"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"/**\n * 增加记数\n * @param {String}} key\n */"),e("\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"increase"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"key"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"incrAsync"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"decrease"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"key"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"decrAsync"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token comment"},"/**\n * 返回所有相关reg的keys\n * @param {String} reg 定义一个查询的正则表达式\n */"),e("\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"getKeys"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"reg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"keysAsync"),t("span",{class:"token punctuation"},"("),e("reg "),t("span",{class:"token operator"},"+"),e(),t("span",{class:"token string"},'"*"'),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"existKey"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"key"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"existsAsync"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(),t("span",{class:"token function-variable function"},"deleteKey"),e(),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"key"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(" redisClient"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"delAsync"),t("span",{class:"token punctuation"},"("),e("key"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e(" result\n"),t("span",{class:"token punctuation"},"}"),e("\n\nmodule"),t("span",{class:"token punctuation"},"."),e("exports "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"{"),e("\n  setValue"),t("span",{class:"token punctuation"},","),e("\n  getValue"),t("span",{class:"token punctuation"},","),e("\n  increase"),t("span",{class:"token punctuation"},","),e("\n  decrease"),t("span",{class:"token punctuation"},","),e("\n  getKeys"),t("span",{class:"token punctuation"},","),e("\n  existKey"),t("span",{class:"token punctuation"},","),e("\n  deleteKey"),t("span",{class:"token punctuation"},","),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982271-151"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'const redis = require("redis")\nconst { promisifyAll } = require("bluebird")\n\nconst { redisOptions } = require("../config/index")\n\nconst redisClient = redis.createClient(redisOptions)\npromisifyAll(redisClient)\n\n// 对连接信息的监听\nredisClient.on("connect", function() {\n  console.log("redis client is connected to server!")\n})\n\n// 对错误日志的打印\nredisClient.on("error", function(err) {\n  console.log("redis client is error: " + err)\n})\n\n/**\n * setValue方法\n * @param {String} key 对象的属性\n * @param {String} value 对象的值 JSON.stringfy -> Object\n * @param {*} time 过期时间\n */\nconst setValue = function(key, value, time) {\n  if (time) {\n    redisClient.set(key, value, "EX", time, redis.print)\n  } else {\n    redisClient.set(key, value, redis.print)\n  }\n}\n\n/**\n * getValue方法\n * @param {String} key\n * 返回是一个String，需要对对象形式的内容，使用JSON.parse\n */\nconst getValue = async function(key) {\n  const result = await redisClient.getAsync(key)\n  return result\n}\n\n/**\n * 增加记数\n * @param {String}} key\n */\nconst increase = async function(key) {\n  const result = await redisClient.incrAsync(key)\n  return result\n}\n\nconst decrease = async function(key) {\n  const result = await redisClient.decrAsync(key)\n  return result\n}\n\n/**\n * 返回所有相关reg的keys\n * @param {String} reg 定义一个查询的正则表达式\n */\nconst getKeys = async function(reg) {\n  const result = await redisClient.keysAsync(reg + "*")\n  return result\n}\n\nconst existKey = async function(key) {\n  const result = await redisClient.existsAsync(key)\n  return result\n}\n\nconst deleteKey = async function(key) {\n  const result = await redisClient.delAsync(key)\n  return result\n}\n\nmodule.exports = {\n  setValue,\n  getValue,\n  increase,\n  decrease,\n  getKeys,\n  existKey,\n  deleteKey,\n}\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982271-151","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br"),t("span",{class:"line-number"},"78"),t("br"),t("span",{class:"line-number"},"79"),t("br"),t("span",{class:"line-number"},"80"),t("br"),t("span",{class:"line-number"},"81"),t("br"),t("span",{class:"line-number"},"82"),t("br"),t("span",{class:"line-number"},"83"),t("br"),t("span",{class:"line-number"},"84"),t("br")])],-1),tn=t("h3",{id:"离线消息缓存发送"},[t("a",{class:"header-anchor",href:"#离线消息缓存发送","aria-hidden":"true"},"#"),e(" 离线消息缓存发送")],-1),en=t("p",null,"客户端：",-1),on=t("ul",null,[t("li",null,"设置uid，确定ws唯一的标识"),t("li",null,"断线重连后，发送roomid与uid")],-1),cn=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" urlParams "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},"URLSearchParams"),t("span",{class:"token punctuation"},"("),e("window"),t("span",{class:"token punctuation"},"."),e("location"),t("span",{class:"token punctuation"},"."),e("search"),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"const"),e(" uid "),t("span",{class:"token operator"},"="),e(" urlParams"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"get"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"uid"'),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"trim"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'""'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token function"},"alert"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"用户名不得为空"'),t("span",{class:"token punctuation"},")"),e("\n  "),t("span",{class:"token keyword"},"return"),e("\n"),t("span",{class:"token punctuation"},"}"),e("\n"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("wsHandle"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),e("\n  "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n    name"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},","),e("\n    roomid"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},","),e("\n    uid"),t("span",{class:"token operator"},":"),e(" uid"),t("span",{class:"token punctuation"},","),e("\n    event"),t("span",{class:"token operator"},":"),e(),t("span",{class:"token string"},'"login"'),t("span",{class:"token punctuation"},","),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token keyword"},"this"),t("span",{class:"token punctuation"},"."),e("isShow "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"false"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982271-61447"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'const urlParams = new URLSearchParams(window.location.search)\n  const uid = urlParams.get("uid")\n  if (this.name.trim() === "") {\n  alert("用户名不得为空")\n  return\n}\nthis.wsHandle.send(\n  JSON.stringify({\n    name: this.name,\n    roomid: this.roomid,\n    uid: uid,\n    event: "login",\n  })\n)\nthis.isShow = false\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982271-61447","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br")])],-1),pn=t("p",null,"服务端：",-1),ln=t("ul",null,[t("li",null,"使用redis进行消息的缓存"),t("li",null,"对客户端的连接进行唯一性标识"),t("li",null,"对于断开连接的客户端，离线消息进行保存"),t("li",null,"再次连接过来的客户端，发送离线消息")],-1),un=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[e("wss"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"connection"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},[e("ws"),t("span",{class:"token punctuation"},","),e(" req")]),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  "),t("span",{class:"token comment"},"// 初始化客户端的连接状态量"),e("\n  ws"),t("span",{class:"token punctuation"},"."),e("isAlive "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"true"),e("\n\n  "),t("span",{class:"token comment"},"// console.log('a new client is connected!');"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"message"'),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"msg"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    "),t("span",{class:"token keyword"},"var"),e(" msgObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("msg"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"heartbeat"'),e(),t("span",{class:"token operator"},"&&"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("message "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"pong"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("isAlive "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token boolean"},"true"),e("\n      "),t("span",{class:"token keyword"},"return"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("name"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("name "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("name\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("uid "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("uid\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"typeof"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"undefined"'),e(),t("span",{class:"token operator"},"&&"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token comment"},"// 还需要一个客户端的标识，可以知道ws给谁去发送消息"),e("\n      ws"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"="),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid\n      "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"existKey"),t("span",{class:"token punctuation"},"("),e("prefix "),t("span",{class:"token operator"},"+"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("result "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token comment"},"// 初始化数据"),e("\n        "),t("span",{class:"token function"},"setValue"),t("span",{class:"token punctuation"},"("),e("prefix "),t("span",{class:"token operator"},"+"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},","),e(" ws"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e("\n      "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token keyword"},"let"),e(" arrStr "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"getValue"),t("span",{class:"token punctuation"},"("),e("prefix "),t("span",{class:"token operator"},"+"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token comment"},"// String -> Json"),e("\n        "),t("span",{class:"token keyword"},"let"),e(" arr "),t("span",{class:"token operator"},"="),e(" arrStr"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"split"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'","'),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("arr"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"indexOf"),t("span",{class:"token punctuation"},"("),e("ws"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token operator"},"-"),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          arrStr "),t("span",{class:"token operator"},"+="),e(),t("span",{class:"token string"},'","'),e(),t("span",{class:"token operator"},"+"),e(" ws"),t("span",{class:"token punctuation"},"."),e("uid\n          "),t("span",{class:"token function"},"setValue"),t("span",{class:"token punctuation"},"("),e("prefix "),t("span",{class:"token operator"},"+"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},","),e(" arrStr"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n    "),t("span",{class:"token comment"},"// 广播到其他的客户端"),e("\n    "),t("span",{class:"token keyword"},"let"),e(" arrStr1 "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"getValue"),t("span",{class:"token punctuation"},"("),e("prefix "),t("span",{class:"token operator"},"+"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token keyword"},"let"),e(" arr1 "),t("span",{class:"token operator"},"="),e(" arrStr1"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"split"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'","'),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token comment"},"// 在线人数，计算uid的个数"),e("\n    msgObj"),t("span",{class:"token punctuation"},"."),e("total "),t("span",{class:"token operator"},"="),e(" arr1"),t("span",{class:"token punctuation"},"."),e("length\n    msgObj"),t("span",{class:"token punctuation"},"."),e("num "),t("span",{class:"token operator"},"="),e(" wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),e("size\n    wss"),t("span",{class:"token punctuation"},"."),e("clients"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"each"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"client"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("client"),t("span",{class:"token punctuation"},"."),e("readyState "),t("span",{class:"token operator"},"==="),e(" WebSocket"),t("span",{class:"token punctuation"},"."),t("span",{class:"token constant"},"OPEN"),e(),t("span",{class:"token operator"},"&&"),e(" client"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("msgObj"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token comment"},"// 删除已经发送了消息的对应的对象"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("arr1"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"indexOf"),t("span",{class:"token punctuation"},"("),e("client"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token operator"},"-"),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          arr1"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"splice"),t("span",{class:"token punctuation"},"("),e("arr1"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"indexOf"),t("span",{class:"token punctuation"},"("),e("client"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n        "),t("span",{class:"token keyword"},"let"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"existKey"),t("span",{class:"token punctuation"},"("),e("ws"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("result "),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token keyword"},"let"),e(" tmpArr "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"getValue"),t("span",{class:"token punctuation"},"("),e("ws"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token keyword"},"let"),e(" tmpObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("tmpArr"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token keyword"},"let"),e(" uid "),t("span",{class:"token operator"},"="),e(" ws"),t("span",{class:"token punctuation"},"."),e("uid\n          "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("tmpObj"),t("span",{class:"token punctuation"},"."),e("length "),t("span",{class:"token operator"},">"),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n            "),t("span",{class:"token keyword"},"let"),e(" i "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),e("\n            "),t("span",{class:"token comment"},"// 遍历数组，判断是否是同一个roomid，否则的话，就保存数据"),e("\n            tmpObj"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"item"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"==="),e(" client"),t("span",{class:"token punctuation"},"."),e("roomid "),t("span",{class:"token operator"},"&&"),e(" uid "),t("span",{class:"token operator"},"==="),e(" client"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n                "),t("span",{class:"token comment"},"// 如果是同一个roomid，就发送对应的消息数据。"),e("\n                client"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},"."),e("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n                i"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},")"),e("\n              "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("i"),t("span",{class:"token punctuation"},"."),e("length "),t("span",{class:"token operator"},">"),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n              i"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"item"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n                tmpObj"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"splice"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},")"),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n            "),t("span",{class:"token punctuation"},"}"),e("\n            "),t("span",{class:"token function"},"setValue"),t("span",{class:"token punctuation"},"("),e("ws"),t("span",{class:"token punctuation"},"."),e("uid"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("tmpObj"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token punctuation"},"}"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token comment"},"// 判断，是否有客户端没有连接。"),e("\n      "),t("span",{class:"token comment"},"// 对于没有连接的客户端的数据，进行分发缓存处理"),e("\n    "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n\n    "),t("span",{class:"token comment"},"// 说明有一些客户端断开了与roomid的连接，并且，其他客户端发送了对应的消息"),e("\n    "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("arr1"),t("span",{class:"token punctuation"},"."),e("length "),t("span",{class:"token operator"},">"),e(),t("span",{class:"token number"},"0"),e(),t("span",{class:"token operator"},"&&"),e(" msgObj"),t("span",{class:"token punctuation"},"."),e("event "),t("span",{class:"token operator"},"==="),e(),t("span",{class:"token string"},'"message"'),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n      arr1"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"forEach"),t("span",{class:"token punctuation"},"("),t("span",{class:"token keyword"},"async"),e(),t("span",{class:"token keyword"},"function"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"item"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n        "),t("span",{class:"token keyword"},"const"),e(" result "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"existKey"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token keyword"},"if"),e(),t("span",{class:"token punctuation"},"("),e("result "),t("span",{class:"token operator"},"!=="),e(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token keyword"},"let"),e(" udata "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"await"),e(),t("span",{class:"token function"},"getValue"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token keyword"},"let"),e(" uObj "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"parse"),t("span",{class:"token punctuation"},"("),e("udata"),t("span",{class:"token punctuation"},")"),e("\n          uObj"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"push"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n            roomid"),t("span",{class:"token operator"},":"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},","),e("\n            msg"),t("span",{class:"token operator"},":"),e(" msgObj"),t("span",{class:"token punctuation"},","),e("\n          "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token function"},"setValue"),t("span",{class:"token punctuation"},"("),e("item"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),e("uObj"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token punctuation"},"}"),e(),t("span",{class:"token keyword"},"else"),e(),t("span",{class:"token punctuation"},"{"),e("\n          "),t("span",{class:"token comment"},"// 说明先前，这个数据没有进行缓存 ，没有记录"),e("\n          "),t("span",{class:"token function"},"setValue"),t("span",{class:"token punctuation"},"("),e("\n            item"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token constant"},"JSON"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"stringify"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"["),e("\n              "),t("span",{class:"token punctuation"},"{"),e("\n                roomid"),t("span",{class:"token operator"},":"),e(" ws"),t("span",{class:"token punctuation"},"."),e("roomid"),t("span",{class:"token punctuation"},","),e("\n                msg"),t("span",{class:"token operator"},":"),e(" msgObj"),t("span",{class:"token punctuation"},","),e("\n              "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},","),e("\n            "),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},")"),e("\n          "),t("span",{class:"token punctuation"},")"),e("\n        "),t("span",{class:"token punctuation"},"}"),e("\n      "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n    "),t("span",{class:"token punctuation"},"}"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982271-92193"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'wss.on("connection", function(ws, req) {\n  // 初始化客户端的连接状态量\n  ws.isAlive = true\n\n  // console.log(\'a new client is connected!\');\n  ws.on("message", async function(msg) {\n    var msgObj = JSON.parse(msg)\n    if (msgObj.event === "heartbeat" && msgObj.message === "pong") {\n      ws.isAlive = true\n      return\n    }\n    if (msgObj.name) {\n      ws.name = msgObj.name\n    }\n    if (msgObj.uid) {\n      ws.uid = msgObj.uid\n    }\n    if (typeof ws.roomid === "undefined" && msgObj.roomid) {\n      // 还需要一个客户端的标识，可以知道ws给谁去发送消息\n      ws.roomid = msgObj.roomid\n      const result = await existKey(prefix + msgObj.roomid)\n      if (result === 0) {\n        // 初始化数据\n        setValue(prefix + msgObj.roomid, ws.uid)\n      } else {\n        let arrStr = await getValue(prefix + msgObj.roomid)\n        // String -> Json\n        let arr = arrStr.split(",")\n        if (arr.indexOf(ws.uid) === -1) {\n          arrStr += "," + ws.uid\n          setValue(prefix + msgObj.roomid, arrStr)\n        }\n      }\n    }\n    // 广播到其他的客户端\n    let arrStr1 = await getValue(prefix + ws.roomid)\n    let arr1 = arrStr1.split(",")\n    // 在线人数，计算uid的个数\n    msgObj.total = arr1.length\n    msgObj.num = wss.clients.size\n    wss.clients.forEach(async function each(client) {\n      if (client.readyState === WebSocket.OPEN && client.roomid === ws.roomid) {\n        client.send(JSON.stringify(msgObj))\n        // 删除已经发送了消息的对应的对象\n        if (arr1.indexOf(client.uid) !== -1) {\n          arr1.splice(arr1.indexOf(client.uid), 1)\n        }\n        let result = await existKey(ws.uid)\n        if (result !== 0) {\n          let tmpArr = await getValue(ws.uid)\n          let tmpObj = JSON.parse(tmpArr)\n          let uid = ws.uid\n          if (tmpObj.length > 0) {\n            let i = []\n            // 遍历数组，判断是否是同一个roomid，否则的话，就保存数据\n            tmpObj.forEach(function(item) {\n              if (item.roomid === client.roomid && uid === client.uid) {\n                // 如果是同一个roomid，就发送对应的消息数据。\n                client.send(JSON.stringify(item.msg))\n                i.push(item)\n              }\n            })\n            if (i.length > 0) {\n              i.forEach(function(item) {\n                tmpObj.splice(item, 1)\n              })\n            }\n            setValue(ws.uid, JSON.stringify(tmpObj))\n          }\n        }\n      }\n      // 判断，是否有客户端没有连接。\n      // 对于没有连接的客户端的数据，进行分发缓存处理\n    })\n\n    // 说明有一些客户端断开了与roomid的连接，并且，其他客户端发送了对应的消息\n    if (arr1.length > 0 && msgObj.event === "message") {\n      arr1.forEach(async function(item) {\n        const result = await existKey(item)\n        if (result !== 0) {\n          let udata = await getValue(item)\n          let uObj = JSON.parse(udata)\n          uObj.push({\n            roomid: ws.roomid,\n            msg: msgObj,\n          })\n          setValue(item, JSON.stringify(uObj))\n        } else {\n          // 说明先前，这个数据没有进行缓存 ，没有记录\n          setValue(\n            item,\n            JSON.stringify([\n              {\n                roomid: ws.roomid,\n                msg: msgObj,\n              },\n            ])\n          )\n        }\n      })\n    }\n  })\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982271-92193","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br"),t("span",{class:"line-number"},"78"),t("br"),t("span",{class:"line-number"},"79"),t("br"),t("span",{class:"line-number"},"80"),t("br"),t("span",{class:"line-number"},"81"),t("br"),t("span",{class:"line-number"},"82"),t("br"),t("span",{class:"line-number"},"83"),t("br"),t("span",{class:"line-number"},"84"),t("br"),t("span",{class:"line-number"},"85"),t("br"),t("span",{class:"line-number"},"86"),t("br"),t("span",{class:"line-number"},"87"),t("br"),t("span",{class:"line-number"},"88"),t("br"),t("span",{class:"line-number"},"89"),t("br"),t("span",{class:"line-number"},"90"),t("br"),t("span",{class:"line-number"},"91"),t("br"),t("span",{class:"line-number"},"92"),t("br"),t("span",{class:"line-number"},"93"),t("br"),t("span",{class:"line-number"},"94"),t("br"),t("span",{class:"line-number"},"95"),t("br"),t("span",{class:"line-number"},"96"),t("br"),t("span",{class:"line-number"},"97"),t("br"),t("span",{class:"line-number"},"98"),t("br"),t("span",{class:"line-number"},"99"),t("br"),t("span",{class:"line-number"},"100"),t("br"),t("span",{class:"line-number"},"101"),t("br"),t("span",{class:"line-number"},"102"),t("br")])],-1),rn=t("h2",{id:"websocket-ssl配置"},[t("a",{class:"header-anchor",href:"#websocket-ssl配置","aria-hidden":"true"},"#"),e(" Websocket SSL配置")],-1),kn=t("h3",{id:"配置httpswss"},[t("a",{class:"header-anchor",href:"#配置httpswss","aria-hidden":"true"},"#"),e(" 配置HTTPS/WSS")],-1),mn=t("p",null,"如何配置HTTPS/WSS：",-1),dn=t("div",{class:"language-js line-numbers-mode"},[t("pre",null,[t("code",null,[t("span",{class:"token keyword"},"const"),e(" fs "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'fs'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"const"),e(" https "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'https'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"const"),e(" WebSocket "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token function"},"require"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'ws'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n"),t("span",{class:"token keyword"},"const"),e(" server "),t("span",{class:"token operator"},"="),e(" https"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"createServer"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e("\n  cert"),t("span",{class:"token operator"},":"),e(" fs"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"readFileSync"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'/path/to/cert.pem'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),e("\n  key"),t("span",{class:"token operator"},":"),e(" fs"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"readFileSync"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'/path/to/key.pem'"),t("span",{class:"token punctuation"},")"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token keyword"},"const"),e(" wss "),t("span",{class:"token operator"},"="),e(),t("span",{class:"token keyword"},"new"),e(),t("span",{class:"token class-name"},[e("WebSocket"),t("span",{class:"token punctuation"},"."),e("Server")]),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"{"),e(" server "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\nwss"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'connection'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"connection"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"ws"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"on"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'message'"),t("span",{class:"token punctuation"},","),e(),t("span",{class:"token keyword"},"function"),e(),t("span",{class:"token function"},"incoming"),t("span",{class:"token punctuation"},"("),t("span",{class:"token parameter"},"message"),t("span",{class:"token punctuation"},")"),e(),t("span",{class:"token punctuation"},"{"),e("\n    console"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"log"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'received: %s'"),t("span",{class:"token punctuation"},","),e(" message"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n  "),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\n  ws"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"send"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},"'something'"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n"),t("span",{class:"token punctuation"},"}"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n\nserver"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"listen"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"8080"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),e("\n")]),t("div",{class:"m-mdic-copy-wrapper"},[t("div",{class:"u-mdic-copy-notify",id:"j-notify-1629556982272-3848"},"复制成功"),t("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const fs = require('fs');\nconst https = require('https');\nconst WebSocket = require('ws');\n\nconst server = https.createServer({\n  cert: fs.readFileSync('/path/to/cert.pem'),\n  key: fs.readFileSync('/path/to/key.pem')\n});\nconst wss = new WebSocket.Server({ server });\n\nwss.on('connection', function connection(ws) {\n  ws.on('message', function incoming(message) {\n    console.log('received: %s', message);\n  });\n\n  ws.send('something');\n});\n\nserver.listen(8080);\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629556982272-3848","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),t("div",{class:"line-numbers-wrapper"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br")])],-1),bn=a('',3);c.render=function(a,t,e,o,c,yn){return n(),s("div",null,[p,l,i,u,r,k,m,d,b,y,f,g,w,h,v,S,C,j,O,x,N,T,W,E,A,V,_,P,$,I,J,H,q,D,F,B,z,M,L,R,K,U,X,Y,G,Q,Z,nn,sn,an,tn,en,on,cn,pn,ln,un,rn,kn,mn,dn,bn])};export default c;export{o as __pageData};

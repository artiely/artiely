import{o as n,c as s,f as t,a,x as e}from"./app.b304d650.js";const o='{"title":"nodejs事件循环与多进程","description":"","frontmatter":{"title":"nodejs事件循环与多进程","tag":["events","cluster","macrotask","microtask"],"author":"Artiely","date":"2019-6-4","cover":"https://gitee.com/artiely/Figure-bed/raw/master/images/20200315153642.png","base64":"32332b"},"headers":[{"level":2,"title":"介绍","slug":"介绍"},{"level":2,"title":"目标","slug":"目标"},{"level":2,"title":"第一章 事件循环介绍","slug":"第一章-事件循环介绍"},{"level":3,"title":"浏览器中的事件循环","slug":"浏览器中的事件循环"},{"level":3,"title":"nodejs中的事件循环","slug":"nodejs中的事件循环"},{"level":3,"title":"事件循环的本质","slug":"事件循环的本质"},{"level":2,"title":"第二章 浏览器事件循环","slug":"第二章-浏览器事件循环"},{"level":3,"title":"Javascript为什么是单线程的？","slug":"javascript为什么是单线程的"},{"level":3,"title":"任务队列","slug":"任务队列"},{"level":3,"title":"宏任务与微任务","slug":"宏任务与微任务"},{"level":2,"title":"第三章 nodejs事件循环","slug":"第三章-nodejs事件循环"},{"level":3,"title":"阶段概览","slug":"阶段概览"},{"level":3,"title":"代码执行1","slug":"代码执行1"},{"level":3,"title":"代码执行2","slug":"代码执行2"},{"level":3,"title":"代码执行3","slug":"代码执行3"},{"level":3,"title":"process.nextTick","slug":"processnexttick"},{"level":2,"title":"第四章 nodejs多进程","slug":"第四章-nodejs多进程"},{"level":3,"title":"本章概要","slug":"本章概要"},{"level":3,"title":"为什么需要多进程","slug":"为什么需要多进程"},{"level":3,"title":"多进程和多线程介绍","slug":"多进程和多线程介绍"},{"level":3,"title":"到底选择多进程还是多线程？","slug":"到底选择多进程还是多线程"},{"level":3,"title":"nodejs多线程","slug":"nodejs多线程"},{"level":3,"title":"创建多进程","slug":"创建多进程"},{"level":3,"title":"cluster相关API","slug":"cluster相关api"}],"relativePath":"post/2019/2019-6-4-nodejs-events.md","lastUpdated":1629110828886}',c={},l=t('',16),p=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nPromise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'promise'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token comment"},"// 1. main 2. promise 3. setTimeout"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-48415"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(() => {\n  console.log('setTimeout')\n}, 0);\n\nPromise.resolve().then(() => {\n  console.log('promise');\n});\n\nconsole.log('main');\n\n// 1. main 2. promise 3. setTimeout\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-48415","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br")])],-1),i=t('',6),u=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main1'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main2'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-56552"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(() => {\n  console.log('setTimeout')\n}, 0);\n\nconsole.log('main1');\nconsole.log('main2');\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-56552","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br")])],-1),r=t('',6),d=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nPromise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'promise'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token comment"},"// 1. main 2. promise 3. setTimeout"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-68360"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(() => {\n  console.log('setTimeout')\n}, 0);\n\nPromise.resolve().then(() => {\n  console.log('promise');\n});\n\nconsole.log('main');\n\n// 1. main 2. promise 3. setTimeout\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-68360","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br")])],-1),k=a("h4",{id:"高频面试题"},[a("a",{class:"header-anchor",href:"#高频面试题","aria-hidden":"true"},"#"),e(" 高频面试题")],-1),m=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nPromise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'promise'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  Promise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'promise2'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-39456"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(() => {\n  console.log('setTimeout');\n}, 0);\n\nPromise.resolve().then(() => {\n  console.log('promise');\n  Promise.resolve().then(() => {\n    console.log('promise2');\n  });\n});\n\nconsole.log('main');\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-39456","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br")])],-1),b=a("blockquote",null,[a("p",null,"每轮事件循环执行一个宏任务和所有的微任务。")],-1),y=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  Promise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'promise'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nPromise"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"then"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  \tconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'main'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-3342"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(() => {\n  Promise.resolve().then(() => {\n    console.log('promise');\n  });\n}, 0);\n\nPromise.resolve().then(() => {\n  setTimeout(() => {\n  \tconsole.log('setTimeout');\n  }, 0);\n});\n\nconsole.log('main');\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-3342","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br")])],-1),h=t('',12),f=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" fs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fs'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" path "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'path'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"someAsyncOperation"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"callback"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token comment"},"// 花费2毫秒"),e("\n  fs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"readFile"),a("span",{class:"token punctuation"},"("),e("path"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),e("__dirname"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token string"},"'/read.txt'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(" callback"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" timeoutScheduled "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" fileReadTime "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token keyword"},"var"),e(" delay "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"-"),e(" timeoutScheduled"),a("span",{class:"token punctuation"},";"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout: '"),e(),a("span",{class:"token operator"},"+"),e(),a("span",{class:"token punctuation"},"("),e("delay"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"+"),e(),a("span",{class:"token string"},'"ms have passed since I was scheduled"'),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fileReaderTime'"),a("span",{class:"token punctuation"},","),e("fileReadtime "),a("span",{class:"token operator"},"-"),e(" timeoutScheduled"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"10"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"someAsyncOperation"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  fileReadtime "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token keyword"},"while"),a("span",{class:"token punctuation"},"("),e("Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"-"),e(" fileReadtime "),a("span",{class:"token operator"},"<"),e(),a("span",{class:"token number"},"20"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n\n  "),a("span",{class:"token punctuation"},"}"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741619-23958"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var fs = require('fs');\nvar path = require('path');\n\nfunction someAsyncOperation (callback) {\n  // 花费2毫秒\n  fs.readFile(path.resolve(__dirname, '/read.txt'), callback);\n}\n\nvar timeoutScheduled = Date.now();\nvar fileReadTime = 0;\n\nsetTimeout(function () {\n  var delay = Date.now() - timeoutScheduled;\n  console.log('setTimeout: ' + (delay) + \"ms have passed since I was scheduled\");\n  console.log('fileReaderTime',fileReadtime - timeoutScheduled);\n}, 10);\n\nsomeAsyncOperation(function () {\n  fileReadtime = Date.now();\n  while(Date.now() - fileReadtime < 20) {\n\n  }\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741619-23958","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br"),a("span",{class:"line-number"},"17"),a("br"),a("span",{class:"line-number"},"18"),a("br"),a("span",{class:"line-number"},"19"),a("br"),a("span",{class:"line-number"},"20"),a("br"),a("span",{class:"line-number"},"21"),a("br"),a("span",{class:"line-number"},"22"),a("br"),a("span",{class:"line-number"},"23"),a("br")])],-1),g=a("h3",{id:"代码执行2"},[a("a",{class:"header-anchor",href:"#代码执行2","aria-hidden":"true"},"#"),e(" 代码执行2")],-1),v=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" fs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fs'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"someAsyncOperation"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"callback"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token keyword"},"var"),e(" time "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token comment"},"// 花费9毫秒"),e("\n  fs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"readFile"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'/path/to/xxxx.pdf'"),a("span",{class:"token punctuation"},","),e(" callback"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" timeoutScheduled "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" fileReadTime "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" delay "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  delay "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"-"),e(" timeoutScheduled"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"5"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"someAsyncOperation"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  fileReadtime "),a("span",{class:"token operator"},"="),e(" Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token keyword"},"while"),a("span",{class:"token punctuation"},"("),e("Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"-"),e(" fileReadtime "),a("span",{class:"token operator"},"<"),e(),a("span",{class:"token number"},"20"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n\n  "),a("span",{class:"token punctuation"},"}"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout: '"),e(),a("span",{class:"token operator"},"+"),e(),a("span",{class:"token punctuation"},"("),e("delay"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"+"),e(),a("span",{class:"token string"},'"ms have passed since I was scheduled"'),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fileReaderTime'"),a("span",{class:"token punctuation"},","),e("fileReadtime "),a("span",{class:"token operator"},"-"),e(" timeoutScheduled"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741620-26978"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var fs = require('fs');\n\nfunction someAsyncOperation (callback) {\n  var time = Date.now();\n  // 花费9毫秒\n  fs.readFile('/path/to/xxxx.pdf', callback);\n}\n\nvar timeoutScheduled = Date.now();\nvar fileReadTime = 0;\nvar delay = 0;\n\nsetTimeout(function () {\n  delay = Date.now() - timeoutScheduled;\n}, 5);\n\nsomeAsyncOperation(function () {\n  fileReadtime = Date.now();\n  while(Date.now() - fileReadtime < 20) {\n\n  }\n  console.log('setTimeout: ' + (delay) + \"ms have passed since I was scheduled\");\n  console.log('fileReaderTime',fileReadtime - timeoutScheduled);\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741620-26978","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br"),a("span",{class:"line-number"},"17"),a("br"),a("span",{class:"line-number"},"18"),a("br"),a("span",{class:"line-number"},"19"),a("br"),a("span",{class:"line-number"},"20"),a("br"),a("span",{class:"line-number"},"21"),a("br"),a("span",{class:"line-number"},"22"),a("br"),a("span",{class:"line-number"},"23"),a("br"),a("span",{class:"line-number"},"24"),a("br")])],-1),w=a("h3",{id:"代码执行3"},[a("a",{class:"header-anchor",href:"#代码执行3","aria-hidden":"true"},"#"),e(" 代码执行3")],-1),C=a("blockquote",null,[a("p",null,"在nodejs中， setTimeout(demo, 0) === setTimeout(demo, 1)"),a("p",null,"在浏览器里面 setTimeout(demo, 0) === setTimeout(demo, 4)")],-1),x=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"timeout"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'timeout'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),a("span",{class:"token number"},"1"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"setImmediate"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"immediate"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'immediate'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token comment"},"// setImmediate它有时候是1ms之前执行，有时候又是1ms之后执行？"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741620-91141"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"setTimeout(function timeout () {\n  console.log('timeout');\n},1);\n\nsetImmediate(function immediate () {\n  console.log('immediate');\n});\n// setImmediate它有时候是1ms之前执行，有时候又是1ms之后执行？\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741620-91141","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br")])],-1),T=a("blockquote",null,[a("p",null,"因为event loop的启动也是需要时间的，可能执行到poll阶段已经超过了1ms，此时setTimeout会先执行。反之setImmediate先执行")],-1),j=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" path "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'path'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" fs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fs'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nfs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"readFile"),a("span",{class:"token punctuation"},"("),e("path"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),e("__dirname"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token string"},"'/read.txt'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token function"},"setImmediate"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n        console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setImmediate'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),e("\n    \n    "),a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n        console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741620-6835"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var path = require('path');\nvar fs = require('fs');\n\nfs.readFile(path.resolve(__dirname, '/read.txt'), () => {\n    setImmediate(() => {\n        console.log('setImmediate');\n    })\n    \n    setTimeout(() => {\n        console.log('setTimeout')\n    }, 0)\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741620-6835","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br")])],-1),_=a("h3",{id:"processnexttick"},[a("a",{class:"header-anchor",href:"#processnexttick","aria-hidden":"true"},"#"),e(" process.nextTick")],-1),I=a("p",null,[a("strong",null,"process.nextTick()不在event loop的任何阶段执行，而是在各个阶段切换的中间执行"),e(",即从一个阶段切换到下个阶段前执行。")],-1),q=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" fs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fs'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nfs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"readFile"),a("span",{class:"token punctuation"},"("),e("__filename"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token function"},"setTimeout"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setTimeout'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token function"},"setImmediate"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'setImmediate'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token operator"},"=>"),a("span",{class:"token punctuation"},"{"),e("\n      console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'nextTick3'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token operator"},"=>"),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'nextTick1'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),e("\n  process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token operator"},"=>"),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'nextTick2'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741620-65777"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var fs = require('fs');\n\nfs.readFile(__filename, () => {\n  setTimeout(() => {\n    console.log('setTimeout');\n  }, 0);\n  setImmediate(() => {\n    console.log('setImmediate');\n    process.nextTick(()=>{\n      console.log('nextTick3');\n    })\n  });\n  process.nextTick(()=>{\n    console.log('nextTick1');\n  })\n  process.nextTick(()=>{\n    console.log('nextTick2');\n  })\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741620-65777","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br"),a("span",{class:"line-number"},"17"),a("br"),a("span",{class:"line-number"},"18"),a("br"),a("span",{class:"line-number"},"19"),a("br")])],-1),$=a("h4",{id:"设计原因"},[a("a",{class:"header-anchor",href:"#设计原因","aria-hidden":"true"},"#"),e(" 设计原因")],-1),P=a("p",null,[e("允许开发者通过递归调用 "),a("code",null,"process.nextTick()"),e(" 来阻塞I/O操作。")],-1),E=a("h4",{id:"nexttick应用场景"},[a("a",{class:"header-anchor",href:"#nexttick应用场景","aria-hidden":"true"},"#"),e(" nextTick应用场景")],-1),N=a("ol",null,[a("li",null,"在多个事件里交叉执行CPU运算密集型的任务：")],-1),S=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" http "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'http'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"compute"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    \n    process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),e("compute"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),a("span",{class:"token comment"},"//"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n\nhttp"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"createServer"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("req"),a("span",{class:"token punctuation"},","),e(" res")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("  "),a("span",{class:"token comment"},"// 服务http请求的时候，还能抽空进行一些计算任务"),e("\n     res"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"writeHead"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"200"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"{"),a("span",{class:"token string"},"'Content-Type'"),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},"'text/plain'"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n     res"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"end"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'Hello World'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"listen"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"5000"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token string"},"'127.0.0.1'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token function"},"compute"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741620-15790"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var http = require('http');\n\nfunction compute() {\n    \n    process.nextTick(compute);//\n}\n\nhttp.createServer(function(req, res) {  // 服务http请求的时候，还能抽空进行一些计算任务\n     res.writeHead(200, {'Content-Type': 'text/plain'});\n     res.end('Hello World');\n}).listen(5000, '127.0.0.1');\n\ncompute();\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741620-15790","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br")])],-1),A=a("blockquote",null,[a("p",null,"在这种模式下，我们不需要递归的调用compute()，我们只需要在事件循环中使用process.nextTick()定义compute()在下一个时间点执行即可。在这个过程中，如果有新的http请求进来，事件循环机制会先处理新的请求，然后再调用compute()。反之，如果你把compute()放在一个递归调用里，那系统就会一直阻塞在compute()里，无法处理新的http请求了。")],-1),D=a("ol",{start:"2"},[a("li",null,"保持回调函数异步执行的原则")],-1),F=a("p",null,"当你给一个函数定义一个回调函数时，你要确保这个回调是被异步执行的。下面我们看一个例子，例子中的回调违反了这一原则：",-1),R=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"asyncFake"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("data"),a("span",{class:"token punctuation"},","),e(" callback")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("        \n    "),a("span",{class:"token keyword"},"if"),a("span",{class:"token punctuation"},"("),e("data "),a("span",{class:"token operator"},"==="),e(),a("span",{class:"token string"},"'foo'"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token function"},"callback"),a("span",{class:"token punctuation"},"("),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token keyword"},"else"),e(),a("span",{class:"token function"},"callback"),a("span",{class:"token punctuation"},"("),a("span",{class:"token boolean"},"false"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n\n"),a("span",{class:"token function"},"asyncFake"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'bar'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"result"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token comment"},"// this callback is actually called synchronously!"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-30607"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"function asyncFake(data, callback) {        \n    if(data === 'foo') callback(true);\n    else callback(false);\n}\n\nasyncFake('bar', function(result) {\n    // this callback is actually called synchronously!\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-30607","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br")])],-1),B=a("p",null,"为什么这样不好呢？我们来看Node.js 文档里一段代码：",-1),O=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" client "),a("span",{class:"token operator"},"="),e(" net"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"connect"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"8124"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e(" \n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'client connected'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    client"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"write"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'world!\\r\\n'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-76104"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var client = net.connect(8124, function() { \n    console.log('client connected');\n    client.write('world!\\r\\n');\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-76104","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br")])],-1),M=a("p",null,"在上面的代码里，如果因为某种原因，net.connect()变成同步执行的了，回调函数就会被立刻执行，因此回调函数写到客户端的变量就永远不会被初始化了。",-1),U=a("p",null,"这种情况下我们就可以使用process.nextTick()把上面asyncFake()改成异步执行的：",-1),V=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"asyncReal"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("data"),a("span",{class:"token punctuation"},","),e(" callback")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        "),a("span",{class:"token function"},"callback"),a("span",{class:"token punctuation"},"("),e("data "),a("span",{class:"token operator"},"==="),e(),a("span",{class:"token string"},"'foo'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("       \n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-93199"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"function asyncReal(data, callback) {\n    process.nextTick(function() {\n        callback(data === 'foo');       \n    });\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-93199","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br")])],-1),W=a("ol",{start:"3"},[a("li",null,[a("p",null,"用在事件触发过程中"),a("blockquote",null,[a("p",null,"EventEmitter有2个比较核心的方法， on和emit。node自带发布/订阅模式")])])],-1),H=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" EventEmitter "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'events'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("EventEmitter"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"StreamLibrary"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"resourceName"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e(" \n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"emit"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'start'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n"),a("span",{class:"token class-name"},"StreamLibrary"),a("span",{class:"token punctuation"},"."),e("prototype"),a("span",{class:"token punctuation"},"."),e("__proto__ "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token class-name"},"EventEmitter"),a("span",{class:"token punctuation"},"."),e("prototype"),a("span",{class:"token punctuation"},";"),e("   "),a("span",{class:"token comment"},"// inherit from EventEmitter"),e("\n\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-27760"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var EventEmitter = require('events').EventEmitter;\n\nfunction StreamLibrary(resourceName) { \n    this.emit('start');\n}\nStreamLibrary.prototype.__proto__ = EventEmitter.prototype;   // inherit from EventEmitter\n\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-27760","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br")])],-1),L=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" stream "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"new"),e(),a("span",{class:"token class-name"},"StreamLibrary"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'fooResource'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nstream"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'start'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'Reading has started'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-38410"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var stream = new StreamLibrary('fooResource');\n\nstream.on('start', function() {\n    console.log('Reading has started');\n});\n\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-38410","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br")])],-1),J=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"StreamLibrary"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"resourceName"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("      \n    "),a("span",{class:"token keyword"},"var"),e(" self "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},";"),e("\n\n    process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"nextTick"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        self"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"emit"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'start'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("  "),a("span",{class:"token comment"},"// 保证订阅永远在发布之前"),e("\n\n    "),a("span",{class:"token comment"},"// read from the file, and for every chunk read, do:        "),e("\n    \n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-70038"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"function StreamLibrary(resourceName) {      \n    var self = this;\n\n    process.nextTick(function() {\n        self.emit('start');\n    });  // 保证订阅永远在发布之前\n\n    // read from the file, and for every chunk read, do:        \n    \n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-70038","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br")])],-1),K=t('',21),z=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" cluster "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'cluster'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" http "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'http'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" numCPUs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'os'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"cpus"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("length"),a("span",{class:"token punctuation"},";"),e(),a("span",{class:"token comment"},"// 获取CPU的个数"),e("\n \n"),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),e("cluster"),a("span",{class:"token punctuation"},"."),e("isMaster"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token keyword"},"for"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"var"),e(" i "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e(" i "),a("span",{class:"token operator"},"<"),e(" numCPUs"),a("span",{class:"token punctuation"},";"),e(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        cluster"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),e("\n \n    cluster"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'exit'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("worker"),a("span",{class:"token punctuation"},","),e(" code"),a("span",{class:"token punctuation"},","),e(" signal")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'worker '"),e(),a("span",{class:"token operator"},"+"),e(" worker"),a("span",{class:"token punctuation"},"."),e("process"),a("span",{class:"token punctuation"},"."),e("pid "),a("span",{class:"token operator"},"+"),e(),a("span",{class:"token string"},"' died'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e(),a("span",{class:"token keyword"},"else"),e(),a("span",{class:"token punctuation"},"{"),e("\n    http"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"createServer"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("req"),a("span",{class:"token punctuation"},","),e(" res")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        res"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"writeHead"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"200"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n        res"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"end"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},'"hello world\\n"'),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"listen"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"8000"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-12668"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var cluster = require('cluster');\nvar http = require('http');\nvar numCPUs = require('os').cpus().length; // 获取CPU的个数\n \nif (cluster.isMaster) {\n    for (var i = 0; i < numCPUs; i++) {\n        cluster.fork();\n    }\n \n    cluster.on('exit', function(worker, code, signal) {\n        console.log('worker ' + worker.process.pid + ' died');\n    });\n} else {\n    http.createServer(function(req, res) {\n        res.writeHead(200);\n        res.end(\"hello world\\n\");\n    }).listen(8000);\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-12668","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br"),a("span",{class:"line-number"},"17"),a("br"),a("span",{class:"line-number"},"18"),a("br")])],-1),X=a("p",null,"稍微优化下：",-1),G=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" cluster "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'cluster'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" numCPUs "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'os'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"cpus"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("length"),a("span",{class:"token punctuation"},";"),e("\n \n"),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),e("cluster"),a("span",{class:"token punctuation"},"."),e("isMaster"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token keyword"},"for"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"var"),e(" i "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e(" i "),a("span",{class:"token operator"},"&"),e("lt"),a("span",{class:"token punctuation"},";"),e(" numCPUs"),a("span",{class:"token punctuation"},";"),e(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        cluster"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),e("\n    "),a("span",{class:"token comment"},"// 其它代码"),e("\n    \n"),a("span",{class:"token punctuation"},"}"),e(),a("span",{class:"token keyword"},"else"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},'"./app.js"'),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741621-79801"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var cluster = require('cluster');\nvar numCPUs = require('os').cpus().length;\n \nif (cluster.isMaster) {\n    for (var i = 0; i < numCPUs; i++) {\n        cluster.fork();\n    }\n    // 其它代码\n    \n} else {\n    require(\"./app.js\");\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741621-79801","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br")])],-1),Q=t('',8),Y=a("div",{class:"language-json line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token comment"},"// 使用 IntelliSense 了解相关属性。 "),e("\n    "),a("span",{class:"token comment"},"// 悬停以查看现有属性的描述。"),e("\n    "),a("span",{class:"token comment"},"// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387"),e("\n    "),a("span",{class:"token property"},'"version"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},'"0.2.0"'),a("span",{class:"token punctuation"},","),e("\n    "),a("span",{class:"token property"},'"configurations"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token punctuation"},"["),e("\n\n        \n        "),a("span",{class:"token punctuation"},"{"),e("\n            "),a("span",{class:"token property"},'"type"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},'"node"'),a("span",{class:"token punctuation"},","),e("\n            "),a("span",{class:"token property"},'"request"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},'"launch"'),a("span",{class:"token punctuation"},","),e("\n            "),a("span",{class:"token property"},'"name"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},'"Launch Program"'),a("span",{class:"token punctuation"},","),e("\n            "),a("span",{class:"token property"},'"program"'),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},'"${workspaceFolder}/chapter4/http_cluster.js"'),e("\n        "),a("span",{class:"token punctuation"},"}"),e("\n    "),a("span",{class:"token punctuation"},"]"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-24217"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'{\n    // 使用 IntelliSense 了解相关属性。 \n    // 悬停以查看现有属性的描述。\n    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387\n    "version": "0.2.0",\n    "configurations": [\n\n        \n        {\n            "type": "node",\n            "request": "launch",\n            "name": "Launch Program",\n            "program": "${workspaceFolder}/chapter4/http_cluster.js"\n        }\n    ]\n}\n',"data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-24217","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br")])],-1),Z=t('',14),nn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" exec "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("exec"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" ls "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"exec"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'ls -c'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("error"),a("span",{class:"token punctuation"},","),e(" stdout"),a("span",{class:"token punctuation"},","),e(" stderr")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),e("error"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),e("error"),a("span",{class:"token punctuation"},"."),e("stack"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'Error code: '"),e(),a("span",{class:"token operator"},"+"),e(" error"),a("span",{class:"token punctuation"},"."),e("code"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'Child Process STDOUT: '"),e(),a("span",{class:"token operator"},"+"),e(" stdout"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-54854"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var exec = require('child_process').exec;\n\nvar ls = exec('ls -c', function (error, stdout, stderr) {\n  if (error) {\n    console.log(error.stack);\n    console.log('Error code: ' + error.code);\n  }\n  console.log('Child Process STDOUT: ' + stdout);\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-54854","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br")])],-1),sn=a("p",null,"由于标准输出和标准错误都是流对象（stream），可以监听data事件，因此上面的代码也可以写成下面这样。",-1),tn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" exec "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("exec"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" child "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"exec"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'ls'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nchild"),a("span",{class:"token punctuation"},"."),e("stdout"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'data'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"data"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'stdout: '"),e(),a("span",{class:"token operator"},"+"),e(" data"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nchild"),a("span",{class:"token punctuation"},"."),e("stderr"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'data'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"data"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'stdout: '"),e(),a("span",{class:"token operator"},"+"),e(" data"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nchild"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'close'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"code"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'closing code: '"),e(),a("span",{class:"token operator"},"+"),e(" code"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-56878"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var exec = require('child_process').exec;\nvar child = exec('ls');\n\nchild.stdout.on('data', function(data) {\n  console.log('stdout: ' + data);\n});\nchild.stderr.on('data', function(data) {\n  console.log('stdout: ' + data);\n});\nchild.on('close', function(code) {\n  console.log('closing code: ' + code);\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-56878","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br")])],-1),an=a("p",null,"上面的代码还有一个好处。监听data事件以后，可以实时输出结果，否则只有等到子进程结束，才会输出结果。所以，如果子进程运行时间较长，或者是持续运行，第二种写法更好。",-1),en=a("ol",{start:"2"},[a("li",null,[a("strong",null,"execSync()")])],-1),on=a("p",null,"exec()的同步版本",-1),cn=a("ol",{start:"3"},[a("li",null,[a("strong",null,"execFile()")])],-1),ln=a("p",null,"execFile方法直接执行特定的程序shell，参数作为数组传入，不会被bash解释，因此具有较高的安全性。",-1),pn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(),a("span",{class:"token punctuation"},"{"),e("execFile"),a("span",{class:"token punctuation"},"}"),e(),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token function"},"execFile"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'ls'"),a("span",{class:"token punctuation"},","),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},"'-c'"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("error"),a("span",{class:"token punctuation"},","),e(" stdout"),a("span",{class:"token punctuation"},","),e(" stderr")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n\t"),a("span",{class:"token keyword"},"if"),a("span",{class:"token punctuation"},"("),e("error"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n\t\tconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"error"),a("span",{class:"token punctuation"},"("),a("span",{class:"token template-string"},[a("span",{class:"token template-punctuation string"},"`"),a("span",{class:"token string"},"exec error: "),a("span",{class:"token interpolation"},[a("span",{class:"token interpolation-punctuation punctuation"},"${"),e("error"),a("span",{class:"token interpolation-punctuation punctuation"},"}")]),a("span",{class:"token template-punctuation string"},"`")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\t\t"),a("span",{class:"token keyword"},"return"),a("span",{class:"token punctuation"},";"),e("\n\t"),a("span",{class:"token punctuation"},"}"),e("\n\tconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token template-string"},[a("span",{class:"token template-punctuation string"},"`"),a("span",{class:"token interpolation"},[a("span",{class:"token interpolation-punctuation punctuation"},"${"),e("stdout"),a("span",{class:"token interpolation-punctuation punctuation"},"}")]),a("span",{class:"token template-punctuation string"},"`")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\tconsole"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token template-string"},[a("span",{class:"token template-punctuation string"},"`"),a("span",{class:"token interpolation"},[a("span",{class:"token interpolation-punctuation punctuation"},"${"),e("stderr"),a("span",{class:"token interpolation-punctuation punctuation"},"}")]),a("span",{class:"token template-punctuation string"},"`")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-72801"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const {execFile} = require('child_process');\nexecFile('ls',['-c'], (error, stdout, stderr) => {\n\tif(error) {\n\t\tconsole.error(`exec error: ${error}`);\n\t\treturn;\n\t}\n\tconsole.log(`${stdout}`);\n\tconsole.log(`${stderr}`);\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-72801","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br")])],-1),un=a("ol",{start:"4"},[a("li",null,[a("strong",null,"spawn()")])],-1),rn=a("p",null,"spawn方法创建一个子进程来执行特定命令shell，用法与execFile方法类似，但是没有回调函数，只能通过监听事件，来获取运行结果。它属于异步执行，适用于子进程长时间运行的情况。",-1),dn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(),a("span",{class:"token punctuation"},"{"),e(" spawn "),a("span",{class:"token punctuation"},"}"),e(),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" child "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"spawn"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'ls'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},"'-c'"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},","),a("span",{class:"token punctuation"},"{"),e("\n    encoding"),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},"'UTF-8'"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\nchild"),a("span",{class:"token punctuation"},"."),e("stdout"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'data'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"data"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'data'"),a("span",{class:"token punctuation"},","),e(" data"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"toString"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'utf8'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nchild"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'close'"),a("span",{class:"token punctuation"},","),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"code"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'closing code: '"),e(),a("span",{class:"token operator"},"+"),e(" code"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-86049"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const { spawn } = require('child_process');\n\nvar child = spawn('ls', ['-c'],{\n    encoding: 'UTF-8'\n});\n\nchild.stdout.on('data', function(data) {\n    console.log('data', data.toString('utf8'))\n});\nchild.on('close',function(code) {\n    console.log('closing code: ' + code);\n  });\n\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-86049","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br")])],-1),kn=a("blockquote",null,[a("p",null,"spawn返回的结果是Buffer需要转换为utf8")],-1),mn=a("ol",{start:"5"},[a("li",null,[a("strong",null,"fork()")])],-1),bn=a("p",null,[e("fork方法直接创建一个子进程，执行Node脚本，"),a("code",null,"fork('./child.js')"),e(" 相当于 "),a("code",null,"spawn('node', ['./child.js'])"),e(" 。与spawn方法不同的是，fork会在父进程与子进程之间，建立一个通信管道pipe，用于进程之间的通信,也是IPC通信的基础。")],-1),yn=a("p",null,[a("code",null,"main.js")],-1),hn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"var"),e(" child_process "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" path "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'path'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" child "),a("span",{class:"token operator"},"="),e(" child_process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),e("path"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"resolve"),a("span",{class:"token punctuation"},"("),e("__dirname"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token string"},"'./child.js'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nchild"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"m"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'主线程收到消息'"),a("span",{class:"token punctuation"},","),e(" m"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nchild"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),e(" hello"),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},"'world'"),e(),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741622-63322"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"var child_process = require('child_process');\nvar path = require('path');\n\nvar child = child_process.fork(path.resolve(__dirname, './child.js'));\nchild.on('message', function(m) {\n  console.log('主线程收到消息', m);\n});\nchild.send({ hello: 'world' });\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741622-63322","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br")])],-1),fn=a("p",null,[a("code",null,"child.js")],-1),gn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[e("process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"m"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'子进程收到消息'"),a("span",{class:"token punctuation"},","),e(" m"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nprocess"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),e(" foo"),a("span",{class:"token operator"},":"),e(),a("span",{class:"token string"},"'bar'"),e(),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-52137"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"process.on('message', function (m) {\n    console.log('子进程收到消息', m);\n});\nprocess.send({ foo: 'bar' });\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-52137","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br")])],-1),vn=t('',11),wn=a("div",{class:"language-"},[a("pre",null,[a("code",null,"这样的方式仅仅实现了多进程。多进程运行还涉及父子进程通信，子进程管理，以及负载均衡等问题，这些特性cluster帮你实现了。\n"),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-41834"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"这样的方式仅仅实现了多进程。多进程运行还涉及父子进程通信，子进程管理，以及负载均衡等问题，这些特性cluster帮你实现了。\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-41834","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br")])],-1),Cn=t('',10),xn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(" net "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'net'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"const"),e(" fork "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("fork"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" handle "),a("span",{class:"token operator"},"="),e(" net"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"_createServerHandle"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'0.0.0.0'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"3000"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"for"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"var"),e(" i"),a("span",{class:"token operator"},"="),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e("i"),a("span",{class:"token operator"},"<"),a("span",{class:"token number"},"4"),a("span",{class:"token punctuation"},";"),e("i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'11111111111111111111111111'"),a("span",{class:"token punctuation"},")"),e("\n   "),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'./worker'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e(" handle"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-11711"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const net = require('net');\nconst fork = require('child_process').fork;\n\nvar handle = net._createServerHandle('0.0.0.0', 3000);\n\nfor(var i=0;i<4;i++) {\n    console.log('11111111111111111111111111')\n   fork('./worker').send({}, handle);\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-11711","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br")])],-1),Tn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(" net "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'net'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nprocess"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("m"),a("span",{class:"token punctuation"},","),e(" handle")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token function"},"start"),a("span",{class:"token punctuation"},"("),e("handle"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" buf "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token string"},"'hello nodejs'"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" res "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},"'HTTP/1.1 200 OK'"),a("span",{class:"token punctuation"},","),a("span",{class:"token string"},"'content-length:'"),a("span",{class:"token operator"},"+"),e("buf"),a("span",{class:"token punctuation"},"."),e("length"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"join"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'\\r\\n'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token operator"},"+"),a("span",{class:"token string"},"'\\r\\n\\r\\n'"),a("span",{class:"token operator"},"+"),e("buf"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" data "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token punctuation"},"{"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"start"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"server"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    server"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"listen"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    server"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function-variable function"},"onconnection"),e(),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"function"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("err"),a("span",{class:"token punctuation"},","),e("handle")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n        "),a("span",{class:"token keyword"},"var"),e(" pid "),a("span",{class:"token operator"},"="),e(" process"),a("span",{class:"token punctuation"},"."),e("pid"),a("span",{class:"token punctuation"},";"),e("\n        "),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token operator"},"!"),e("data"),a("span",{class:"token punctuation"},"["),e("pid"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n            data"),a("span",{class:"token punctuation"},"["),e("pid"),a("span",{class:"token punctuation"},"]"),e(),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e("\n        "),a("span",{class:"token punctuation"},"}"),e("\n        data"),a("span",{class:"token punctuation"},"["),e("pid"),a("span",{class:"token punctuation"},"]"),e(),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},";"),e("\n        console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'got a connection on worker, pid = %d'"),a("span",{class:"token punctuation"},","),e(" process"),a("span",{class:"token punctuation"},"."),e("pid"),a("span",{class:"token punctuation"},","),e(" data"),a("span",{class:"token punctuation"},"["),e("pid"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n        "),a("span",{class:"token keyword"},"var"),e(" socket "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"new"),e(),a("span",{class:"token class-name"},[e("net"),a("span",{class:"token punctuation"},"."),e("Socket")]),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),e("\n            handle"),a("span",{class:"token operator"},":"),e(" handle\n        "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n        socket"),a("span",{class:"token punctuation"},"."),e("readable "),a("span",{class:"token operator"},"="),e(" socket"),a("span",{class:"token punctuation"},"."),e("writable "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},";"),e("\n        socket"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"end"),a("span",{class:"token punctuation"},"("),e("res"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token punctuation"},"}"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-28960"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const net = require('net');\nprocess.on('message', function(m, handle) {\n  start(handle);\n});\n\nvar buf = 'hello nodejs';\nvar res = ['HTTP/1.1 200 OK','content-length:'+buf.length].join('\\r\\n')+'\\r\\n\\r\\n'+buf;\n\nvar data = {};\n\nfunction start(server) {\n    server.listen();\n    server.onconnection = function(err,handle) {\n        var pid = process.pid;\n        if (!data[pid]) {\n            data[pid] = 0;\n        }\n        data[pid] ++;\n        console.log('got a connection on worker, pid = %d', process.pid, data[pid]);\n        var socket = new net.Socket({\n            handle: handle\n        });\n        socket.readable = socket.writable = true;\n        socket.end(res);\n    }\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-28960","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br"),a("span",{class:"line-number"},"17"),a("br"),a("span",{class:"line-number"},"18"),a("br"),a("span",{class:"line-number"},"19"),a("br"),a("span",{class:"line-number"},"20"),a("br"),a("span",{class:"line-number"},"21"),a("br"),a("span",{class:"line-number"},"22"),a("br"),a("span",{class:"line-number"},"23"),a("br"),a("span",{class:"line-number"},"24"),a("br"),a("span",{class:"line-number"},"25"),a("br"),a("span",{class:"line-number"},"26"),a("br")])],-1),jn=a("p",null,[a("img",{src:"https://gitee.com/artiely/Figure-bed/raw/master/images/20200313154507.png",alt:"image-20190602164750971"})],-1),_n=a("h4",{id:"nginx-proxy"},[a("a",{class:"header-anchor",href:"#nginx-proxy","aria-hidden":"true"},"#"),e(" nginx proxy")],-1),In=a("blockquote",null,[a("p",null,"Nginx 是俄罗斯人编写的十分轻量级的 HTTP 服务器,Nginx，它的发音为“engine X”，是一个高性能的HTTP和反向代理服务器。异步非阻塞I/O，而且能够高并发。"),a("p",null,"正向代理： 客户端为代理，服务器不知道客户端是谁。"),a("p",null,"反向代理： 服务器为代理，客户端不知道服务器是谁。")],-1),qn=a("p",null,"nginx配置demo：",-1),$n=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[e("http "),a("span",{class:"token punctuation"},"{"),e(" \n  upstream cluster "),a("span",{class:"token punctuation"},"{"),e(" \n \t\t  server "),a("span",{class:"token number"},"127.0"),a("span",{class:"token number"},".0"),a("span",{class:"token number"},".1"),a("span",{class:"token operator"},":"),a("span",{class:"token number"},"3000"),a("span",{class:"token punctuation"},";"),e("   "),a("span",{class:"token comment"},"// 挂掉"),e("\n      server "),a("span",{class:"token number"},"127.0"),a("span",{class:"token number"},".0"),a("span",{class:"token number"},".1"),a("span",{class:"token operator"},":"),a("span",{class:"token number"},"3001"),a("span",{class:"token punctuation"},";"),e("   "),a("span",{class:"token comment"},"// 挂掉"),e("\n      server "),a("span",{class:"token number"},"127.0"),a("span",{class:"token number"},".0"),a("span",{class:"token number"},".1"),a("span",{class:"token operator"},":"),a("span",{class:"token number"},"3002"),a("span",{class:"token punctuation"},";"),e(" \n      server "),a("span",{class:"token number"},"127.0"),a("span",{class:"token number"},".0"),a("span",{class:"token number"},".1"),a("span",{class:"token operator"},":"),a("span",{class:"token number"},"3003"),a("span",{class:"token punctuation"},";"),e(" \n  "),a("span",{class:"token punctuation"},"}"),e(" \n  server "),a("span",{class:"token punctuation"},"{"),e(" \n       listen "),a("span",{class:"token number"},"80"),a("span",{class:"token punctuation"},";"),e(" \n       server_name www"),a("span",{class:"token punctuation"},"."),e("domain"),a("span",{class:"token punctuation"},"."),e("com"),a("span",{class:"token punctuation"},";"),e(" \n       location "),a("span",{class:"token operator"},"/"),e(),a("span",{class:"token punctuation"},"{"),e(" \n            proxy_pass http"),a("span",{class:"token operator"},":"),a("span",{class:"token operator"},"/"),a("span",{class:"token operator"},"/"),e("cluster"),a("span",{class:"token punctuation"},";"),e("\n       "),a("span",{class:"token punctuation"},"}"),e(" \n  "),a("span",{class:"token punctuation"},"}"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-52235"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"http { \n  upstream cluster { \n \t\t  server 127.0.0.1:3000;   // 挂掉\n      server 127.0.0.1:3001;   // 挂掉\n      server 127.0.0.1:3002; \n      server 127.0.0.1:3003; \n  } \n  server { \n       listen 80; \n       server_name www.domain.com; \n       location / { \n            proxy_pass http://cluster;\n       } \n  }\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-52235","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br")])],-1),Pn=t('',9),En=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(" net "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'net'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"const"),e(" fork "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'child_process'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),e("fork"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" workers "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token punctuation"},"["),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"for"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"var"),e(" i "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),e(" i "),a("span",{class:"token operator"},"<"),e(),a("span",{class:"token number"},"4"),a("span",{class:"token punctuation"},";"),e(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n   workers"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"push"),a("span",{class:"token punctuation"},"("),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'./worker'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" handle "),a("span",{class:"token operator"},"="),e(" net"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"_createServerHandle"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'0.0.0.0'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token number"},"3000"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nhandle"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"listen"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nhandle"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function-variable function"},"onconnection"),e(),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("err"),a("span",{class:"token punctuation"},","),e("handle")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    "),a("span",{class:"token keyword"},"var"),e(" worker "),a("span",{class:"token operator"},"="),e(" workers"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"pop"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    worker"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),e("handle"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    workers"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"unshift"),a("span",{class:"token punctuation"},"("),e("worker"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-85328"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const net = require('net');\nconst fork = require('child_process').fork;\n\nvar workers = [];\nfor (var i = 0; i < 4; i++) {\n   workers.push(fork('./worker'));\n}\n\nvar handle = net._createServerHandle('0.0.0.0', 3000);\nhandle.listen();\nhandle.onconnection = function (err,handle) {\n    var worker = workers.pop();\n    worker.send({},handle);\n    workers.unshift(worker);\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-85328","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br")])],-1),Nn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token keyword"},"const"),e(" net "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'net'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\nprocess"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[e("m"),a("span",{class:"token punctuation"},","),e(" handle")]),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token function"},"start"),a("span",{class:"token punctuation"},"("),e("handle"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"var"),e(" buf "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token string"},"'hello Node.js'"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"var"),e(" res "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},"'HTTP/1.1 200 OK'"),a("span",{class:"token punctuation"},","),a("span",{class:"token string"},"'content-length:'"),a("span",{class:"token operator"},"+"),e("buf"),a("span",{class:"token punctuation"},"."),e("length"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"join"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'\\r\\n'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token operator"},"+"),a("span",{class:"token string"},"'\\r\\n\\r\\n'"),a("span",{class:"token operator"},"+"),e("buf"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"function"),e(),a("span",{class:"token function"},"start"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"handle"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'got a connection on worker, pid = %d'"),a("span",{class:"token punctuation"},","),e(" process"),a("span",{class:"token punctuation"},"."),e("pid"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    "),a("span",{class:"token keyword"},"var"),e(" socket "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token keyword"},"new"),e(),a("span",{class:"token class-name"},[e("net"),a("span",{class:"token punctuation"},"."),e("Socket")]),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},"{"),e("\n        handle"),a("span",{class:"token operator"},":"),e(" handle\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n    socket"),a("span",{class:"token punctuation"},"."),e("readable "),a("span",{class:"token operator"},"="),e(" socket"),a("span",{class:"token punctuation"},"."),e("writable "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},";"),e("\n    socket"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"end"),a("span",{class:"token punctuation"},"("),e("res"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741623-71574"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"const net = require('net');\nprocess.on('message', function (m, handle) {\n  start(handle);\n});\n\nvar buf = 'hello Node.js';\nvar res = ['HTTP/1.1 200 OK','content-length:'+buf.length].join('\\r\\n')+'\\r\\n\\r\\n'+buf;\n\nfunction start(handle) {\n    console.log('got a connection on worker, pid = %d', process.pid);\n    var socket = new net.Socket({\n        handle: handle\n    });\n    socket.readable = socket.writable = true;\n    socket.end(res);\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741623-71574","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br"),a("span",{class:"line-number"},"15"),a("br"),a("span",{class:"line-number"},"16"),a("br")])],-1),Sn=a("h5",{id:"cluster中的优雅退出"},[a("a",{class:"header-anchor",href:"#cluster中的优雅退出","aria-hidden":"true"},"#"),e(" cluster中的优雅退出")],-1),An=a("ol",null,[a("li",null,"关闭异常 Worker 进程所有的 TCP Server（将已有的连接快速断开，且不再接收新的连接），断开和 Master 的 IPC 通道，不再接受新的用户请求。"),a("li",null,"Master 立刻 fork 一个新的 Worker 进程，保证在线的『工人』总数不变。"),a("li",null,"异常 Worker 等待一段时间，处理完已经接受的请求后退出。")],-1),Dn=a("div",{class:"language-"},[a("pre",null,[a("code",null,"if (cluster.isMaster) {\n\tcluster.fork()\n} else {\n\t// 出错之后\n\tprocess.disconnect();  // exit()\n}\t\n"),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741624-2737"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"if (cluster.isMaster) {\n\tcluster.fork()\n} else {\n\t// 出错之后\n\tprocess.disconnect();  // exit()\n}\t\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741624-2737","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br")])],-1),Fn=a("h5",{id:"进程守护"},[a("a",{class:"header-anchor",href:"#进程守护","aria-hidden":"true"},"#"),e(" 进程守护")],-1),Rn=a("p",null,"master 进程除了负责接收新的连接，分发给各 worker 进程处理之外，还得像天使一样默默地守护着这些 worker 进程，保障整个应用的稳定性。一旦某个 worker 进程异常退出就 fork 一个新的子进程顶替上去。",-1),Bn=a("p",null,"这一切 cluster 模块都已经好处理了，当某个 worker 进程发生异常退出或者与 master 进程失去联系（disconnected）时，master 进程都会收到相应的事件通知。",-1),On=a("div",{class:"language-"},[a("pre",null,[a("code",null,"cluster.on('exit', function () {\n    clsuter.fork();\n});\n\ncluster.on('disconnect', function () {\n    clsuter.fork();\n});\n"),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741624-11086"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"cluster.on('exit', function () {\n    clsuter.fork();\n});\n\ncluster.on('disconnect', function () {\n    clsuter.fork();\n});\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741624-11086","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br")])],-1),Mn=a("h5",{id:"ipc通信"},[a("a",{class:"header-anchor",href:"#ipc通信","aria-hidden":"true"},"#"),e(" IPC通信")],-1),Un=a("p",null,"IPC通信就是进程间的通信。",-1),Vn=a("p",null,"虽然每个 Worker 进程是相对独立的，但是它们之间始终还是需要通讯的，叫进程间通讯（IPC）。下面是 Node.js 官方提供的一段示例代码",-1),Wn=a("div",{class:"language-js line-numbers-mode"},[a("pre",null,[a("code",null,[a("span",{class:"token string"},"'use strict'"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token keyword"},"const"),e(" cluster "),a("span",{class:"token operator"},"="),e(),a("span",{class:"token function"},"require"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'cluster'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n\n"),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),e("cluster"),a("span",{class:"token punctuation"},"."),e("isMaster"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  "),a("span",{class:"token keyword"},"const"),e(" worker "),a("span",{class:"token operator"},"="),e(" cluster"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"fork"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  worker"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'hi there'"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  worker"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token parameter"},"msg"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    console"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"log"),a("span",{class:"token punctuation"},"("),a("span",{class:"token template-string"},[a("span",{class:"token template-punctuation string"},"`"),a("span",{class:"token string"},"msg: "),a("span",{class:"token interpolation"},[a("span",{class:"token interpolation-punctuation punctuation"},"${"),e("msg"),a("span",{class:"token interpolation-punctuation punctuation"},"}")]),a("span",{class:"token string"}," from worker#"),a("span",{class:"token interpolation"},[a("span",{class:"token interpolation-punctuation punctuation"},"${"),e("worker"),a("span",{class:"token punctuation"},"."),e("id"),a("span",{class:"token interpolation-punctuation punctuation"},"}")]),a("span",{class:"token template-punctuation string"},"`")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e(),a("span",{class:"token keyword"},"else"),e(),a("span",{class:"token keyword"},"if"),e(),a("span",{class:"token punctuation"},"("),e("cluster"),a("span",{class:"token punctuation"},"."),e("isWorker"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token punctuation"},"{"),e("\n  process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"on"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'message'"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"msg"),a("span",{class:"token punctuation"},")"),e(),a("span",{class:"token operator"},"=>"),e(),a("span",{class:"token punctuation"},"{"),e("\n    process"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"send"),a("span",{class:"token punctuation"},"("),e("msg"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e("\n"),a("span",{class:"token punctuation"},"}"),e("\n")]),a("div",{class:"m-mdic-copy-wrapper"},[a("div",{class:"u-mdic-copy-notify",id:"j-notify-1629558741624-55876"},"复制成功"),a("button",{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":"'use strict';\nconst cluster = require('cluster');\n\nif (cluster.isMaster) {\n  const worker = cluster.fork();\n  worker.send('hi there');\n  worker.on('message', msg => {\n    console.log(`msg: ${msg} from worker#${worker.id}`);\n  });\n} else if (cluster.isWorker) {\n  process.on('message', (msg) => {\n    process.send(msg);\n  });\n}\n","data-mdic-attach-content":"copyright | [artiely]","data-mdic-notify-id":"j-notify-1629558741624-55876","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"},"复制")])]),a("div",{class:"line-numbers-wrapper"},[a("span",{class:"line-number"},"1"),a("br"),a("span",{class:"line-number"},"2"),a("br"),a("span",{class:"line-number"},"3"),a("br"),a("span",{class:"line-number"},"4"),a("br"),a("span",{class:"line-number"},"5"),a("br"),a("span",{class:"line-number"},"6"),a("br"),a("span",{class:"line-number"},"7"),a("br"),a("span",{class:"line-number"},"8"),a("br"),a("span",{class:"line-number"},"9"),a("br"),a("span",{class:"line-number"},"10"),a("br"),a("span",{class:"line-number"},"11"),a("br"),a("span",{class:"line-number"},"12"),a("br"),a("span",{class:"line-number"},"13"),a("br"),a("span",{class:"line-number"},"14"),a("br")])],-1),Hn=a("p",null,"细心的你可能已经发现 cluster 的 IPC 通道只存在于 Master 和 Worker 之间，Worker 与 Worker 进程互相间是没有的。那么 Worker 之间想通讯该怎么办呢？通过 Master 来转发。",-1),Ln=a("p",null,"核心： worker直接的通信，靠master转发，利用workder的pid。",-1);c.render=function(t,a,e,o,c,Jn){return n(),s("div",null,[l,p,i,u,r,d,k,m,b,y,h,f,g,v,w,C,x,T,j,_,I,q,$,P,E,N,S,A,D,F,R,B,O,M,U,V,W,H,L,J,K,z,X,G,Q,Y,Z,nn,sn,tn,an,en,on,cn,ln,pn,un,rn,dn,kn,mn,bn,yn,hn,fn,gn,vn,wn,Cn,xn,Tn,jn,_n,In,qn,$n,Pn,En,Nn,Sn,An,Dn,Fn,Rn,Bn,On,Mn,Un,Vn,Wn,Hn,Ln])};export default c;export{o as __pageData};

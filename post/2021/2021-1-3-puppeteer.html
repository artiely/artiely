<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从使用场景了解puppeteer | Artiely' blog</title>
    <meta name="description" content="随便玩玩">
    <link rel="stylesheet" href="/vitepress-blog/assets/style.04ecf5c6.css">
    <link rel="modulepreload" href="/vitepress-blog/assets/Home.00555797.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/lottie.42100ed3.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/lightgallery.es5.f43f3494.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/TextPlugin.8595634c.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/app.b304d650.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/post_2021_2021-1-3-puppeteer.md.f0a96ae9.lean.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/app.b304d650.js">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2707633_ayah6j2r7wi.css">
    <script type="text/javascript" src="/js/twikoo.js"></script>
    <meta name="twitter:title" content="从使用场景了解puppeteer | Artiely&#39; blog">
    <meta property="og:title" content="从使用场景了解puppeteer | Artiely&#39; blog">
  </head>
  <body>
    <div id="app"><!--[--><!----><!----><div class="content dark" style="height:100%;"><div style="position:relative;"><div><h1 id="puppeteer-是什么"><a class="header-anchor" href="#puppeteer-是什么" aria-hidden="true">#</a> Puppeteer 是什么</h1><p>英 [ˌpʌpɪˈtɪər]<br> 美 [ˌpʌpɪˈtɪr]</p><p>n. 操纵木偶的人；操纵傀儡<br> vt. 操纵</p><ul><li>浏览器自动化库</li><li>Puppeteer = Node.js + Chrome</li><li>评估 Javascript</li></ul><!--
- Puppeteer 是 Node.js 工具引擎
- Puppeteer 提供了一系列 API，通过 Chrome DevTools Protocol 协议控制 Chromium/Chrome 浏览器的行为
- Puppeteer 默认情况下是以 headless 启动 Chrome 的，也可以通过参数控制启动有界面的 Chrome
- Puppeteer 默认绑定最新的 Chromium 版本，也可以自己设置不同版本的绑定
- Puppeteer 让我们不需要了解太多的底层 CDP 协议实现与浏览器的通信

## [什么是 Chrome DevTool Protocol](https://chromedevtools.github.io/devtools-protocol/)

- CDP 基于 WebSocket，利用 WebSocket 实现与浏览器内核的快速数据通道
- CDP 分为多个域（DOM，Debugger，Network，Profiler，Console...），每个域中都定义了相关的命令和事件（Commands and Events）
- 我们可以基于 CDP 封装一些工具对 Chrome 浏览器进行调试及分析，比如我们常用的 “Chrome 开发者工具” 就是基于 CDP 实现的
- 如果你以 remote-debugging-port 参数启动 Chrome，那么就可以看到所有 Tab 页面的开发者调试前端页面，还会在同一端口上还提供了 http 服务，主要提供以下几个接口：
```sh
GET /json/version                     # 获取浏览器的一些元信息
GET /json or /json/list               # 当前浏览器上打开的一些页面信息
GET /json/protocol                    # 获取当前 CDP 的协议信息
GET /json/new?{url}                   # 开启一共新的 Tab 页面
GET /json/activate/{targetId}         # 激活某个页面成为当前显示的页面
GET /json/close/{targetId}            # 关闭某个页面
GET /devtools/inspector.html          # 打开当前页面的开发者调试工具
WebSocket /devtools/page/{targetId}   # 获取某个页面的 websocket 地址
```
很多有用的工具都是基于 CDP 实现的，比如 Chrome 开发者工具，chrome-remote-interface，Puppeteer 等

# Puppeteer 能做什么
官方称：“Most things that you can do manually in the browser can be done using Puppeteer”，那么具体可以做些什么呢？

- 网页截图或者生成 PDF
- 爬取 SPA 或 SSR 网站
- UI 自动化测试，模拟表单提交，键盘输入，点击等行为
- 捕获网站的时间线，帮助诊断性能问题
- 创建一个最新的自动化测试环境，使用最新的 js 和最新的 Chrome 浏览器运行测试用例
- 测试 Chrome 扩展程序
...

# Puppeteer API 分层结构
Puppeteer 中的 API 分层结构基本和浏览器保持一致，下面对常使用到的几个类介绍一下：
![](https://gitee.com/artiely/Figure-bed/raw/master/20210104101644.png)

- `Browser`： 对应一个浏览器实例，一个 Browser 可以包含多个 BrowserContext
- `BrowserContext`： 对应浏览器一个上下文会话，就像我们打开一个普通的 Chrome 之后又打开一个隐身模式的浏览器一样，BrowserContext 具有独立的 Session(cookie 和 cache 独立不共享)，一个 BrowserContext 可以包含多个 Page
- `Page`：表示一个 Tab 页面，通过 browserContext.newPage()/browser.newPage() 创建，browser.newPage() 创建页面时会使用默认的 BrowserContext，一个 Page 可以包含多个 Frame
- `Frame`: 一个框架，每个页面有一个主框架（page.MainFrame()）,也可以多个子框架，主要由 iframe 标签创建产生的
- `ExecutionContext`： 是 javascript 的执行环境，每一个 Frame 都一个默认的 javascript 执行环境
- `ElementHandle`: 对应 DOM 的一个元素节点，通过该该实例可以实现对元素的点击，填写表单等行为，我们可以通过选择器，xPath 等来获取对应的元素
- `JsHandle`：对应 DOM 中的 javascript 对象，ElementHandle 继承于 JsHandle，由于我们无法直接操作 DOM 中对象，所以封装成 JsHandle 来实现相关功能
- `CDPSession`：可以直接与原生的 CDP 进行通信，通过 session.send 函数直接发消息，通过 session.on 接收消息，可以实现 Puppeteer API 中没有涉及的功能
- `Coverage`：获取 JavaScript 和 CSS 代码覆盖率
- `Tracing`：抓取性能数据进行分析
- `Response`： 页面收到的响应
- `Request`：  --><h1 id="官网"><a class="header-anchor" href="#官网" aria-hidden="true">#</a> 官网</h1><p><a href="https://github.com/puppeteer/puppeteer" target="_blank" rel="noopener noreferrer">Puppeteer</a></p><h2 id="安装"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><p>只需安装 NPM 包即可开始</p><div class="language-js line-numbers-mode"><pre><code>npm i puppeteer
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-88006">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="npm i puppeteer
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-88006" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> puppetter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;puppeteer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ....</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-69869">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const puppetter = require(&quot;puppeteer&quot;);
(async () =&gt; {
  // ....
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
})();
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-69869" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="从一些场景中了解-puppeteer-的应用"><a class="header-anchor" href="#从一些场景中了解-puppeteer-的应用" aria-hidden="true">#</a> 从一些场景中了解 Puppeteer 的应用</h2><ol><li>某购物网站某商品的价格变化趋势或某新闻网站的新闻</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token keyword">const</span> puppetter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;puppeteer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ....</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取价格</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> price <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">$sevel</span><span class="token punctuation">(</span><span class="token string">&quot;.price&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">div</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> div<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-16594">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const puppetter = require(&quot;puppeteer&quot;);
(async () =&gt; {
  // ....
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  // 获取价格
  await page.goto(&quot;https://...&quot;);
  const price = await page.$sevel(&quot;.price&quot;, (div) =&gt; div.textContent);
  console.log(price);
  await browser.close();
})();
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-16594" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>处理异步和对网站进行测试 可以结合任何测试库</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should pay&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 异步处理 waithForX ...</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelect</span><span class="token punctuation">(</span><span class="token string">&#39;.button&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>res<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/pay&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">&#39;.button&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> response
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">$evel</span><span class="token punctuation">(</span><span class="token string">&#39;.success&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-48661">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="it(&#39;should pay&#39;,()=&gt;{
  const page = await browser.newPage();
  await page.goto(&quot;https://...&quot;);
  // 异步处理 waithForX ...
  await page.waitForSelect(&#39;.button&#39;)
  const response = page.waitForResponse(res=&gt;res.url().endsWith(&#39;/pay&#39;))
  await page.click(&#39;.button&#39;)
  await response
  assert(await page.$evel(&#39;.success&#39;))
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-48661" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li>测试在移动设备的表现</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should work on mobile&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">emulate</span><span class="token punctuation">(</span>puppeteer<span class="token punctuation">.</span>devices<span class="token punctuation">[</span><span class="token string">&#39;iPhone 8&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-82333">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="it(&#39;should work on mobile&#39;,()=&gt;{
  const page = await browser.newPage();
  await page.emulate(puppeteer.devices[&#39;iPhone 8&#39;])
  // ...
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-82333" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="4"><li>网站的离线表现</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should notify user when goes offline&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">emulate</span><span class="token punctuation">(</span>puppeteer<span class="token punctuation">.</span>devices<span class="token punctuation">[</span><span class="token string">&#39;iPhone 8&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setOfflineMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> alert <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelece</span><span class="token punctuation">(</span><span class="token string">&#39;.offline-alert&#39;</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>alert<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-48493">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="it(&#39;should notify user when goes offline&#39;,()=&gt;{
  const page = await browser.newPage();
  await page.emulate(puppeteer.devices[&#39;iPhone 8&#39;])
  await page.goto(&quot;https://...&quot;);
  await page.setOfflineMode(true)
  const alert = await page.waitForSelece(&#39;.offline-alert&#39;)
  expect(alert).toBeTruthy()
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-48493" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="5"><li>检测注册的 servce worker</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should register service worker&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">emulate</span><span class="token punctuation">(</span>puppeteer<span class="token punctuation">.</span>devices<span class="token punctuation">[</span><span class="token string">&#39;iPhone 8&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> swTarget <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForTarget</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string">&#39;ervice_worker&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> sw <span class="token operator">=</span> <span class="token keyword">await</span> swTarget<span class="token punctuation">.</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> isCatch  <span class="token operator">=</span> <span class="token keyword">await</span> sw<span class="token punctuation">.</span><span class="token function">evalute</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&#39;https://artiely.gitee.io/x.png&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>isCatch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760978-48160">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="it(&#39;should register service worker&#39;,()=&gt;{
  const page = await browser.newPage();
  await page.emulate(puppeteer.devices[&#39;iPhone 8&#39;])
  await page.goto(&quot;https://...&quot;);
  const swTarget = await page.waitForTarget(target=&gt;{
    return target.type()===&#39;ervice_worker&#39;
  })
  const sw = await swTarget.worker()
  const isCatch  = await sw.evalute(async()=&gt;{
    return !!(await caches.match(&#39;https://artiely.gitee.io/x.png&#39;))
  })
  expect(isCatch).toBe(true)
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760978-48160" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>进阶</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&#39;https://...&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token string">&#39;navigator.serviceWorker.ready&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> requests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
page<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span><span class="token parameter">req</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> requests<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span>waitUntil<span class="token operator">:</span><span class="token string">&#39;networkkid0&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span>req<span class="token punctuation">]</span> <span class="token keyword">of</span> requests<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> swResp <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromServiceWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>swResp<span class="token operator">?</span><span class="token string">&#39;√&#39;</span>：<span class="token string">&#39;×&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-52396">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="await page.goto(&#39;https://...&#39;)
await page.evaluate(&#39;navigator.serviceWorker.ready&#39;);

const requests = new Map();
page.on(&#39;request&#39;,req=&gt;{
  return requests.set(req.url(),req);
})

await page.reload({waitUntil:&#39;networkkid0&#39;});

for(const [url,req] of requests){
  const swResp = req.response().fromServiceWorker();
  const.log(url,swResp?&#39;√&#39;：&#39;×&#39;)
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-52396" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="6"><li>模拟位置</li></ol><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should $ in US&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">emulate</span><span class="token punctuation">(</span>puppeteer<span class="token punctuation">.</span>devices<span class="token punctuation">[</span><span class="token string">&#39;iPhone 8&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setGeolocation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    latitude<span class="token operator">:</span><span class="token number">140.00</span><span class="token punctuation">,</span>
    longitude<span class="token operator">:</span><span class="token number">30.00</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-45271">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="it(&#39;should $ in US&#39;,()=&gt;{
  const page = await browser.newPage();
  await page.emulate(puppeteer.devices[&#39;iPhone 8&#39;])
  await page.setGeolocation({
    latitude:140.00,
    longitude:30.00
  })
  await page.goto(&quot;https://...&quot;);
  // ...
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-45271" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="7"><li>拦截并修改。。。</li></ol><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">await</span> page <span class="token function">serRequestInterception</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
page<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span><span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 修改图片</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">resourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token string">&#39;image&#39;</span><span class="token punctuation">)</span>
    request<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span>body<span class="token operator">:</span> <span class="token function">randomCatImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span>
    request<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 取消请求</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;https://x/pay&#39;</span><span class="token punctuation">)</span>
    request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span>
    request<span class="token punctuation">.</span><span class="token function">contiune</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-88137">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="await page serRequestInterception(true)
page.on(&#39;request&#39;,request =&gt; {
  // 修改图片
  if(request.resourceType()=== &#39;image&#39;)
    request.respond({body: randomCatImage()})
  else
    request.continue()
  // 取消请求
  if(request.url() === &#39;https://x/pay&#39;)
    request.abort()
  else
    request.contiune()
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-88137" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="8"><li>模拟输入和事件</li></ol><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&quot;https://pptr.dev/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelect</span><span class="token punctuation">(</span><span class="token string">&quot;[type=search]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> input<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">&quot;javascript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span>keyboard<span class="token punctuation">.</span><span class="token function">press</span><span class="token punctuation">(</span><span class="token string">&quot;Enter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-57572">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="await page.goto(&quot;https://pptr.dev/&quot;);
const input = await page.waitForSelect(&quot;[type=search]&quot;);
await input.type(&quot;javascript&quot;);
await page.keyboard.press(&quot;Enter&quot;);
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-57572" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="9"><li>页面性能指标</li></ol><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-9427">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const metrics = await page.metrics();
console.log(metrics);
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-9427" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">await</span> page<span class="token punctuation">.</span>tracing<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token operator">:</span><span class="token string">&#39;./trace.json&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&#39;https://pptr.dev&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelect</span><span class="token punctuation">(</span><span class="token string">&#39;select&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token punctuation">.</span>tracing<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-25921">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="await page.tracing.start({path:&#39;./trace.json&#39;});
await page.goto(&#39;https://pptr.dev&#39;);
await page.waitForSelect(&#39;select&#39;);
// ...
await page..tracing.stop()
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-25921" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="10"><li>服务端渲染</li></ol><div class="language-html line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">posts<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        &lt;li&gt;
        &lt;h2&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h2&gt;
        &lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
        &lt;/li&gt;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ul&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;ul&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/post&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rednder</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760979-20198">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;div id=&quot;container&quot;&gt;&lt;/div&gt;
&lt;script&gt;
  function render(posts, container) {
    const html = posts.reduce((html, post) =&gt; {
      return `${html}
        &lt;li&gt;
        &lt;h2&gt;${post.title}&lt;/h2&gt;
        &lt;p&gt;${post.content}&lt;/p&gt;
        &lt;/li&gt;
        `;
    }, &quot;&quot;);
    container.innerHTML = `&lt;ul&gt;${html}&lt;ul&gt;`;
  }
  fetch(&quot;/post&quot;)
    .then((res) =&gt; res.json())
    .then((res) =&gt; rednder(res, document.getElementById(&quot;container&quot;)));
&lt;/script&gt;
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760979-20198" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>ssr.js</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">import</span> puppeteer <span class="token keyword">from</span> <span class="token string">&quot;puppeteer&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ssr</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">lanuch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> headless<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> waitUntil<span class="token operator">:</span> <span class="token string">&quot;networkidle0&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-94262">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="import puppeteer from &quot;puppeteer&quot;;
export async function ssr(url) {
  const browser = await puppeteer.lanuch({ headless: true });
  const page = await browser.newPage();
  await page.goto(url, { waitUntil: &quot;networkidle0&quot; });
  const html = await page.content();
  await browser.close();
  return html;
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-94262" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>server.js</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ssr <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./ssr.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ssr</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>origin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-46">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="import express from &quot;express&quot;;
import { ssr } from &quot;./ssr.js&quot;;
const app = express();
app.get(&quot;/&quot;, async (req, res, next) =&gt; {
  const origin = `${req.protocol}://${req.get(&quot;host&quot;)}`;
  const html = await ssr(`${origin}/index.html`);
  return res.status(200).send(html);
});
app.listen(8080, () =&gt; {
  console.log(&quot;server start&quot;);
});
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-46" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>优化更快的直达<br> ssr.js</li></ul><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token keyword">import</span> puppeteer <span class="token keyword">from</span> <span class="token string">&quot;puppeteer&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ssr</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">lanuch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> headless<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// await page.goto(url, { waitUntil: &quot;networkidle0&quot; });</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> waitUntil<span class="token operator">:</span> <span class="token string">&quot;documentloaded&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// const html = await page.content();</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">&quot;#post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-27158">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="import puppeteer from &quot;puppeteer&quot;;
export async function ssr(url) {
  const browser = await puppeteer.lanuch({ headless: true });
  const page = await browser.newPage();
  // await page.goto(url, { waitUntil: &quot;networkidle0&quot; });
  await page.goto(url, { waitUntil: &quot;documentloaded&quot; });
  // const html = await page.content();
  await page.waitForSelector(&quot;#post&quot;);
  await browser.close();
  return html;
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-27158" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>优化 2 添加缓存<br> ssr.js</li></ul><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token constant">RENDER_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ssr</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">RENDER_CACHE</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">RENDER_CACHE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token constant">RENDER_CACHE</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-52561">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const RENDER_CACHE = new Map();
async function ssr(url) {
  if (RENDER_CACHE.has(url)) return RENDER_CACHE.get(url);
  // ...
  RENDER_CACHE.set(url, html);
  return html;
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-52561" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>添加缓存<br> index.html</p><div class="language-html line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">posts<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        &lt;li&gt;
        &lt;h2&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h2&gt;
        &lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
        &lt;/li&gt;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ul id=&quot;post&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;ul&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">PRE_RENDER</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">PRE_RENDER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/post&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rednder</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-15871">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;div id=&quot;container&quot;&gt;&lt;/div&gt;
&lt;script&gt;
  function render(posts, container) {
    const html = posts.reduce((html, post) =&gt; {
      return `${html}
        &lt;li&gt;
        &lt;h2&gt;${post.title}&lt;/h2&gt;
        &lt;p&gt;${post.content}&lt;/p&gt;
        &lt;/li&gt;
        `;
    }, &quot;&quot;);
    container.innerHTML = `&lt;ul id=&quot;post&quot;&gt;${html}&lt;ul&gt;`;
  }
  const container = document.querySelector(&quot;#container&quot;);
  const PRE_RENDER = document.querySelector(&quot;#post&quot;);
  if (!PRE_RENDER) {
    fetch(&quot;/post&quot;)
      .then((res) =&gt; res.json())
      .then((res) =&gt; rednder(res, container));
  }
&lt;/script&gt;
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-15871" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>继续优化-取消不必要的网络请求<br> ssr.js</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ssr</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setRequestInterception</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  page<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> whitlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;document&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;script&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fetch&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>whitelist<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">resourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> req<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760980-70491">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="async function ssr(url) {
  // ...
  await page.setRequestInterception(true);
  page.on(&quot;request&quot;, (req) =&gt; {
    const whitlist = [&quot;document&quot;, &quot;script&quot;, &quot;xhr&quot;, &quot;fetch&quot;];
    if (!whitelist.includes(req.resourceType())) {
      return req.abort();
    }
    req.continue();
  });
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760980-70491" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>思考-扩展骨架屏</li></ul><ol start="11"><li>测试代码覆盖率</li></ol><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;puppeteer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 开始收集JS和CSS文件的覆盖率信息</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>page<span class="token punctuation">.</span>coverage<span class="token punctuation">.</span><span class="token function">startJSCoverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span>coverage<span class="token punctuation">.</span><span class="token function">startCSSCoverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">&#39;https://www.baidu.com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">&#39;title&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 停止收集覆盖率信息</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>jsCoverage<span class="token punctuation">,</span> cssCoverage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    page<span class="token punctuation">.</span>coverage<span class="token punctuation">.</span><span class="token function">stopJSCoverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    page<span class="token punctuation">.</span>coverage<span class="token punctuation">.</span><span class="token function">stopCSSCoverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 根据覆盖率计算使用了多少字节</span>
  <span class="token keyword">const</span> <span class="token function-variable function">calculateUsedBytes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> coverage</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    coverage<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> ranges<span class="token punctuation">,</span> text <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> usedBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      ranges<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">range</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>usedBytes <span class="token operator">+=</span> range<span class="token punctuation">.</span>end <span class="token operator">-</span> range<span class="token punctuation">.</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        usedBytes<span class="token punctuation">,</span>
        totalBytes<span class="token operator">:</span> text<span class="token punctuation">.</span>length
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">...</span><span class="token function">calculateUsedBytes</span><span class="token punctuation">(</span><span class="token string">&#39;js&#39;</span><span class="token punctuation">,</span> jsCoverage<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">calculateUsedBytes</span><span class="token punctuation">(</span><span class="token string">&#39;css&#39;</span><span class="token punctuation">,</span> cssCoverage<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760981-63588">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const puppeteer = require(&#39;puppeteer&#39;);

(async () =&gt; {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  // 开始收集JS和CSS文件的覆盖率信息
  await Promise.all([page.coverage.startJSCoverage(), page.coverage.startCSSCoverage()]);

  await page.goto(&#39;https://www.baidu.com&#39;);
  await page.waitForSelector(&#39;title&#39;);

  // 停止收集覆盖率信息
  const [jsCoverage, cssCoverage] = await Promise.all([
    page.coverage.stopJSCoverage(),
    page.coverage.stopCSSCoverage()
  ]);

  // 根据覆盖率计算使用了多少字节
  const calculateUsedBytes = (type, coverage) =&gt;
    coverage.map(({ url, ranges, text }) =&gt; {
      let usedBytes = 0;

      ranges.forEach(range =&gt; (usedBytes += range.end - range.start - 1));

      return {
        url,
        type,
        usedBytes,
        totalBytes: text.length
      };
    });

  console.info([
    ...calculateUsedBytes(&#39;js&#39;, jsCoverage),
    ...calculateUsedBytes(&#39;css&#39;, cssCoverage)
  ]);

  await browser.close();
})();

" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760981-63588" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ol start="12"><li>代码注入</li><li>自动化测试扩展程序</li><li>AB测试</li><li>人机验证</li></ol><p><a href="https://filipvitas.medium.com/how-to-bypass-slider-captcha-with-js-and-puppeteer-cd5e28105e3c" target="_blank" rel="noopener noreferrer">https://filipvitas.medium.com/how-to-bypass-slider-captcha-with-js-and-puppeteer-cd5e28105e3c</a></p><p><a href="https://juejin.cn/post/6844903566289682440" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903566289682440</a></p><p><a href="https://juejin.cn/post/6844903860788527118" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903860788527118</a></p><p><a href="https://jsoverson.medium.com/bypassing-captchas-with-headless-chrome-93f294518337" target="_blank" rel="noopener noreferrer">https://jsoverson.medium.com/bypassing-captchas-with-headless-chrome-93f294518337</a></p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token constant">CRX</span> <span class="token operator">=</span> <span class="token string">&quot;/path/to/extension/&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  headless<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--disable-extensions-except=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CRX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--load-extension=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CRX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558760981-86440">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const CRX = &quot;/path/to/extension/&quot;;

const browser = await puppeteer.launch({
  headless: false,
  args: [`--disable-extensions-except=${CRX}`, `--load-extension=${CRX}`],
});
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558760981-86440" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><a href="https://peter.sh/experiments/chromium-command-line-switches/" target="_blank" rel="noopener noreferrer">有哪些启动参数</a></p><ol start="16"><li>爬虫<br><a href="https://github.com/artiely/koa2-vue/tree/master/server/crawler" target="_blank" rel="noopener noreferrer">https://github.com/artiely/koa2-vue/tree/master/server/crawler</a></li></ol><h2 id="可用于在线演示的网站"><a class="header-anchor" href="#可用于在线演示的网站" aria-hidden="true">#</a> 可用于在线演示的网站</h2><p><a href="https://try-puppeteer.appspot.com/" target="_blank" rel="noopener noreferrer">https://try-puppeteer.appspot.com/</a></p><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ul><li>网页截图或者生成 PDF</li><li>爬取 SPA 或 SSR 网站</li><li>UI 自动化测试，模拟表单提交，键盘输入，点击等行为</li><li>捕获网站的时间线，帮助诊断性能问题</li><li>创建一个最新的自动化测试环境，使用最新的 js 和最新的 Chrome 浏览器运行测试用例</li><li>测试 Chrome 扩展程序<br> ...</li></ul><h1 id="参考示例"><a class="header-anchor" href="#参考示例" aria-hidden="true">#</a> 参考示例</h1><p><a href="https://github.com/artiely/puppeteer-demo" target="_blank" rel="noopener noreferrer">https://github.com/artiely/puppeteer-demo</a></p><p><a href="https://github.com/puppeteer/examples" target="_blank" rel="noopener noreferrer">https://github.com/puppeteer/examples</a></p><h2 id="入门资料"><a class="header-anchor" href="#入门资料" aria-hidden="true">#</a> 入门资料</h2><p><a href="https://www.qikegu.com/docs/4531" target="_blank" rel="noopener noreferrer">https://www.qikegu.com/docs/4531</a></p><p><a href="https://juejin.cn/post/6844903605485453320" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903605485453320</a></p><h2 id="其他"><a class="header-anchor" href="#其他" aria-hidden="true">#</a> 其他</h2><p><a href="https://github.com/stereobooster/react-snap" target="_blank" rel="noopener noreferrer">https://github.com/stereobooster/react-snap</a></p><p><a href="https://github.com/g-plane/rize" target="_blank" rel="noopener noreferrer">https://github.com/g-plane/rize</a></p><p><a href="https://github.com/richshaw2015/wxapp-appium" target="_blank" rel="noopener noreferrer">https://github.com/richshaw2015/wxapp-appium</a></p></div></div></div><div class="footer"><div class="follow"><a href="https://github.com/artiely" target="_target" title="github"><i class="icon iconfont"></i></a><a href="https://gitee.com/artiely" target="_target" title="gitee"><i class="icon iconfont"></i></a><a href="https://www.npmjs.com/~artiely" target="_target" title="npm"><i class="icon iconfont"></i></a><a href="mailto:artiely1024@gmail.com" title="gmail"><i class="icon iconfont"></i></a><a href="https://www.youtube.com/channel/UC3U9zfLMepBqyQjlvEVhQDQ?view_as=subscriber" target="_target" title="youtube"><i class="icon iconfont"></i></a><a href="https://www.zhihu.com/people/artiely-19" target="_target" title="zhihu"><i class="icon iconfont"></i></a><a href="https://space.bilibili.com/31432769?spm_id_from=333.33.b_73656375726974794f75744c696e6b.1" target="_target" title="bilibili"><i class="icon iconfont"></i></a></div><p class="footer-copyright"> ©Artiely <span class="time">-2019-2021</span></p></div><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"9998b2fc\",\"about_index.md\":\"a4adb63e\",\"code_index.md\":\"674a914a\",\"comment_index.md\":\"a77e916d\",\"tags_index.md\":\"744d7d3d\",\"timeline_index.md\":\"93eb8477\",\"post_2017_2017-6-10-tcp.md\":\"c1558028\",\"post_2017_2017-6-6-css-1px.md\":\"84776839\",\"post_2017_2017-6-6-css-ios-android.md\":\"e5ca9b3f\",\"post_2017_2017-6-6-css-sticky-footer.md\":\"4ecfa988\",\"post_2017_2017-6-6-git.md\":\"17b762f3\",\"post_2017_2017-6-7-css-mobile-scroll-through.md\":\"4ae92986\",\"post_2017_2017-6-8-yahoo-rules14.md\":\"961088e8\",\"post_2017_2017-6-9-form-default-submit.md\":\"b117e54b\",\"post_2017_2017-7-4-moment.md\":\"071c32cc\",\"post_2017_2017-7-7-css-rules.md\":\"fd7195d5\",\"post_2017_2017-7-7-js-rules.md\":\"b6002462\",\"post_2017_2017-7-7-rules-file.md\":\"733aa196\",\"post_2017_2017-7-7-rules-html.md\":\"5970e012\",\"post_2019_2019-10-27-node-pm2.md\":\"9dea9f63\",\"post_2019_2019-10-3-alinode.md\":\"2e5f6b36\",\"post_2019_2019-11-16-nodejs-api.md\":\"4f1c1ab9\",\"post_2019_2019-4-15-nodejs-tcp-udp-h2.md\":\"379fd8f7\",\"post_2019_2019-4-16-vue-cli3+to-plugin.md\":\"85aeb114\",\"post_2019_2019-4-3-sentry-sourcemap.md\":\"7b901934\",\"post_2019_2019-4-3-vuepress-theme.md\":\"19e2d288\",\"post_2019_2019-5-5-restful-graphql.md\":\"94732c2e\",\"post_2019_2019-6-1-linux.md\":\"4cef58b9\",\"post_2019_2019-6-12-deploy.md\":\"78c69e77\",\"post_2019_2019-6-19-fontend-performance-optimization.md\":\"0debe8b8\",\"post_2019_2019-6-27-eslint-test.md\":\"ce1cdebb\",\"post_2019_2019-6-4-docker.md\":\"5acff5d9\",\"post_2019_2019-6-4-nodejs-events.md\":\"623e2a03\",\"post_2019_2019-6-6-css-fixedleft-autoright.md\":\"0897b7e5\",\"post_2019_2019-6-6-vue-observable.md\":\"3ac1f4b2\",\"post_2019_2019-7-13-automated-testing.md\":\"6a280ceb\",\"post_2019_2019-7-6-android-studio-flutter-shortcut.md\":\"12ebfedd\",\"post_2019_2019-7-6-dart-flutter-conf.md\":\"5f3410fb\",\"post_2019_2019-8-14-nosql.md\":\"3399ebe7\",\"post_2018_2018-1-30-centos-setup-nodejs.md\":\"452a4c82\",\"post_2018_2018-10-10-axios.md\":\"3dec5a88\",\"post_2018_2018-10-10-chrome-dev-tips.md\":\"e8fa3af3\",\"post_2018_2018-10-10-get-post.md\":\"51a41259\",\"post_2018_2018-10-10-git-green-pointer.md\":\"d4703242\",\"post_2018_2018-10-10-js-bit-operation.md\":\"c717ed75\",\"post_2018_2018-10-10-npm-nrm.md\":\"f050a24c\",\"post_2018_2018-10-10-pm2.md\":\"c82ff579\",\"post_2018_2018-10-10-vue-pracel.md\":\"2bfdaab2\",\"post_2018_2018-10-7-node-spider.md\":\"11cd813e\",\"post_2018_2018-3-12-nodejs-npm.md\":\"8893ba3a\",\"post_2018_2018-6-26-web-koa-egg.md\":\"aa036389\",\"post_2018_2018-6-9-nuxt.md\":\"37328df1\",\"post_2018_2018-7-10-electron-message.md\":\"2a996abd\",\"post_2018_2018-7-10-websocket.md\":\"334fd3c2\",\"post_2018_2018-7-11-electron-nedb.md\":\"ab5ef3fd\",\"post_2018_2018-7-11-electron-shortcut-cliboard-nativeimage.md\":\"32d137a9\",\"post_2018_2018-7-3-electron-init.md\":\"511fc155\",\"post_2018_2018-7-4-electron-base.md\":\"d2968da8\",\"post_2018_2018-7-5-electron-model.md\":\"7ac8d77b\",\"post_2018_2018-7-6-electron-menu-shortcut.md\":\"06c31808\",\"post_2018_2018-7-7-electron-main-render.md\":\"caff22b7\",\"post_2018_2018-7-8-electron-dialog.md\":\"7464f9f7\",\"post_2018_2018-7-8-electron-shell-url-webview.md\":\"cdc24223\",\"post_2018_2018-7-9-electron-ico.md\":\"d73c452e\",\"post_2018_2018-8-7-egg-start.md\":\"ea2ea984\",\"post_2018_2018-8-8-question.md\":\"472cdc1b\",\"post_2018_2018-8-8-vue-rules.md\":\"5c7b7172\",\"post_2018_2018-9-7-js.md\":\"9529455e\",\"post_2021_2021-1-3-puppeteer.md\":\"f0a96ae9\",\"post_2021_2021-2-23-proxy.md\":\"7784f428\",\"post_2021_2021-3-18-appleid.md\":\"e1cbcd9d\",\"post_2021_2021-6-15-mini.md\":\"a5960e5f\",\"post_2021_2021-7-23-pixijs.md\":\"57f2a55c\",\"post_2021_2021-8-15-resize-observer.md\":\"839df4de\",\"post_2021_2021-8-16-min-share.md\":\"27384dd8\",\"post_2020_2020-12-31-css.md\":\"aa6ee239\",\"post_2020_2020-3-16-chrome-plugin.md\":\"8aba482b\",\"post_2020_2020-3-16-vscode-plugin.md\":\"9cf3725a\",\"post_2020_2020-3-16-windows-plugin.md\":\"9ecffadb\",\"post_2020_2020-3-18-electron-mirror-down.md\":\"c0ab65b2\",\"post_2020_2020-3-18-electron-updater.md\":\"0425b8d2\",\"post_2020_2020-3-19-timer.js.md\":\"43ec431c\",\"post_2020_2020-3-20-antd-vue-pro.md\":\"78a60249\",\"post_2020_2020-3-20-js-how-to-work.md\":\"792e894c\",\"post_2020_2020-3-29-vuepress-plugin.md\":\"ff4d9769\",\"post_2020_2020-3-31-shituzhengmei.md\":\"41595376\",\"post_2020_2020-4-1-plupload.md\":\"b59258a7\",\"post_2020_2020-4-2-cmder.md\":\"7f1c6ace\",\"post_2020_2020-4-29-vue-hook-lifecycle.md\":\"1a278990\",\"post_2020_2020-4-4-yiqin.md\":\"4b5f1707\",\"post_2020_2020-4-6-plop.md\":\"7d2b2a6d\",\"post_2020_2020-5-22-ali-oss.md\":\"45d7320d\",\"post_2020_2020-5-29-axios.md\":\"8f0dc5da\",\"post_2020_2020-6-12-icon.md\":\"eaaeed39\",\"post_2020_2020-6-20-limit-chars.md\":\"b008e902\",\"post_2020_2020-6-23-charslimit.md\":\"527c6623\",\"post_2020_2020-6-25-custom-event.md\":\"6f6eeca0\",\"post_2020_2020-6-25-photo.md\":\"167ee8d7\",\"post_2020_2020-6-29-component.md\":\"979e3dd6\",\"post_2020_2020-6-5-01-vue-cli.md\":\"2f64961a\",\"post_2020_2020-6-5-02-vue-dir.md\":\"a82079b5\",\"post_2020_2020-6-5-03-vue-config.md\":\"f70aaf68\",\"post_2020_2020-6-5-04-vue.webpack.md\":\"468ae0e0\",\"post_2020_2020-6-5-05-env-mode.md\":\"cf00d8ee\",\"post_2020_2020-6-5-06-local-preview.md\":\"e2202055\",\"post_2020_2020-6-9-01-plugin.md\":\"4a125f90\",\"post_2020_2020-7-1-vue-api.md\":\"8c9bb4d1\",\"post_2020_2020-7-1-vuex-api.md\":\"3c6e4377\",\"post_2020_2020-7-13-madel.md\":\"077128f5\",\"post_2020_2020-7-14-share.md\":\"f8e4d9bc\",\"post_2020_2020-7-21-taro.md\":\"f3ed0a4e\",\"post_2020_2020-7-23-temp.md\":\"b1792a83\",\"post_2020_2020-7-9-thks-js.md\":\"703525c5\",\"post_2020_2020-8-17.md\":\"7af940ff\",\"post_2020_2020-8-27-frontend-css1.md\":\"87d5a4d4\",\"post_2020_2020-8-28-frontend-css2.md\":\"b01f25d1\",\"post_2020_2020-8-29-frontend-js1.md\":\"f990d677\",\"post_2020_2020-8-29-frontend-js2.md\":\"ec597485\",\"post_2020_2020-8-29-frontend-js3.md\":\"e8867844\",\"post_2020_2020-8-30-frontend-brower1.md\":\"fc765762\",\"post_2020_2020-8-30-frontend-brower2.md\":\"d41b6b87\",\"post_2020_2020-8-31-frontend-brower3.md\":\"cb7a5db1\",\"post_2020_2020-8-31-frontend-brower4.md\":\"c588c645\",\"post_2020_2020-9-1-fw.md\":\"ebc5dc13\",\"post_2020_2020-9-1-fw2.md\":\"eb0746a5\",\"post_2020_2020-9-15-js-arr.md\":\"82d4600f\",\"post_2020_2020-9-2-proxy.md\":\"3369143a\",\"post_2020_2020-9-24-interview.md\":\"7ac56a20\",\"post_2020_2020-9-3-brower.md\":\"eb1412ba\",\"post_2020_2020-9-5-what-happens.md\":\"495b1d50\",\"post_2020_2020-9-7-recursive.md\":\"ffcf737e\"}")</script>
    <script type="module" async src="/vitepress-blog/assets/app.b304d650.js"></script>
  </body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSocket | Artiely' blog</title>
    <meta name="description" content="随便玩玩">
    <link rel="stylesheet" href="/vitepress-blog/assets/style.04ecf5c6.css">
    <link rel="modulepreload" href="/vitepress-blog/assets/Home.00555797.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/lottie.42100ed3.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/lightgallery.es5.f43f3494.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/TextPlugin.8595634c.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/app.b304d650.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/post_2018_2018-7-10-websocket.md.334fd3c2.lean.js">
    <link rel="modulepreload" href="/vitepress-blog/assets/app.b304d650.js">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2707633_ayah6j2r7wi.css">
    <script type="text/javascript" src="/js/twikoo.js"></script>
    <meta name="twitter:title" content="WebSocket | Artiely&#39; blog">
    <meta property="og:title" content="WebSocket | Artiely&#39; blog">
  </head>
  <body>
    <div id="app"><!--[--><!----><!----><div class="content dark" style="height:100%;"><div style="position:relative;"><div><h1 id="websocket"><a class="header-anchor" href="#websocket" aria-hidden="true">#</a> WebSocket</h1><h2 id="介绍"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h2><p>现在，很多网站为了实现推送技术，所用的技术都是 Ajax 轮询。轮询是在特定的的时间间隔（如每1秒），由浏览器对服务器发出HTTP请求，然后由服务器返回最新的数据给客户端的浏览器。这种传统的模式带来很明显的缺点，即浏览器需要不断的向服务器发出请求，然而HTTP请求可能包含较长的头部，其中真正有效的数据可能只是很小的一部分，显然这样会浪费很多的带宽等资源。</p><p><img src="https://gitee.com/artiely/Figure-bed/raw/master/images/20200314170350.png" alt="img"></p><p>所以单向请求的缺点：</p><ul><li>无法监听连续状态变化 (HTTP无状态）</li><li>效率低</li><li>浪费资源</li></ul><p>HTML5 定义的 WebSocket 协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。</p><p>Websocket的常见应用：</p><ul><li>聊天室</li><li>消息系统：推送消息、实况、股票基金等实时变化的数据</li><li>点赞</li><li>直播评论（弹幕）</li><li>游戏</li><li>协同编辑/编辑</li><li>基于位置的应用</li><li>在线教育（多媒体聊天、文字消息）</li></ul><p><strong>学习路径：</strong></p><ul><li>了解Websocket基本概念 what</li><li>了解Websocket工作原理（解决的问题）Why</li><li>搭建Websocket服务 how</li><li>学习Websocket的基本使用 how</li><li>具体的Websocket应用（消息应用）</li></ul><p><strong>目标：</strong></p><ul><li>了解websocket基本工作原理</li><li>学会搭建websocket nodejs的服务端</li><li>学习使用websocket客户端</li><li>掌握常见的websocket方法、事件、属性</li><li>学生聊天室应用的编写</li></ul><p><strong>准备：</strong></p><ul><li><p>Linux服务器，或者虚拟机（Centos 7.x），安装Docker服务参见：<a href="https://www.daocloud.io/mirror" target="_blank" rel="noopener noreferrer">https://www.daocloud.io/mirror</a></p></li><li><p>域名：可以方便后面配置WSS，开发一些WSS的应用，比如小程序</p></li></ul><h2 id="websocket基础"><a class="header-anchor" href="#websocket基础" aria-hidden="true">#</a> Websocket基础</h2><p>WebSocket 协议在2008年诞生，2011年成为国际标准。所有浏览器都已经<a href="https://caniuse.com/#search=websocket" target="_blank" rel="noopener noreferrer">支持</a>了。</p><p><img src="https://gitee.com/artiely/Figure-bed/raw/master/images/20200314170351.png" alt="image-20191004220021412"></p><p>它的最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的<strong>双向平等</strong>对话，属于服务器推送技术的一种。</p><h3 id="基本概念"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h3><p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。</p><p>WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p><p>在 WebSocket API 中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p><p><img src="https://gitee.com/artiely/Figure-bed/raw/master/images/20200314170352.png" alt="img"></p><p>WebSocket特点：</p><p>（1）建立在 TCP 协议之上，服务器端的实现比较容易。</p><p>（2）与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</p><p>（3）数据格式比较轻量，性能开销小，通信高效。</p><p>（4）可以发送文本，也可以发送二进制数据。</p><p>（5）没有同源限制，客户端可以与任意服务器通信。</p><p>（6）协议标识符是<code>ws</code>（如果加密，则为<code>wss</code>），服务器网址就是 URL。</p><h3 id="websocket服务端"><a class="header-anchor" href="#websocket服务端" aria-hidden="true">#</a> WebSocket服务端</h3><p>常用的 Node 实现有以下几种。</p><ul><li><a href="https://github.com/websockets/ws" target="_blank" rel="noopener noreferrer">ws</a></li><li><a href="https://github.com/uWebSockets/uWebSockets" target="_blank" rel="noopener noreferrer">µWebSockets</a></li><li><a href="http://socket.io/" target="_blank" rel="noopener noreferrer">Socket.IO</a></li><li><a href="https://github.com/theturtle32/WebSocket-Node" target="_blank" rel="noopener noreferrer">WebSocket-Node</a></li></ul><h4 id="ws配置服务端"><a class="header-anchor" href="#ws配置服务端" aria-hidden="true">#</a> ws配置服务端</h4><div class="language-"><pre><code>npm install -S ws
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753834-16657">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="npm install -S ws
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753834-16657" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用<code>Wesocket.Server</code>方法，可以快速初始化服务端：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">incoming</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;received: %s&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&#39;something&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753834-29643">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const WebSocket = require(&#39;ws&#39;);

const wss = new WebSocket.Server({ port: 8080 });

wss.on(&#39;connection&#39;, function connection(ws) {
  ws.on(&#39;message&#39;, function incoming(message) {
    console.log(&#39;received: %s&#39;, message);
  });

  ws.send(&#39;something&#39;);
});
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753834-29643" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>客户端的例子：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 引用weboscket库</span>
<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&#39;ws://127.0.0.1:8080&#39;</span><span class="token punctuation">)</span>

ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;open&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&#39;Hello from client: &#39;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753834-5932">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 引用weboscket库
const WebSocket = require(&#39;ws&#39;);

const ws = new WebSocket(&#39;ws://127.0.0.1:8080&#39;)

ws.on(&#39;open&#39;, function () {
  for (var i = 0; i &lt; 3; i++) {
    ws.send(&#39;Hello from client: &#39; + i)
  }
  ws.on(&#39;message&#39;, function (msg) {
    console.log(msg)
  })
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753834-5932" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>一个复杂一点的配置：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
  perMessageDeflate<span class="token operator">:</span> <span class="token punctuation">{</span>
    zlibDeflateOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// See zlib defaults.</span>
      chunkSize<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
      memLevel<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    zlibInflateOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      chunkSize<span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Other options settable:</span>
    clientNoContextTakeover<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Defaults to negotiated value.</span>
    serverNoContextTakeover<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Defaults to negotiated value.</span>
    serverMaxWindowBits<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// Defaults to negotiated value.</span>
    <span class="token comment">// Below options specified as default values.</span>
    concurrencyLimit<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// Limits zlib concurrency for perf.</span>
    threshold<span class="token operator">:</span> <span class="token number">1024</span> <span class="token comment">// Size (in bytes) below which messages</span>
    <span class="token comment">// should not be compressed.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753834-94329">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const WebSocket = require(&#39;ws&#39;);

const wss = new WebSocket.Server({
  port: 8080,
  perMessageDeflate: {
    zlibDeflateOptions: {
      // See zlib defaults.
      chunkSize: 1024,
      memLevel: 7,
      level: 3
    },
    zlibInflateOptions: {
      chunkSize: 10 * 1024
    },
    // Other options settable:
    clientNoContextTakeover: true, // Defaults to negotiated value.
    serverNoContextTakeover: true, // Defaults to negotiated value.
    serverMaxWindowBits: 10, // Defaults to negotiated value.
    // Below options specified as default values.
    concurrencyLimit: 10, // Limits zlib concurrency for perf.
    threshold: 1024 // Size (in bytes) below which messages
    // should not be compressed.
  }
});
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753834-94329" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="socketio配置服务端"><a class="header-anchor" href="#socketio配置服务端" aria-hidden="true">#</a> socket.io配置服务端</h4><p>WebSocket是跟随HTML5一同提出的，所以在兼容性上存在问题，这时一个非常好用的库就登场了——<a href="https://socket.io/" target="_blank" rel="noopener noreferrer">Socket.io</a>。</p><p>socket.io封装了websocket，同时包含了其它的连接方式，你在任何浏览器里都可以使用socket.io来建立异步的连接。socket.io包含了服务端和客户端的库，如果在浏览器中使用了socket.io的js，服务端也必须同样适用。</p><p>socket.io是基于 Websocket 的Client-Server 实时通信库。</p><p>socket.io底层是基于engine.io这个库。engine.io为 <a href="http://socket.io" target="_blank" rel="noopener noreferrer">socket.io</a> 提供跨浏览器/跨设备的双向通信的底层库。engine.io使用了 Websocket 和 XHR 方式封装了一套 socket 协议。在低版本的浏览器中，不支持Websocket，为了兼容使用长轮询(polling)替代。</p><p><img src="https://gitee.com/artiely/Figure-bed/raw/master/images/20200314170353.png" alt="engine.io"></p><ul><li><p>socket.io服务端 http / express两个库</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;socket.io&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&#39;/index.html&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听连接</span>
io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;a socket is connected&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取客户端的消息</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;chat msg&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;msg from client: &#39;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息给客户端</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&#39;server says: &#39;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;server is running on: 3000&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753835-63539">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const app = require(&#39;express&#39;)()
const http = require(&#39;http&#39;).createServer(app)
const io = require(&#39;socket.io&#39;)(http)

app.get(&#39;/&#39;, function (req, res) {
  res.sendFile(__dirname + &#39;/index.html&#39;)
})

// 监听连接
io.on(&#39;connection&#39;, function (socket) {
  console.log(&#39;a socket is connected&#39;);
  // 获取客户端的消息
  socket.on(&#39;chat msg&#39;, function (msg) {
    console.log(&#39;msg from client: &#39; + msg);
    // 发送消息给客户端
    socket.send(&#39;server says: &#39; + msg)
  })
})

http.listen(3000, function () {
  console.log(&#39;server is running on: 3000&#39;)
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753835-63539" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li><li><p>客户端，需要引用<code>socket.io.js</code>，有两种方式去引用：（1）支持从socket.io.client中的dist中加载这个js （2）CDN</p><div class="language-js line-numbers-mode"><pre><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753840-71786">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;script src=&quot;https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  var socket = io();
&lt;/script&gt;
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753840-71786" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>客户端的仓库地址：<a href="https://github.com/socketio/socket.io-client" target="_blank" rel="noopener noreferrer">https://github.com/socketio/socket.io-client</a></p></li></ul><h3 id="websocket-api"><a class="header-anchor" href="#websocket-api" aria-hidden="true">#</a> WebSocket API</h3><p>浏览器通过 JavaScript 向服务器发出建立 WebSocket 连接的请求，连接建立以后，客户端和服务器端就可以通过 TCP 连接直接交换数据。</p><p>当你获取 Web Socket 连接后，你可以通过 <strong>send()</strong> 方法来向服务器发送数据，并通过 <strong>onmessage</strong> 事件来接收服务器返回的数据。</p><p>以下 API 用于创建 WebSocket 对象。</p><div class="language-"><pre><code>var Socket = new WebSocket(url, [protocol] );
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753840-28258">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="var Socket = new WebSocket(url, [protocol] );
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753840-28258" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上代码中的第一个参数 url, 指定连接的 URL。第二个参数 protocol 是可选的，指定了可接受的子协议。</p><h4 id="websocket属性"><a class="header-anchor" href="#websocket属性" aria-hidden="true">#</a> WebSocket属性</h4><p>以下是 WebSocket 对象的属性。假定我们使用了以上代码创建了 Socket 对象：</p><table><thead><tr><th style="text-align:left;">属性</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">Socket.readyState</td><td style="text-align:left;">只读属性 <strong>readyState</strong> 表示连接状态，可以是以下值：0 - 表示连接尚未建立。1 - 表示连接已建立，可以进行通信。2 - 表示连接正在进行关闭。3 - 表示连接已经关闭或者连接不能打开。</td></tr><tr><td style="text-align:left;">Socket.bufferedAmount</td><td style="text-align:left;">只读属性 <strong>bufferedAmount</strong> 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。</td></tr></tbody></table><h4 id="websocket-事件"><a class="header-anchor" href="#websocket-事件" aria-hidden="true">#</a> WebSocket 事件</h4><p>以下是 WebSocket 对象的相关事件。假定我们使用了以上代码创建了 Socket 对象：</p><table><thead><tr><th style="text-align:left;">事件</th><th style="text-align:left;">事件处理程序</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">open</td><td style="text-align:left;">Socket.onopen</td><td style="text-align:left;">连接建立时触发</td></tr><tr><td style="text-align:left;">message</td><td style="text-align:left;">Socket.onmessage</td><td style="text-align:left;">客户端接收服务端数据时触发</td></tr><tr><td style="text-align:left;">error</td><td style="text-align:left;">Socket.onerror</td><td style="text-align:left;">通信发生错误时触发</td></tr><tr><td style="text-align:left;">close</td><td style="text-align:left;">Socket.onclose</td><td style="text-align:left;">连接关闭时触发</td></tr></tbody></table><h4 id="websocket-方法"><a class="header-anchor" href="#websocket-方法" aria-hidden="true">#</a> WebSocket 方法</h4><p>以下是 WebSocket 对象的相关方法。假定我们使用了以上代码创建了 Socket 对象：</p><table><thead><tr><th style="text-align:left;">方法</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">Socket.send()</td><td style="text-align:left;">使用连接发送数据</td></tr><tr><td style="text-align:left;">Socket.close()</td><td style="text-align:left;">关闭连接</td></tr></tbody></table><h4 id="websocket-实例"><a class="header-anchor" href="#websocket-实例" aria-hidden="true">#</a> WebSocket 实例</h4><p>WebSocket 协议本质上是一个基于 TCP 的协议。</p><p>为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息&quot;Upgrade: WebSocket&quot;表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。</p><p><strong>客户端的 HTML 和 JavaScript</strong></p><p>目前大部分浏览器支持 WebSocket() 接口，你可以在以下浏览器中尝试实例： Chrome, Mozilla, Opera 和 Safari。</p><h2 id="websocket基础应用"><a class="header-anchor" href="#websocket基础应用" aria-hidden="true">#</a> Websocket基础应用</h2><h3 id="基本的应用"><a class="header-anchor" href="#基本的应用" aria-hidden="true">#</a> 基本的应用</h3><ul><li>如何广播消息</li><li>使用vue（调试版本&amp;正式版本）</li></ul><p>服务端：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">8000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;a new client is connected!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 广播到其他的客户端</span>
    wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 广播给非自己的其他客户端</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!==</span> ws <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753840-19766">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const WebSocket = require(&#39;ws&#39;)

const wss = new WebSocket.Server({ port: 8000 })

wss.on(&#39;connection&#39;, function (ws) {
  console.log(&#39;a new client is connected!&#39;);
  ws.on(&#39;message&#39;, function (msg) {
    // 广播到其他的客户端
    wss.clients.forEach(function each(client) {
      // 广播给非自己的其他客户端
      if (client !== ws &amp;&amp; client.readyState === WebSocket.OPEN) {
        client.send(msg);
      }
    });
  })
})
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753840-19766" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在浏览器侧：</p><div class="language-html line-numbers-mode"><pre><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/vue/dist/vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 显示消息 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in items<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          {{ item.message }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 发送消息 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ctrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputValue<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      {{ inputValue }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// 客户端的代码</span>
      <span class="token comment">// 1. 发送消息</span>
      <span class="token comment">// 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端</span>
      <span class="token comment">// 2. 显示消息</span>
      <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
          inputValue<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          items<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;Foo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;Bar&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          wsHandle<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 把元素挂载完成之后，自动执行</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:8000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onOpen<span class="token punctuation">;</span>
          <span class="token comment">// 服务端发送回来的其他消息</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onMessage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        methods<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">submit</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 取inputValue</span>
            <span class="token comment">// 通过websocket发送数据</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onOpen</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client is connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 把数据推送到items中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              message<span class="token operator">:</span> evt<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753840-70828">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot; /&gt;
    &lt;title&gt;Document&lt;/title&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;
      &lt;!-- 显示消息 --&gt;
      &lt;ul&gt;
        &lt;li v-for=&quot;item in items&quot;&gt;
          {{ item.message }}
        &lt;/li&gt;
      &lt;/ul&gt;
      &lt;!-- 发送消息 --&gt;
      &lt;div class=&quot;ctrl&quot;&gt;
        &lt;input type=&quot;text&quot; v-model=&quot;inputValue&quot; /&gt;
        &lt;button type=&quot;button&quot; @click=&quot;submit()&quot;&gt;发送&lt;/button&gt;
      &lt;/div&gt;
      {{ inputValue }}
    &lt;/div&gt;

    &lt;script&gt;
      // 客户端的代码
      // 1. 发送消息
      // 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端
      // 2. 显示消息
      var app = new Vue({
        el: &quot;#app&quot;,
        data: {
          inputValue: &quot;&quot;,
          items: [
            { message: &quot;Foo&quot; },
            { message: &quot;Bar&quot; },
            { message: &quot;demo&quot; },
          ],
          wsHandle: &quot;&quot;,
          name: &quot;&quot;,
        },
        // 把元素挂载完成之后，自动执行
        mounted() {
          var _this = this;
          this.wsHandle = new WebSocket(&quot;ws://localhost:8000&quot;);
          this.wsHandle.onopen = this.onOpen;
          // 服务端发送回来的其他消息
          this.wsHandle.onmessage = this.onMessage;
        },
        methods: {
          submit: function() {
            // 取inputValue
            // 通过websocket发送数据
            console.log(this.inputValue);
            this.wsHandle.send(this.inputValue);
            this.items.push({
              message: this.inputValue,
            });
            this.inputValue = &quot;&quot;;
          },
          onOpen: function() {
            console.log(&quot;client is connected&quot;);
          },
          onMessage: function(evt) {
            // 把数据推送到items中
            this.items.push({
              message: evt.data,
            });
          },
        },
      });
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;

" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753840-70828" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h3 id="欢迎语"><a class="header-anchor" href="#欢迎语" aria-hidden="true">#</a> 欢迎语</h3><div class="language-js line-numbers-mode"><pre><code>     <span class="token comment">// 客户端的代码</span>
      <span class="token comment">// 1. 发送消息</span>
      <span class="token comment">// 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端</span>
      <span class="token comment">// 2. 显示消息</span>
      <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
          isShow<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          inputValue<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          items<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          wsHandle<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          num<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 把元素挂载完成之后，自动执行</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:8000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onOpen<span class="token punctuation">;</span>
          <span class="token comment">// 服务端发送回来的其他消息</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onMessage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        methods<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">submit</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 取inputValue</span>
            <span class="token comment">// 通过websocket发送数据</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
              <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">into</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不得为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
              <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onOpen</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client is connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> msg<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                message<span class="token operator">:</span> <span class="token string">&quot;欢迎&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;加入聊天室！&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 把数据推送到items中</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                  message<span class="token operator">:</span> msg<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753841-51141">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="     // 客户端的代码
      // 1. 发送消息
      // 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端
      // 2. 显示消息
      var app = new Vue({
        el: &quot;#app&quot;,
        data: {
          isShow: true,
          inputValue: &quot;&quot;,
          items: [],
          wsHandle: &quot;&quot;,
          name: &quot;&quot;,
          num: 0,
        },
        // 把元素挂载完成之后，自动执行
        mounted() {
          var _this = this;
          this.wsHandle = new WebSocket(&quot;ws://localhost:8000&quot;);
          this.wsHandle.onopen = this.onOpen;
          // 服务端发送回来的其他消息
          this.wsHandle.onmessage = this.onMessage;
        },
        methods: {
          submit: function() {
            // 取inputValue
            // 通过websocket发送数据
            console.log(this.inputValue);
            this.wsHandle.send(
              JSON.stringify({
                name: this.name,
                message: this.inputValue,
              })
            );
            this.items.push({
              message: this.name + &quot;: &quot; + this.inputValue,
            });
            this.inputValue = &quot;&quot;;
          },
          into: function() {
            if (this.name.trim() === &quot;&quot;) {
              alert(&quot;用户名不得为空&quot;);
              return;
            }
            this.wsHandle.send(
              JSON.stringify({
                name: this.name,
              })
            );
            this.isShow = false;
          },
          onOpen: function() {
            console.log(&quot;client is connected&quot;);
          },
          onMessage: function(evt) {
            var msg = JSON.parse(evt.data);
            if (msg.num) {
              this.num = msg.num;
            }
            if (msg.name &amp;&amp; !msg.message) {
              this.items.push({
                message: &quot;欢迎&quot; + msg.name + &quot;加入聊天室！&quot;,
              });
            } else {
                // 把数据推送到items中
                this.items.push({
                  message: msg.name + &quot;: &quot; + msg.message,
                });
            }
          },
        },
      });
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753841-51141" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h3 id="退出时进行消息通知"><a class="header-anchor" href="#退出时进行消息通知" aria-hidden="true">#</a> 退出时进行消息通知</h3><ul><li>服务端广播消息</li><li>客户端针对不同的业务进行代码提示</li></ul><p>服务端：</p><div class="language-js line-numbers-mode"><pre><code>  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;one client is closed :&#39;</span> <span class="token operator">+</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ws<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 广播到其他的客户端</span>
      wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 广播给非自己的其他客户端</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!==</span> ws <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token operator">:</span> ws<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            event<span class="token operator">:</span> <span class="token string">&#39;logout&#39;</span><span class="token punctuation">,</span>
            num<span class="token operator">:</span> wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>size
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753842-55178">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="  ws.on(&#39;close&#39;, function () {
    console.log(&#39;one client is closed :&#39; + ws);
    if (typeof ws.name !== &#39;undefined&#39;) {
      // 广播到其他的客户端
      wss.clients.forEach(function each(client) {
        // 广播给非自己的其他客户端
        if (client !== ws &amp;&amp; client.readyState === WebSocket.OPEN) {
          client.send(JSON.stringify({
            name: ws.name,
            event: &#39;logout&#39;,
            num: wss.clients.size
          }));
        }
      });
    }
  })
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753842-55178" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>客户端：</p><div class="language-js line-numbers-mode"><pre><code>     <span class="token comment">// 客户端的代码</span>
      <span class="token comment">// 1. 发送消息</span>
      <span class="token comment">// 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端</span>
      <span class="token comment">// 2. 显示消息</span>
      <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
          isShow<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          inputValue<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          items<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          wsHandle<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          num<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 把元素挂载完成之后，自动执行</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:8000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onOpen<span class="token punctuation">;</span>
          <span class="token comment">// 服务端发送回来的其他消息</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onMessage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        methods<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">submit</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 取inputValue</span>
            <span class="token comment">// 通过websocket发送数据</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
              <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">,</span>
                event<span class="token operator">:</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inputValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">into</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不得为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
              <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                event<span class="token operator">:</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onOpen</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client is connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> msg<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                message<span class="token operator">:</span> <span class="token string">&quot;欢迎&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;加入聊天室！&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&quot;logout&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                message<span class="token operator">:</span> msg<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;已经退出了聊天室！&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 把数据推送到items中</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                  message<span class="token operator">:</span> msg<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753842-77148">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="     // 客户端的代码
      // 1. 发送消息
      // 客户端 取input数据 -&gt; websocket -&gt; 发送到服务端 -&gt; 转发给其他所有的客户端
      // 2. 显示消息
      var app = new Vue({
        el: &quot;#app&quot;,
        data: {
          isShow: true,
          inputValue: &quot;&quot;,
          items: [],
          wsHandle: &quot;&quot;,
          name: &quot;&quot;,
          num: 0,
        },
        // 把元素挂载完成之后，自动执行
        mounted() {
          var _this = this;
          this.wsHandle = new WebSocket(&quot;ws://localhost:8000&quot;);
          this.wsHandle.onopen = this.onOpen;
          // 服务端发送回来的其他消息
          this.wsHandle.onmessage = this.onMessage;
        },
        methods: {
          submit: function() {
            // 取inputValue
            // 通过websocket发送数据
            console.log(this.inputValue);
            this.wsHandle.send(
              JSON.stringify({
                name: this.name,
                message: this.inputValue,
                event: &quot;message&quot;,
              })
            );
            this.items.push({
              message: this.name + &quot;: &quot; + this.inputValue,
            });
            this.inputValue = &quot;&quot;;
          },
          into: function() {
            if (this.name.trim() === &quot;&quot;) {
              alert(&quot;用户名不得为空&quot;);
              return;
            }
            this.wsHandle.send(
              JSON.stringify({
                name: this.name,
                event: &quot;login&quot;,
              })
            );
            this.isShow = false;
          },
          onOpen: function() {
            console.log(&quot;client is connected&quot;);
          },
          onMessage: function(evt) {
            var msg = JSON.parse(evt.data);
            if (msg.num) {
              this.num = msg.num;
            }
            if (msg.event === &quot;login&quot;) {
              this.items.push({
                message: &quot;欢迎&quot; + msg.name + &quot;加入聊天室！&quot;,
              });
            } else if (msg.event === &quot;logout&quot;) {
              this.items.push({
                message: msg.name + &quot;已经退出了聊天室！&quot;,
              });
            } else {
              if (msg.name !== this.name) {
                // 把数据推送到items中
                this.items.push({
                  message: msg.name + &quot;: &quot; + msg.message,
                });
              }
            }
          },
        },
      });
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753842-77148" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h3 id="统计聊天人数"><a class="header-anchor" href="#统计聊天人数" aria-hidden="true">#</a> 统计聊天人数</h3><p>服务端：</p><div class="language-js line-numbers-mode"><pre><code>  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msgObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>name <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    <span class="token comment">// 广播到其他的客户端</span>
    wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      msgObj<span class="token punctuation">.</span>num <span class="token operator">=</span> wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>size
      <span class="token comment">// 广播给非自己的其他客户端</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753843-449">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="  ws.on(&#39;message&#39;, function (msg) {
    var msgObj = JSON.parse(msg)
    if (msgObj.name) {
      ws.name = msgObj.name
    }
    // 广播到其他的客户端
    wss.clients.forEach(function each(client) {
      msgObj.num = wss.clients.size
      // 广播给非自己的其他客户端
      if (client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify(msgObj));
      }
    });
  })
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753843-449" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>统计聊天人数：</p><ul><li>服务端把在线的clients数量返回给客户端</li><li>客户端接收消息（包括自己）</li></ul><h3 id="多个聊天室"><a class="header-anchor" href="#多个聊天室" aria-hidden="true">#</a> 多个聊天室</h3><ul><li>存储聊天室（会话） <ul><li>内存中进行存储</li><li>redis</li><li>redis + mongoDB</li><li>localstorage + 重连机制</li></ul></li><li>指定发送消息</li><li>统计在线人数</li></ul><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">var</span> group <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token comment">// console.log(&#39;a new client is connected!&#39;);</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msgObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>name <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ws<span class="token punctuation">.</span>roomid <span class="token operator">===</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>roomid <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>roomid
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span><span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 广播到其他的客户端</span>
    wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      msgObj<span class="token punctuation">.</span>num <span class="token operator">=</span> group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span> <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span>roomid <span class="token operator">===</span> ws<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// msgObj.num = wss.clients.size</span>
      <span class="token comment">// // 广播给非自己的其他客户端</span>
      <span class="token comment">// if (client.readyState === WebSocket.OPEN) {</span>
      <span class="token comment">//   client.send(JSON.stringify(msgObj));</span>
      <span class="token comment">// }</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>

  <span class="token comment">// 客户端断开链接</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(&#39;one client is closed :&#39; + ws);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ws<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 退出的用户，修改对应的在线客户端数据</span>
      group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span><span class="token operator">--</span>
      <span class="token comment">// 广播到其他的客户端</span>
      wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 广播给非自己的其他客户端</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!==</span> ws <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">.</span>roomid <span class="token operator">===</span> client<span class="token punctuation">.</span>roomid <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token operator">:</span> ws<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            event<span class="token operator">:</span> <span class="token string">&#39;logout&#39;</span><span class="token punctuation">,</span>
            num<span class="token operator">:</span> group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753843-29137">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="var group = {}

// ...
// console.log(&#39;a new client is connected!&#39;);
  ws.on(&#39;message&#39;, function (msg) {
    var msgObj = JSON.parse(msg)
    if (msgObj.name) {
      ws.name = msgObj.name
    }
    if (typeof ws.roomid === &#39;undefined&#39; &amp;&amp; msgObj.roomid) {
      ws.roomid = msgObj.roomid
      if (typeof group[ws.roomid] === &#39;undefined&#39;) {
        group[ws.roomid] = 1
      } else {
        group[ws.roomid]++
      }
    }
    // 广播到其他的客户端
    wss.clients.forEach(function each(client) {
      msgObj.num = group[ws.roomid]
      if (client.readyState === WebSocket.OPEN &amp;&amp; client.roomid === ws.roomid) {
        client.send(JSON.stringify(msgObj));
      }

      // msgObj.num = wss.clients.size
      // // 广播给非自己的其他客户端
      // if (client.readyState === WebSocket.OPEN) {
      //   client.send(JSON.stringify(msgObj));
      // }
    });
  })

// ...

  // 客户端断开链接
  ws.on(&#39;close&#39;, function () {
    // console.log(&#39;one client is closed :&#39; + ws);
    if (typeof ws.name !== &#39;undefined&#39;) {
      // 退出的用户，修改对应的在线客户端数据
      group[ws.roomid]--
      // 广播到其他的客户端
      wss.clients.forEach(function each(client) {
        // 广播给非自己的其他客户端
        if (client !== ws &amp;&amp; ws.roomid === client.roomid &amp;&amp; client.readyState === WebSocket.OPEN) {
          client.send(JSON.stringify({
            name: ws.name,
            event: &#39;logout&#39;,
            num: group[ws.roomid]
          }));
        }
      });
    }
  })
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753843-29137" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="心跳检测"><a class="header-anchor" href="#心跳检测" aria-hidden="true">#</a> 心跳检测</h3><ul><li>服务端：检测客户端的连接 -&gt; 定时器 -&gt; 超过指定时间 -&gt; 主动断开客户端的连接</li><li>客户端：设置定时器 -&gt; 如果超时或者服务端没有响应 ping/pong -&gt; 断开与服务端的连接</li></ul><p>服务端代码：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 消息处理  </span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token keyword">var</span> msgObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&#39;heartbeat&#39;</span> <span class="token operator">&amp;&amp;</span> msgObj<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">&#39;pong&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 计时器</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历所有的客户端，发送一个ping/pong消息</span>
  <span class="token comment">// 检测是否有返回，如果没有返回或者超时之后，主动断开与客户端的连接</span>
  wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws<span class="token punctuation">.</span>isAlive <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;client is disconneted!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      group<span class="token punctuation">[</span>ws<span class="token punctuation">.</span>roomid<span class="token punctuation">]</span><span class="token operator">--</span>
      <span class="token keyword">return</span> ws<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    ws<span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 主动发送ping/pong消息</span>
    <span class="token comment">// 客户端返回了之后，主动设置isAlive的状态</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      event<span class="token operator">:</span> <span class="token string">&#39;heartbeat&#39;</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&#39;ping&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> timeInterval<span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753844-49997">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 消息处理  
ws.on(&#39;message&#39;, function (msg) {
    // ...
  var msgObj = JSON.parse(msg)
  if (msgObj.event === &#39;heartbeat&#39; &amp;&amp; msgObj.message === &#39;pong&#39;) {
    ws.isAlive = true
    return
  }
  // ...
})

// 计时器
const interval = setInterval(function () {
  // 遍历所有的客户端，发送一个ping/pong消息
  // 检测是否有返回，如果没有返回或者超时之后，主动断开与客户端的连接
  wss.clients.forEach(function each(ws) {
    if (ws.isAlive === false) {
      console.log(&#39;client is disconneted!&#39;);
      group[ws.roomid]--
      return ws.terminate()
    }

    ws.isAlive = false
    // 主动发送ping/pong消息
    // 客户端返回了之后，主动设置isAlive的状态
    ws.send(JSON.stringify({
      event: &#39;heartbeat&#39;,
      message: &#39;ping&#39;
    }))
  })
}, timeInterval)
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753844-49997" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>客户端的代码：</p><div class="language-js line-numbers-mode"><pre><code><span class="token function-variable function">onOpen</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 连接创建之时</span>
  <span class="token comment">// 设置定时器 -&gt; 如果超时或者服务端没有响应 ping/pong -&gt; 断开与服务端的连接</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client is connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 心跳检测</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&quot;heartbeat&quot;</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        event<span class="token operator">:</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定时器方法</span>
<span class="token function-variable function">checkServer</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;checkServer in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 计时器去定时检测websocket的连接</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 超时之后，即会执行</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;checkServer fail, close websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 主动断开服务器端的连接</span>
    _this<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753844-56730">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="onOpen: function() {
  // 连接创建之时
  // 设置定时器 -&gt; 如果超时或者服务端没有响应 ping/pong -&gt; 断开与服务端的连接
  console.log(&quot;client is connected&quot;);
  this.checkServer();
},

onMessage: function () {
  // 心跳检测
  if (msg.event === &quot;heartbeat&quot; &amp;&amp; msg.message === &quot;ping&quot;) {
    this.checkServer();
    this.wsHandle.send(
      JSON.stringify({
        event: &quot;heartbeat&quot;,
        message: &quot;pong&quot;,
      })
    );
    return;
  }
  //...
}

// 定时器方法
checkServer: function() {
  console.log(&quot;checkServer in&quot;);
  // 计时器去定时检测websocket的连接
  var _this = this;
  clearTimeout(this.handler);
  // 超时之后，即会执行
  this.handler = setTimeout(function() {
    console.log(&quot;checkServer fail, close websocket&quot;);
    // 主动断开服务器端的连接
    _this.onClose();
  }, 5000 + 1000);
},
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753844-56730" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="ws中的鉴权"><a class="header-anchor" href="#ws中的鉴权" aria-hidden="true">#</a> ws中的鉴权</h3><p>鉴权机制设计:</p><p>使用jsonwebtoken（jwt）方式进行鉴权：</p><p>服务端：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 在message事件内部</span>
    <span class="token comment">// 鉴权机制 -&gt; 检验token的有效性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&#39;auth&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;msg auth is: &#39;</span> <span class="token operator">+</span> msgObj<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token comment">// 拿到token,并且去校验时效性</span>
      jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token string">&#39;secret&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> decode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// websocket返回前台一个消息</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;auth error&#39;</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 鉴权通过的逻辑</span>
          <span class="token comment">// 这里可以拿到decode，即payload里面的内容</span>
          ws<span class="token punctuation">.</span>isAuth <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 拦截，非鉴权的请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ws<span class="token punctuation">.</span>isAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 去给客户端发送重新鉴权的消息</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        event<span class="token operator">:</span> <span class="token string">&#39;noauth&#39;</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">&#39;please auth again, your token is expired!&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753844-90988">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 在message事件内部
    // 鉴权机制 -&gt; 检验token的有效性
    if (msgObj.event === &#39;auth&#39;) {
      console.log(&#39;msg auth is: &#39; + msgObj.message)
      // 拿到token,并且去校验时效性
      jwt.verify(msgObj.message, &#39;secret&#39;, function (err, decode) {
        if (err) {
          // websocket返回前台一个消息
          console.log(&#39;auth error&#39;)
          return
        } else {
          // 鉴权通过的逻辑
          // 这里可以拿到decode，即payload里面的内容
          ws.isAuth = true
          return
        }
        console.log(JSON.stringify(decode));
      })
    }
    // 拦截，非鉴权的请求
    if (!ws.isAuth) {
      // 去给客户端发送重新鉴权的消息
      ws.send(JSON.stringify({
        event: &#39;noauth&#39;,
        message: &#39;please auth again, your token is expired!&#39;
      }))
      return
    }
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753844-90988" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>客户端：</p><div class="language-js line-numbers-mode"><pre><code><span class="token function-variable function">onOpen</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 连接创建之时</span>
  <span class="token comment">// 设置定时器 -&gt; 如果超时或者服务端没有响应 ping/pong -&gt; 断开与服务端的连接</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client is connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送鉴权token，token -&gt; expire</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  event<span class="token operator">:</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> <span class="token comment">// localstorage, cookie/session -&gt; koa/express</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 主动鉴权</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753845-80548">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="onOpen: function() {
  // 连接创建之时
  // 设置定时器 -&gt; 如果超时或者服务端没有响应 ping/pong -&gt; 断开与服务端的连接
  console.log(&quot;client is connected&quot;);
  this.checkServer();
  // 发送鉴权token，token -&gt; expire
  const data = {
  event: &quot;auth&quot;,
  message: &quot;token&quot;, // localstorage, cookie/session -&gt; koa/express
  };
  // 主动鉴权
  this.wsHandle.send(JSON.stringify(data));
},
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753845-80548" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="websocket中的断线重连"><a class="header-anchor" href="#websocket中的断线重连" aria-hidden="true">#</a> Websocket中的断线重连</h3><ul><li><p>监听error事件</p></li><li><p>使用reconnect-websocket库：</p><ul><li>es6:<a href="https://www.npmjs.com/package/reconnecting-websocket" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/reconnecting-websocket</a></li></ul><p>使用方法：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">import</span> ReconnectingWebSocket <span class="token keyword">from</span> <span class="token string">&#39;reconnecting-websocket&#39;</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> rws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReconnectingWebSocket</span><span class="token punctuation">(</span><span class="token string">&#39;ws://my.site.com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
rws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;open&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    rws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&#39;hello!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753845-66350">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="import ReconnectingWebSocket from &#39;reconnecting-websocket&#39;;
 
const rws = new ReconnectingWebSocket(&#39;ws://my.site.com&#39;);
 
rws.addEventListener(&#39;open&#39;, () =&gt; {
    rws.send(&#39;hello!&#39;);
});
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753845-66350" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>es5: <a href="https://github.com/joewalnes/reconnecting-websocket" target="_blank" rel="noopener noreferrer">https://github.com/joewalnes/reconnecting-websocket</a></li></ul><p>使用方法：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReconnectingWebSocket</span><span class="token punctuation">(</span><span class="token string">&#39;ws://....&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753845-1986">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="var ws = new ReconnectingWebSocket(&#39;ws://....&#39;);
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753845-1986" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul><h3 id="websocket与redis结合"><a class="header-anchor" href="#websocket与redis结合" aria-hidden="true">#</a> Websocket与Redis结合</h3><p>Redis：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;redis&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> promisifyAll <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;bluebird&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> redisOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config/index&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span>redisOptions<span class="token punctuation">)</span>
<span class="token function">promisifyAll</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">)</span>

<span class="token comment">// 对连接信息的监听</span>
redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connect&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;redis client is connected to server!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 对错误日志的打印</span>
redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;redis client is error: &quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * setValue方法
 * @param {String} key 对象的属性
 * @param {String} value 对象的值 JSON.stringfy -&gt; Object
 * @param {*} time 过期时间
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">setValue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">&quot;EX&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    redisClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * getValue方法
 * @param {String} key
 * 返回是一个String，需要对对象形式的内容，使用JSON.parse
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 增加记数
 * @param {String}} key
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">increase</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">incrAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">decrease</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">decrAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回所有相关reg的keys
 * @param {String} reg 定义一个查询的正则表达式
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">getKeys</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">keysAsync</span><span class="token punctuation">(</span>reg <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">existKey</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">existsAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">deleteKey</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> redisClient<span class="token punctuation">.</span><span class="token function">delAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  setValue<span class="token punctuation">,</span>
  getValue<span class="token punctuation">,</span>
  increase<span class="token punctuation">,</span>
  decrease<span class="token punctuation">,</span>
  getKeys<span class="token punctuation">,</span>
  existKey<span class="token punctuation">,</span>
  deleteKey<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753845-31825">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const redis = require(&quot;redis&quot;)
const { promisifyAll } = require(&quot;bluebird&quot;)

const { redisOptions } = require(&quot;../config/index&quot;)

const redisClient = redis.createClient(redisOptions)
promisifyAll(redisClient)

// 对连接信息的监听
redisClient.on(&quot;connect&quot;, function() {
  console.log(&quot;redis client is connected to server!&quot;)
})

// 对错误日志的打印
redisClient.on(&quot;error&quot;, function(err) {
  console.log(&quot;redis client is error: &quot; + err)
})

/**
 * setValue方法
 * @param {String} key 对象的属性
 * @param {String} value 对象的值 JSON.stringfy -&gt; Object
 * @param {*} time 过期时间
 */
const setValue = function(key, value, time) {
  if (time) {
    redisClient.set(key, value, &quot;EX&quot;, time, redis.print)
  } else {
    redisClient.set(key, value, redis.print)
  }
}

/**
 * getValue方法
 * @param {String} key
 * 返回是一个String，需要对对象形式的内容，使用JSON.parse
 */
const getValue = async function(key) {
  const result = await redisClient.getAsync(key)
  return result
}

/**
 * 增加记数
 * @param {String}} key
 */
const increase = async function(key) {
  const result = await redisClient.incrAsync(key)
  return result
}

const decrease = async function(key) {
  const result = await redisClient.decrAsync(key)
  return result
}

/**
 * 返回所有相关reg的keys
 * @param {String} reg 定义一个查询的正则表达式
 */
const getKeys = async function(reg) {
  const result = await redisClient.keysAsync(reg + &quot;*&quot;)
  return result
}

const existKey = async function(key) {
  const result = await redisClient.existsAsync(key)
  return result
}

const deleteKey = async function(key) {
  const result = await redisClient.delAsync(key)
  return result
}

module.exports = {
  setValue,
  getValue,
  increase,
  decrease,
  getKeys,
  existKey,
  deleteKey,
}
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753845-31825" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h3 id="离线消息缓存发送"><a class="header-anchor" href="#离线消息缓存发送" aria-hidden="true">#</a> 离线消息缓存发送</h3><p>客户端：</p><ul><li>设置uid，确定ws唯一的标识</li><li>断线重连后，发送roomid与uid</li></ul><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span>
  <span class="token keyword">const</span> uid <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不得为空&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>wsHandle<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    roomid<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>roomid<span class="token punctuation">,</span>
    uid<span class="token operator">:</span> uid<span class="token punctuation">,</span>
    event<span class="token operator">:</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">false</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753846-21979">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const urlParams = new URLSearchParams(window.location.search)
  const uid = urlParams.get(&quot;uid&quot;)
  if (this.name.trim() === &quot;&quot;) {
  alert(&quot;用户名不得为空&quot;)
  return
}
this.wsHandle.send(
  JSON.stringify({
    name: this.name,
    roomid: this.roomid,
    uid: uid,
    event: &quot;login&quot;,
  })
)
this.isShow = false
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753846-21979" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>服务端：</p><ul><li>使用redis进行消息的缓存</li><li>对客户端的连接进行唯一性标识</li><li>对于断开连接的客户端，离线消息进行保存</li><li>再次连接过来的客户端，发送离线消息</li></ul><div class="language-js line-numbers-mode"><pre><code>wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ws<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化客户端的连接状态量</span>
  ws<span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment">// console.log(&#39;a new client is connected!&#39;);</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msgObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&quot;heartbeat&quot;</span> <span class="token operator">&amp;&amp;</span> msgObj<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>name <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgObj<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span>uid <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>uid
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ws<span class="token punctuation">.</span>roomid <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 还需要一个客户端的标识，可以知道ws给谁去发送消息</span>
      ws<span class="token punctuation">.</span>roomid <span class="token operator">=</span> msgObj<span class="token punctuation">.</span>roomid
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">existKey</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化数据</span>
        <span class="token function">setValue</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">,</span> ws<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> arrStr <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span>
        <span class="token comment">// String -&gt; Json</span>
        <span class="token keyword">let</span> arr <span class="token operator">=</span> arrStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          arrStr <span class="token operator">+=</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> ws<span class="token punctuation">.</span>uid
          <span class="token function">setValue</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> msgObj<span class="token punctuation">.</span>roomid<span class="token punctuation">,</span> arrStr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 广播到其他的客户端</span>
    <span class="token keyword">let</span> arrStr1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> ws<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span>
    <span class="token keyword">let</span> arr1 <span class="token operator">=</span> arrStr1<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 在线人数，计算uid的个数</span>
    msgObj<span class="token punctuation">.</span>total <span class="token operator">=</span> arr1<span class="token punctuation">.</span>length
    msgObj<span class="token punctuation">.</span>num <span class="token operator">=</span> wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>size
    wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span> <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span>roomid <span class="token operator">===</span> ws<span class="token punctuation">.</span>roomid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 删除已经发送了消息的对应的对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          arr1<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>arr1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">existKey</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> tmpArr <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
          <span class="token keyword">let</span> tmpObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>tmpArr<span class="token punctuation">)</span>
          <span class="token keyword">let</span> uid <span class="token operator">=</span> ws<span class="token punctuation">.</span>uid
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpObj<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment">// 遍历数组，判断是否是同一个roomid，否则的话，就保存数据</span>
            tmpObj<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>roomid <span class="token operator">===</span> client<span class="token punctuation">.</span>roomid <span class="token operator">&amp;&amp;</span> uid <span class="token operator">===</span> client<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果是同一个roomid，就发送对应的消息数据。</span>
                client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
                i<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              i<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tmpObj<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">setValue</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tmpObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 判断，是否有客户端没有连接。</span>
      <span class="token comment">// 对于没有连接的客户端的数据，进行分发缓存处理</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 说明有一些客户端断开了与roomid的连接，并且，其他客户端发送了对应的消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr1<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> msgObj<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr1<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">existKey</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> udata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
          <span class="token keyword">let</span> uObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>udata<span class="token punctuation">)</span>
          uObj<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            roomid<span class="token operator">:</span> ws<span class="token punctuation">.</span>roomid<span class="token punctuation">,</span>
            msg<span class="token operator">:</span> msgObj<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token function">setValue</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>uObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 说明先前，这个数据没有进行缓存 ，没有记录</span>
          <span class="token function">setValue</span><span class="token punctuation">(</span>
            item<span class="token punctuation">,</span>
            <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                roomid<span class="token operator">:</span> ws<span class="token punctuation">.</span>roomid<span class="token punctuation">,</span>
                msg<span class="token operator">:</span> msgObj<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753846-41160">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="wss.on(&quot;connection&quot;, function(ws, req) {
  // 初始化客户端的连接状态量
  ws.isAlive = true

  // console.log(&#39;a new client is connected!&#39;);
  ws.on(&quot;message&quot;, async function(msg) {
    var msgObj = JSON.parse(msg)
    if (msgObj.event === &quot;heartbeat&quot; &amp;&amp; msgObj.message === &quot;pong&quot;) {
      ws.isAlive = true
      return
    }
    if (msgObj.name) {
      ws.name = msgObj.name
    }
    if (msgObj.uid) {
      ws.uid = msgObj.uid
    }
    if (typeof ws.roomid === &quot;undefined&quot; &amp;&amp; msgObj.roomid) {
      // 还需要一个客户端的标识，可以知道ws给谁去发送消息
      ws.roomid = msgObj.roomid
      const result = await existKey(prefix + msgObj.roomid)
      if (result === 0) {
        // 初始化数据
        setValue(prefix + msgObj.roomid, ws.uid)
      } else {
        let arrStr = await getValue(prefix + msgObj.roomid)
        // String -&gt; Json
        let arr = arrStr.split(&quot;,&quot;)
        if (arr.indexOf(ws.uid) === -1) {
          arrStr += &quot;,&quot; + ws.uid
          setValue(prefix + msgObj.roomid, arrStr)
        }
      }
    }
    // 广播到其他的客户端
    let arrStr1 = await getValue(prefix + ws.roomid)
    let arr1 = arrStr1.split(&quot;,&quot;)
    // 在线人数，计算uid的个数
    msgObj.total = arr1.length
    msgObj.num = wss.clients.size
    wss.clients.forEach(async function each(client) {
      if (client.readyState === WebSocket.OPEN &amp;&amp; client.roomid === ws.roomid) {
        client.send(JSON.stringify(msgObj))
        // 删除已经发送了消息的对应的对象
        if (arr1.indexOf(client.uid) !== -1) {
          arr1.splice(arr1.indexOf(client.uid), 1)
        }
        let result = await existKey(ws.uid)
        if (result !== 0) {
          let tmpArr = await getValue(ws.uid)
          let tmpObj = JSON.parse(tmpArr)
          let uid = ws.uid
          if (tmpObj.length &gt; 0) {
            let i = []
            // 遍历数组，判断是否是同一个roomid，否则的话，就保存数据
            tmpObj.forEach(function(item) {
              if (item.roomid === client.roomid &amp;&amp; uid === client.uid) {
                // 如果是同一个roomid，就发送对应的消息数据。
                client.send(JSON.stringify(item.msg))
                i.push(item)
              }
            })
            if (i.length &gt; 0) {
              i.forEach(function(item) {
                tmpObj.splice(item, 1)
              })
            }
            setValue(ws.uid, JSON.stringify(tmpObj))
          }
        }
      }
      // 判断，是否有客户端没有连接。
      // 对于没有连接的客户端的数据，进行分发缓存处理
    })

    // 说明有一些客户端断开了与roomid的连接，并且，其他客户端发送了对应的消息
    if (arr1.length &gt; 0 &amp;&amp; msgObj.event === &quot;message&quot;) {
      arr1.forEach(async function(item) {
        const result = await existKey(item)
        if (result !== 0) {
          let udata = await getValue(item)
          let uObj = JSON.parse(udata)
          uObj.push({
            roomid: ws.roomid,
            msg: msgObj,
          })
          setValue(item, JSON.stringify(uObj))
        } else {
          // 说明先前，这个数据没有进行缓存 ，没有记录
          setValue(
            item,
            JSON.stringify([
              {
                roomid: ws.roomid,
                msg: msgObj,
              },
            ])
          )
        }
      })
    }
  })
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753846-41160" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br></div></div><h2 id="websocket-ssl配置"><a class="header-anchor" href="#websocket-ssl配置" aria-hidden="true">#</a> Websocket SSL配置</h2><h3 id="配置httpswss"><a class="header-anchor" href="#配置httpswss" aria-hidden="true">#</a> 配置HTTPS/WSS</h3><p>如何配置HTTPS/WSS：</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;https&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cert<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&#39;/path/to/cert.pem&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&#39;/path/to/key.pem&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">incoming</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;received: %s&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&#39;something&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1629558753847-53123">复制成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const fs = require(&#39;fs&#39;);
const https = require(&#39;https&#39;);
const WebSocket = require(&#39;ws&#39;);

const server = https.createServer({
  cert: fs.readFileSync(&#39;/path/to/cert.pem&#39;),
  key: fs.readFileSync(&#39;/path/to/key.pem&#39;)
});
const wss = new WebSocket.Server({ server });

wss.on(&#39;connection&#39;, function connection(ws) {
  ws.on(&#39;message&#39;, function incoming(message) {
    console.log(&#39;received: %s&#39;, message);
  });

  ws.send(&#39;something&#39;);
});

server.listen(8080);
" data-mdic-attach-content="copyright | [artiely]" data-mdic-notify-id="j-notify-1629558753847-53123" data-mdic-notify-delay="1000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t=&#39;&#39;,e=&#39;&#39;)=&gt;new Promise((c,o)=&gt;{const n=document.createElement(&#39;textarea&#39;),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand(&#39;copy&#39;);document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display=&#39;block&#39;,setTimeout(()=&gt;{n.style.display=&#39;none&#39;},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制</button></div></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="其他资料"><a class="header-anchor" href="#其他资料" aria-hidden="true">#</a> 其他资料</h2><h3 id="参考资料"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h3><ul><li><a href="https://medium.com/factory-mind/websocket-node-js-express-step-by-step-using-typescript-725114ad5fe4" target="_blank" rel="noopener noreferrer">WebSocket + Node.js + Express — Step by step tutorial using Typescript</a></li></ul></div></div></div><div class="footer"><div class="follow"><a href="https://github.com/artiely" target="_target" title="github"><i class="icon iconfont"></i></a><a href="https://gitee.com/artiely" target="_target" title="gitee"><i class="icon iconfont"></i></a><a href="https://www.npmjs.com/~artiely" target="_target" title="npm"><i class="icon iconfont"></i></a><a href="mailto:artiely1024@gmail.com" title="gmail"><i class="icon iconfont"></i></a><a href="https://www.youtube.com/channel/UC3U9zfLMepBqyQjlvEVhQDQ?view_as=subscriber" target="_target" title="youtube"><i class="icon iconfont"></i></a><a href="https://www.zhihu.com/people/artiely-19" target="_target" title="zhihu"><i class="icon iconfont"></i></a><a href="https://space.bilibili.com/31432769?spm_id_from=333.33.b_73656375726974794f75744c696e6b.1" target="_target" title="bilibili"><i class="icon iconfont"></i></a></div><p class="footer-copyright"> ©Artiely <span class="time">-2019-2021</span></p></div><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"9998b2fc\",\"about_index.md\":\"a4adb63e\",\"code_index.md\":\"674a914a\",\"comment_index.md\":\"a77e916d\",\"tags_index.md\":\"744d7d3d\",\"timeline_index.md\":\"93eb8477\",\"post_2017_2017-6-10-tcp.md\":\"c1558028\",\"post_2017_2017-6-6-css-1px.md\":\"84776839\",\"post_2017_2017-6-6-css-ios-android.md\":\"e5ca9b3f\",\"post_2017_2017-6-6-css-sticky-footer.md\":\"4ecfa988\",\"post_2017_2017-6-6-git.md\":\"17b762f3\",\"post_2017_2017-6-7-css-mobile-scroll-through.md\":\"4ae92986\",\"post_2017_2017-6-8-yahoo-rules14.md\":\"961088e8\",\"post_2017_2017-6-9-form-default-submit.md\":\"b117e54b\",\"post_2017_2017-7-4-moment.md\":\"071c32cc\",\"post_2017_2017-7-7-css-rules.md\":\"fd7195d5\",\"post_2017_2017-7-7-js-rules.md\":\"b6002462\",\"post_2017_2017-7-7-rules-file.md\":\"733aa196\",\"post_2017_2017-7-7-rules-html.md\":\"5970e012\",\"post_2019_2019-10-27-node-pm2.md\":\"9dea9f63\",\"post_2019_2019-10-3-alinode.md\":\"2e5f6b36\",\"post_2019_2019-11-16-nodejs-api.md\":\"4f1c1ab9\",\"post_2019_2019-4-15-nodejs-tcp-udp-h2.md\":\"379fd8f7\",\"post_2019_2019-4-16-vue-cli3+to-plugin.md\":\"85aeb114\",\"post_2019_2019-4-3-sentry-sourcemap.md\":\"7b901934\",\"post_2019_2019-4-3-vuepress-theme.md\":\"19e2d288\",\"post_2019_2019-5-5-restful-graphql.md\":\"94732c2e\",\"post_2019_2019-6-1-linux.md\":\"4cef58b9\",\"post_2019_2019-6-12-deploy.md\":\"78c69e77\",\"post_2019_2019-6-19-fontend-performance-optimization.md\":\"0debe8b8\",\"post_2019_2019-6-27-eslint-test.md\":\"ce1cdebb\",\"post_2019_2019-6-4-docker.md\":\"5acff5d9\",\"post_2019_2019-6-4-nodejs-events.md\":\"623e2a03\",\"post_2019_2019-6-6-css-fixedleft-autoright.md\":\"0897b7e5\",\"post_2019_2019-6-6-vue-observable.md\":\"3ac1f4b2\",\"post_2019_2019-7-13-automated-testing.md\":\"6a280ceb\",\"post_2019_2019-7-6-android-studio-flutter-shortcut.md\":\"12ebfedd\",\"post_2019_2019-7-6-dart-flutter-conf.md\":\"5f3410fb\",\"post_2019_2019-8-14-nosql.md\":\"3399ebe7\",\"post_2018_2018-1-30-centos-setup-nodejs.md\":\"452a4c82\",\"post_2018_2018-10-10-axios.md\":\"3dec5a88\",\"post_2018_2018-10-10-chrome-dev-tips.md\":\"e8fa3af3\",\"post_2018_2018-10-10-get-post.md\":\"51a41259\",\"post_2018_2018-10-10-git-green-pointer.md\":\"d4703242\",\"post_2018_2018-10-10-js-bit-operation.md\":\"c717ed75\",\"post_2018_2018-10-10-npm-nrm.md\":\"f050a24c\",\"post_2018_2018-10-10-pm2.md\":\"c82ff579\",\"post_2018_2018-10-10-vue-pracel.md\":\"2bfdaab2\",\"post_2018_2018-10-7-node-spider.md\":\"11cd813e\",\"post_2018_2018-3-12-nodejs-npm.md\":\"8893ba3a\",\"post_2018_2018-6-26-web-koa-egg.md\":\"aa036389\",\"post_2018_2018-6-9-nuxt.md\":\"37328df1\",\"post_2018_2018-7-10-electron-message.md\":\"2a996abd\",\"post_2018_2018-7-10-websocket.md\":\"334fd3c2\",\"post_2018_2018-7-11-electron-nedb.md\":\"ab5ef3fd\",\"post_2018_2018-7-11-electron-shortcut-cliboard-nativeimage.md\":\"32d137a9\",\"post_2018_2018-7-3-electron-init.md\":\"511fc155\",\"post_2018_2018-7-4-electron-base.md\":\"d2968da8\",\"post_2018_2018-7-5-electron-model.md\":\"7ac8d77b\",\"post_2018_2018-7-6-electron-menu-shortcut.md\":\"06c31808\",\"post_2018_2018-7-7-electron-main-render.md\":\"caff22b7\",\"post_2018_2018-7-8-electron-dialog.md\":\"7464f9f7\",\"post_2018_2018-7-8-electron-shell-url-webview.md\":\"cdc24223\",\"post_2018_2018-7-9-electron-ico.md\":\"d73c452e\",\"post_2018_2018-8-7-egg-start.md\":\"ea2ea984\",\"post_2018_2018-8-8-question.md\":\"472cdc1b\",\"post_2018_2018-8-8-vue-rules.md\":\"5c7b7172\",\"post_2018_2018-9-7-js.md\":\"9529455e\",\"post_2021_2021-1-3-puppeteer.md\":\"f0a96ae9\",\"post_2021_2021-2-23-proxy.md\":\"7784f428\",\"post_2021_2021-3-18-appleid.md\":\"e1cbcd9d\",\"post_2021_2021-6-15-mini.md\":\"a5960e5f\",\"post_2021_2021-7-23-pixijs.md\":\"57f2a55c\",\"post_2021_2021-8-15-resize-observer.md\":\"839df4de\",\"post_2021_2021-8-16-min-share.md\":\"27384dd8\",\"post_2020_2020-12-31-css.md\":\"aa6ee239\",\"post_2020_2020-3-16-chrome-plugin.md\":\"8aba482b\",\"post_2020_2020-3-16-vscode-plugin.md\":\"9cf3725a\",\"post_2020_2020-3-16-windows-plugin.md\":\"9ecffadb\",\"post_2020_2020-3-18-electron-mirror-down.md\":\"c0ab65b2\",\"post_2020_2020-3-18-electron-updater.md\":\"0425b8d2\",\"post_2020_2020-3-19-timer.js.md\":\"43ec431c\",\"post_2020_2020-3-20-antd-vue-pro.md\":\"78a60249\",\"post_2020_2020-3-20-js-how-to-work.md\":\"792e894c\",\"post_2020_2020-3-29-vuepress-plugin.md\":\"ff4d9769\",\"post_2020_2020-3-31-shituzhengmei.md\":\"41595376\",\"post_2020_2020-4-1-plupload.md\":\"b59258a7\",\"post_2020_2020-4-2-cmder.md\":\"7f1c6ace\",\"post_2020_2020-4-29-vue-hook-lifecycle.md\":\"1a278990\",\"post_2020_2020-4-4-yiqin.md\":\"4b5f1707\",\"post_2020_2020-4-6-plop.md\":\"7d2b2a6d\",\"post_2020_2020-5-22-ali-oss.md\":\"45d7320d\",\"post_2020_2020-5-29-axios.md\":\"8f0dc5da\",\"post_2020_2020-6-12-icon.md\":\"eaaeed39\",\"post_2020_2020-6-20-limit-chars.md\":\"b008e902\",\"post_2020_2020-6-23-charslimit.md\":\"527c6623\",\"post_2020_2020-6-25-custom-event.md\":\"6f6eeca0\",\"post_2020_2020-6-25-photo.md\":\"167ee8d7\",\"post_2020_2020-6-29-component.md\":\"979e3dd6\",\"post_2020_2020-6-5-01-vue-cli.md\":\"2f64961a\",\"post_2020_2020-6-5-02-vue-dir.md\":\"a82079b5\",\"post_2020_2020-6-5-03-vue-config.md\":\"f70aaf68\",\"post_2020_2020-6-5-04-vue.webpack.md\":\"468ae0e0\",\"post_2020_2020-6-5-05-env-mode.md\":\"cf00d8ee\",\"post_2020_2020-6-5-06-local-preview.md\":\"e2202055\",\"post_2020_2020-6-9-01-plugin.md\":\"4a125f90\",\"post_2020_2020-7-1-vue-api.md\":\"8c9bb4d1\",\"post_2020_2020-7-1-vuex-api.md\":\"3c6e4377\",\"post_2020_2020-7-13-madel.md\":\"077128f5\",\"post_2020_2020-7-14-share.md\":\"f8e4d9bc\",\"post_2020_2020-7-21-taro.md\":\"f3ed0a4e\",\"post_2020_2020-7-23-temp.md\":\"b1792a83\",\"post_2020_2020-7-9-thks-js.md\":\"703525c5\",\"post_2020_2020-8-17.md\":\"7af940ff\",\"post_2020_2020-8-27-frontend-css1.md\":\"87d5a4d4\",\"post_2020_2020-8-28-frontend-css2.md\":\"b01f25d1\",\"post_2020_2020-8-29-frontend-js1.md\":\"f990d677\",\"post_2020_2020-8-29-frontend-js2.md\":\"ec597485\",\"post_2020_2020-8-29-frontend-js3.md\":\"e8867844\",\"post_2020_2020-8-30-frontend-brower1.md\":\"fc765762\",\"post_2020_2020-8-30-frontend-brower2.md\":\"d41b6b87\",\"post_2020_2020-8-31-frontend-brower3.md\":\"cb7a5db1\",\"post_2020_2020-8-31-frontend-brower4.md\":\"c588c645\",\"post_2020_2020-9-1-fw.md\":\"ebc5dc13\",\"post_2020_2020-9-1-fw2.md\":\"eb0746a5\",\"post_2020_2020-9-15-js-arr.md\":\"82d4600f\",\"post_2020_2020-9-2-proxy.md\":\"3369143a\",\"post_2020_2020-9-24-interview.md\":\"7ac56a20\",\"post_2020_2020-9-3-brower.md\":\"eb1412ba\",\"post_2020_2020-9-5-what-happens.md\":\"495b1d50\",\"post_2020_2020-9-7-recursive.md\":\"ffcf737e\"}")</script>
    <script type="module" async src="/vitepress-blog/assets/app.b304d650.js"></script>
  </body>
</html>